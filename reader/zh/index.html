<!-- Version 02052020
Website: http://koreanreader.com
Copyright Â© 2020-2022 Rohan Scott
This source file is free software, available under the following license:
MIT license - https://mit-license.org/
This software uses the following plugins, please take note of their individual licenses when redistributing:
	jQuery						JS Foundation & other contributors	jquery.org												MIT license
	mark.js						Julian KÃ¼hnel						https://markjs.io/										MIT license
	IndexedDB-getAll-shim.js	dumbmatter							https://www.npmjs.com/package/indexeddb-getall-shim		MIT license
	aromanize.js				Fajar Chandra						https://github.com/fujaru/aromanize-js					MIT license
	chart.js					Chart.js Contributors				https://www.chartjs.org									MIT license
	datatables					SpryMedia Ltd						http://www.datatables.net								MIT license				
	javascript-css-font-detect	Lalit Patel							http://www.lalit.org/lab/javascript-css-font-detect/	Apache Software License 2.0
	FileSaver.js				Eli Grey							http://eligrey.com										MIT license
	colpick.js					Momo Kornher						https://github.com/mrgrain/colpick						Dual licensed under the MIT and GPLv2 licenses
	jieba.js					Pulipuli Chen & others				https://github.com/pulipulichen/jieba-js
																	https://github.com/hustlzp/jquery-s2t
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">
<head>
<meta charset="UTF-8"/>
<meta name="description" content="Learn Chinese through reading. Look up words, track progress, and view statistics."/>
<meta name="keywords" content="Chinese, Mandarin, Cantonese, Language, Reader, Texts, Read, Reading, Study, Studying, Learn, Learning"/>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

	<meta charset="UTF-8"/>
	<meta name="description" content="home"/>
	<meta name="author" content="Rohan Scott"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<meta name="theme-color" content="#0066CC"/>
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@lance3881" />
<meta name="twitter:title" content="Chinese Reader" />
<meta name="twitter:description" content="Learn Chinese through reading. Look up words, track progress, and view statistics." />

 <!-- <meta name="google-signin-client_id" content="641910980147-rulgj2ijv8pmhagni4v7v64clq0nndml.apps.googleusercontent.com">
  <meta name="google-signin-cookiepolicy" content="single_host_origin">
  <meta name="google-signin-scope" content="profile email"> -->
	
	<script src="https://accounts.google.com/gsi/client" async defer></script>

	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="DataTables-1.10.20/datatables.min.css">
	<link rel="stylesheet" type="text/css" href="colpick/colpick.css">
	<script src="mark/mark.min.js" charset="UTF-8"></script>
	<script src="jQuery-3.3.1/jquery-3.3.1.min.js"></script>
	<script src="DataTables-1.10.20/js/jquery.dataTables.min.js"></script>
	<script src="IndexedDB-getAll-shim/IndexedDB-getAll-shim.js"></script>
	<script src="Chart/Chart.bundle.min.js"></script>
	<script src="Chart/Chart.min.js"></script>
	<script src="Select-1.3.1/js/dataTables.select.min.js"></script>
	<script type="text/javascript" src="wordlists/hsk1.js"></script>
	<script type="text/javascript" src="wordlists/hsk2.js"></script>
	<script type="text/javascript" src="wordlists/hsk3.js"></script>
	<script type="text/javascript" src="wordlists/hsk4.js"></script>
	<script type="text/javascript" src="wordlists/hsk5.js"></script>
	<script type="text/javascript" src="wordlists/hsk6.js"></script>
	<script type="text/javascript" src="wordlists/hsk7.js"></script>
	<script type="text/javascript" src="wordlists/globalList.js"></script>
	<script type="text/javascript" src="wordlists/globalCharList.js"></script>
	<script type="text/javascript" src="file-saver/FileSaver.min.js"></script>
	<script src="jieba-js-master/require-jieba-js.js"></script>
	<script type="text/javascript" src="colpick/colpick.js"></script>
	<script type="text/javascript" src="jquery-s2t-master/jquery.s2t.js"></script>
	<script type="text/javascript" src="pinyin/js/convert.js"></script>
	<script type="text/javascript" src="pinyin/js/pinyin.js"></script>
	
	
			 <!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>

	<!-- TODO: Add SDKs for Firebase products that you want to use
		 https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>

<meta property="og:image" content="https://lance388.github.io/reader/zh/preview/preview.png" />
<meta name="msapplication-TileColor" content="#cc6600"/>
<meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png"/>
<meta name="theme-color" content="#cc6600"/>

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@lance3881" />
<meta name="twitter:title" content="Chinese Reader" />
<meta name="twitter:description" content="Learn Chinese through reading. Look up words, track progress, and view statistics." />
<meta name="twitter:image" content="/preview/preview.png"/>	

<link rel="apple-touch-icon" sizes="57x57" href="icons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="icons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="icons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="icons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="icons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="icons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="icons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="icons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
<link rel="manifest" href="icons/manifest.json">
<meta name="msapplication-TileColor" content="#cc6600">
<meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png">
<meta name="theme-color" content="#cc6600">
	
	
	<script type="text/javascript">
		var all_marked;
		var db;
		var enableHighlighting;
		var replaceCharacters;
		var lookingUp;
		var knownArray = [];
		var unknownArray= [];
		var learningArray= [];
		var allArray= [];
		var jumpMarked;
		var jumpAttempts;
		var compareLoopTimeout=[];
		var colourTimeout;
		var scrollTimeout;
		var vocabularyTimeout;
		var saveFireDBTimeout;
		var displaySortTimeout;
		var displayComparisonTimeout;
		var statisticsTimeout;
		var highlightTimeout;
		var unmarkJumpTimeout;
		var calculateStatisticsTimeout;
		var achievementsTimeout;
		var sentencesTimeout;
		var openedTab="";
		var limiters;
		var limitersHangeul; 
		const fontSizeDefault = 3;
		var fontSize;
		var romanisationMode;
		var regExp;
		var replaceCharactersHangeul;
		var convertedHTML;
		var colourPrimary;
		var colourSecondary;
		var colourTertiary;
		var colourJump;
		var colourBackground;
		var colourFont;
		var colourBorder;
		const colourPrimaryDefault= "#F5A9E1";
		const colourSecondaryDefault= "#FFFF66";
		const colourTertiaryDefault= "#99FF00";
		const colourJumpDefault = "#00ffff";
		const colourBackgroundDefault = "#fffeee";
		const colourFontDefault = "#000";
		const colourBorderDefault = "#cc6600";
		var enableVoice;
		var voicePitch;
		var voiceVolume;
		var voiceSpeed;
		//var selectedVocabulary;
		var selectedIndex=-1;
		var selectedWord="";
		var myChart;
		var myChart2;
		var myChart3;
		var chart_hsk_vs_text;
		var chart_global_words_vs_text;
		var predictions_table;
		var global_total_words;
		var timeCalculateStatisticsBegin;
		var timeCalculateStatisticsEnd;
		var initialisationComplete = false;
		var unknownWordsTabUpToDate = false;
		var learningWordsTabUpToDate = false;
		var knownWordsTabUpToDate = false;
		var allWordsTabUpToDate = false;
		var lastUsedStatsTab;
		var browser ="unknown";
		var pendingLookup;
		var imagesLookingUp;
		var dictionaryLookingUp;
		const printJSON = false;
		var dictionaryLanguage;
		const dictionaryLanguageDefault="Youdao English";
		var sidebarVisible;
		var menuVisible;
		var compareLoop;
		var startingMarkDefault;
		var startingMark;
		var mobileMode;
		var vocabularyFilter;
		var chosenExportWordlist;
		var toExport ="";
		var importWordlistFilter;
		var chineseCharacterConversion = 0; //0=no conversion 1=simplified to traditional 2=traditional to simplified
		var fileSelector;
		const uidefault = "English";
		var chartFilter = "chart1";
		var dbfire;
		var grammarPoints =[];
		var unknownFireDBDocumentLoaded = false;
		var knownFireDBDocumentLoaded = false;
		var learningFireDBDocumentLoaded = false;
		var unknownFireDBDocumentSaved = false;
		var knownFireDBDocumentSaved = false;
		var learningFireDBDocumentSaved = false;
		var hideKnownSentences = true;
		var lastSentenceJumpIndex = 0;
		var lastSentenceJumpWord = "";
	//	var disableJump = false;
		var lastSentenceScrollPos = 0;
		var enableWriting = false;
	
		SetGrammarPoints();
		
		const sort_by = (field, reverse, primer) => {

		  const key = primer ?
			function(x) {
			  return primer(x[field])
			} :
			function(x) {
			  return x[field]
			};

		  reverse = !reverse ? 1 : -1;

		  return function(a, b) {
			return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
		  }
		}
		
		
		
		function BrowserCheck() //allow all browsers for testing purposes 
		{
			browser = IsFirefoxOrChrome();
			if(browser=="unknown")
			{
				if (document.documentMode || /Edge/.test(navigator.userAgent)) {
				   browser="edge";
				}
			}
			console.log("Detected browser: "+browser);
			init(); 
		}
		
		function IsFirefoxOrChrome()
		{
			var isFirefox = typeof InstallTrigger !== 'undefined';
			var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
			if(isFirefox)
			{
				return "firefox";
			}
			else if(isChrome)
			{
				return "chrome";
			}
			else
			{
				return "unknown";
			}
		}
		
		function init()
		{
			var pasteArea = document.getElementById ("pasteArea");
			pasteArea.contentEditable = false;
			jumpMarked = false;
			romanisationMode = 0;
			voicePitch = 1;
			voiceVolume = 1;
			enableVoice=false;
			voiceSpeed = 1;
			fontSize = fontSizeDefault;
			lookingUp="";
			convertedHTML="";
			all_marked = false;
			colourPrimary = colourPrimaryDefault;
			colourSecondary = colourSecondaryDefault;
			colourTertiary = colourTertiaryDefault;
			colourJump = colourJumpDefault;
			colourFont = colourFontDefault;
			colourBackground = colourBackgroundDefault;
			colourBorder = colourBorderDefault;
			//selectedVocabulary=[];
			global_total_words = 0;
			calculateStatisticsTimeout = 50;
			lastUsedStatsTab = "UnknownWordsTab";
			pendingLookup = "";
			imagesLookingUp="";
			dictionaryLookingUp="";
			dictionaryLanguage = "Youdao English";
			sidebarVisible = true;
			menuVisible=false;
			compareLoop=false;
			startingMarkDefault=0;
			startingMark = startingMarkDefault;
			mobileMode = false;
			importWordlistFilter="Known";
			vocabularyFilter="Known";
			chosenExportWordlist="Vocabulary - Learning";
		//	disableJump = false;
			
			fileSelector = document.getElementById('importWordlistButton');
						  fileSelector.addEventListener('change', (event) => {
							const file = event.target.files[0];
							ReadFile(file);
						  });
			
			
			
			//console.log(document.getElementById("fieldHC1").style.backgroundColor);
			$('#colorpicker1').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--primary-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var primaryField = document.getElementById("fieldHC1");
						primaryField.value = '#'+hex;
						primaryField.style.backgroundColor='#'+hex;
				}
			});
			
			//$('#colorpicker2').value=getComputedStyle(document.documentElement).getPropertyValue('--secondary-bg');
			$('#colorpicker2').colpick({
			color:value=getComputedStyle(document.documentElement).getPropertyValue('--secondary-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var secondaryField = document.getElementById("fieldHC2");
						secondaryField.value = '#'+hex;
						secondaryField.style.backgroundColor='#'+hex;
				}
			});
			
			//$('#colorpicker3').value=getComputedStyle(document.documentElement).getPropertyValue('--tertiary-bg');
			$('#colorpicker3').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--tertiary-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var tertiaryField = document.getElementById("fieldHC3");
						tertiaryField.value = '#'+hex;
						tertiaryField.style.backgroundColor='#'+hex;
				}
			});
			
			//$('#colorpicker4').value=getComputedStyle(document.documentElement).getPropertyValue('--jump-bg');
			$('#colorpicker4').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--jump-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var jumpField = document.getElementById("fieldHC4");
						jumpField.value = '#'+hex;
						jumpField.style.backgroundColor='#'+hex;
				}
			});
			$('#colorpicker5').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--page-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var bgField = document.getElementById("fieldHC5");
						bgField.value = '#'+hex;
						bgField.style.backgroundColor='#'+hex;
				}
			});
			
			$('#colorpicker6').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--font-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var fontColourField = document.getElementById("fieldHC6");
						fontColourField.value = '#'+hex;
						fontColourField.style.backgroundColor='#'+hex;
				}
			});
			
			$('#colorpicker7').colpick({
			color:getComputedStyle(document.documentElement).getPropertyValue('--document-bg').replace("#",""),
            onSubmit:function(hsb,hex,rgb,el,bySetColor)
				{
					$(el).val('#'+hex);
					$(el).colpickHide();
					var borderColourField = document.getElementById("fieldHC7");
						borderColourField.value = '#'+hex;
						borderColourField.style.backgroundColor='#'+hex;
				}
			});
			
			enableHighlighting = true; 
			replaceCharactersHangeul = /[\0-\â”‚\:\\â€¦\ï¼½\<\âœ‹\ğŸ’\â™«\ï¹‘\â™£\ğŸ¥°\ğŸ‚\ğŸ¤©\âœ”\ğŸ¦„\ğŸ°\ğŸŒŸ\ğŸ”¥\ğŸ‘©â€\ğŸ¨\ğŸ§«\ğŸ˜´\ğŸ¥§\ğŸ½ï¸\ğŸ¥¶\ğŸ”†\ğŸ¤¨\ğŸ˜”\ğŸ°\â†˜\Â\â¤\ğŸ””\ï½ˆ\ï¿½\ğŸ‘»\ã®\ï¿¡\Êƒ\Æª\Â´\â–½\ï¿¥\ï¼º\â†—\ğŸï¸\ï¼ \ï¼™\ï¼–\ğŸ’\ğŸ¤«\â­\ğŸ«\ğŸ¡\ğŸ’‹\ğŸ§¼\ğŸ¥³\â–£\ï¼‡\âœ¦\â›°\á„›\âœŠ\â–½\ã…±\ã…¸\á„¼\á„¾\ã…¿\ã†\ã…‡\á…\á…\á…”\á…•\ğŸ˜\âœŒ\ğŸ’–\ğŸ‘‹\ğŸ’\ğŸ‘‡ï¸\ğŸ’¨\ğŸ–Œï¸\ğŸ”\ğŸ§Š\ğŸ¨\ğŸ’¦\ğŸ’¡\ğŸŒˆ\ğŸ¤\ğŸ¥£\ğŸ™…\ğŸ¥„\ğŸ§\ğŸ˜ƒ\ğŸ§‰\ğŸ‘©â€ğŸ³\â±ï¸\ğŸ¥ƒ\ã†„\ã††\ã…¥\á„™\ã…¹\á„½\á„¿\á…‡\á‡®\á…\á…‘\ã†…\ã„±\ã„²\ã„³\ã„´\ã„µ\ã„¶\ã„·\ã„¸\ã„¹\ã„º\ã„»\ã„¼\ã„½\ã„¾\ã„¿\ã…€\ã…\ã…‚\ã…ƒ\ã…„\ã……\ã…†\ã…‡\ã…ˆ\ã…‰\ã…Š\ã…‹\ã…Œ\ã…\ã††\ã…\ã…¿\ã†\ã…¡\ã…£\ã…—\ã…\ã…œ\ã…“\ã…›\ã…‘\ã… \ã…•\ã…˜\ã…\ã…™\ã…\ã…\ã…”\ã…™\ã…š\ã…\ã…Ÿ\ã…¢\ã…’\ã…–\ğŸ‡\ğŸ–\ï¸ğŸ“š\â‘ \ï¼\ï¼¯\ï¼³\ï¼±\ï¼¸\ã€œ\ï½¤\>\ï¼¾\,\ï½„\ï½\ã€\ï¼¬\ï¼¿\ï¼œ\â¬†\ã€\â€¢\ï¼„\ï½¢\ï½—\ğŸ˜‹\ï½œ\ï¼´\ï¸°\â–“\ğŸ™Œ\â¤\ğŸ˜™\ğŸ™‡\ï¸±\ï¼ƒ\ï¼‹\ï½˜\ï½‹\â€¥\ğŸ˜„\ğŸ’—\ğŸ¤—\â²\ï¼£\ï¼­\ï½š\ï½•\ï¼†\ï½\ï½”\`\ï½£\ğŸ„\â€»\ï½ƒ\ï½\â°\ğŸ’•\ï½\ğŸ˜†\ï¼·\ã€–\ã€—\ğŸ‘€\ğŸ˜Š\ğŸ˜‰\ğŸ˜±\ğŸ\ğŸ‘‰\'\ï¼µ\ï½\ï½…\â”ƒ\+\~\s+\d\/\â€\]\ï¼\_\ğŸ˜\â—†\ã€\â€“\ğŸ‘\â\â\ï¼Š\â¯\ï¼\ğŸ˜˜\|\â§\â—„\â–º\â€º\ãœ\ã\â–²\ï¼¡\â™¬\|\â–¡\â˜…\â™©\ï¼“\ï½Œ\ã…¡\ï¼’\Â©\ï¼‘\ï¼Ÿ\ï¼¢\ï¼•\ï¼”\ï¼‚\ï¼¤\ï½–\ï¼»\â€”\â–\ãƒ»\r\n|\n|\r\ã€‘\â– \ğŸ˜œ\ï¼š\\\ï¼\ï¼\ğŸ‰\ğŸ¶\ã¢\^\-\â­\â†µ\â€’\ï¼…\â†’\!\"\ï½€\â£ï¸\â—‡\ï¹\ï¼›\ï¼ˆ\â˜†\âœ¨\;\ã€‚\ï¼Œ\ï¼‰\ã€\ã€\ã€\ä¸¶\â€•\â“\ğŸ™\â™¡\â˜\â”€\Â®\ï¼˜\â™ª\ã€ˆ\â–³\â¤\â™¥\â–¶\â–¼\â—€\&\ã€‰\(\)\ã€Œ\ã€”\{\}\ã‰¡\*\â¦\â–ª\ã‰¢\1\2\3\4\5\6\7\8\9\0\ã‰£\=\ã\Â·\ã€\%\ã€‹\[\ã€•\~\âˆ¼\ã€Š\ï½\â€œ\â·\â¶\â¸\â¹\â—\ï¿½\ã\â—‹\ã‰ \#\$\?\ï¼\.\â€˜\â€™\ï¼\ğŸ’›\x1F\x7F-\x9F\xAD\u0378\ufeff\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g;
			
			limitersHangeul = ["ï¿¥","ï¼º","ï¼ ","ï¼™","ï¼–","A","á„›","ğŸ¥°","ğŸ‚","ğŸ¤©","ğŸ¦„","âœ”","ğŸ°","ğŸŒŸ","ğŸ”¥","ğŸ‘©â€ğŸ¨","ğŸ§«","ğŸ˜´","ğŸ¥§","ğŸ½ï¸","ğŸ¥¶","ğŸ”†","ğŸ¤¨","ğŸ˜”","ã…±","ã…¸","ã®","á„¼","á„¾","ğŸ””","â†˜","ã…¿","â™£","â–£","ğŸ’","ğŸ¤«","â­","ï¸ğŸ«","â†—","ğŸï¸","ğŸ¡","ğŸ’‹","ğŸ§¼","ğŸ¥³","â–½","â–½","ğŸ‘»","â›°","Êƒ","Æª","Â´","Â","ğŸ˜","âœŒ","ğŸ’–","ğŸ‘‹","ğŸ’","ğŸ‘‡ï¸","ğŸ’¨","ğŸ–Œï¸","ğŸ”","ğŸ§Š","ğŸ¨","ğŸ’¦","ğŸ’¡","ğŸŒˆ","ğŸ¤","ğŸ¥£","ğŸ™…","ğŸ¥„","ğŸ§","ğŸ˜ƒ","ğŸ§‰","ğŸ‘©â€ğŸ³","â±ï¸","ğŸ¥ƒ","ï½ˆ","â¤","ï¿½","ğŸ’","âœ‹","ğŸ°","ã†","âœŠ","ã…‡","âœ¦","á…","á…","á…”","á…•","ã†„","ã††","ã…¥","á„™","ã…¹","á„½","á„¿","á…‡","á‡®","á…","á…‘","ã†…","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¸","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…ƒ","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã††","ã…","ã…¿","ã†","ã…¡","ã…£","ã…—","ã…","ã…œ","ã…“","ã…›","ã…‘","ã… ","ã…•","ã…˜","ã…","ã…™","ã…","ã…","ã…”","ã…™","ã…š","ã…","ã…Ÿ","ã…¢","ã…’","ã…–","ğŸ‡","ğŸ–","ï¸ğŸ“š","B","ï¹‘","ï½¤","ã€œ","ğŸ¤—","â¬†","ã€","ã€","â‘ ","ï½„","â°","ï¸±","ï¼„","ï¸°","ğŸ˜‹","ï¼¬","ğŸ˜„","ğŸ™‡","â€¢","â–“","ğŸ™Œ","â¤","â€¥","ğŸ˜™","ï¼ƒ","ï½‹","ï¼´","ï¼‹","ğŸ˜†","ğŸ¶","ğŸ‰","ï½˜","ï¼£","â†µ","ï¼­","ï½š","ï½•","ï½œ","ï¼œ","ï½¢","ï½£","ï¼","ï¼®","`","C","ï¼¸","D","â²","ğŸ’•","ğŸ’—","ğŸ˜Š","ğŸ‘€","ï½","ğŸ","ğŸ˜‰","â€»","ğŸ˜œ","ğŸ˜±","ğŸ‘‰","ã€–","ã€—","ï½…","ï¼‡","ğŸ„","ï¿¡","E","F","G","H","ï¼µ","ï½","I","J","K","L","M","N","O","P","Q","ï¼”","ï¼’","R","S","T","U","V","W","X","Y","Z",
			"a","b","c","d","e","f","g","h","i","â™«","j","k","â","â","ï½—","âˆ¼","ãœ","ï½”","ï½ƒ","ï¼¿","ï¼¾","ã","ï¼·","ï½","Â®","â—†","|","l","m","n","ï¼‘","o","p","q","r","s","t","u","v","w","x","y","z",
			"ã‰¢","ã‰£","â–³","â—‹","%","â·","â¸","ï¼½","â–²","ï¼","ï¼†","â¶","â™¡","â”ƒ","ï¼³","ï¼¯","ï¼±","â¹","â¦","â§","ï½","|","â€•","â—„","â–º","ğŸ˜","â¯","ğŸ˜˜","ã€","â™¬","â€º","â–¡","ï½Œ","ï¼•","ğŸ™","â—","ï¼¤","ï½–","ï¼“","ï¼¢","ã‰ ","â­","â¤","ï½€","ã€","ã€‚","ï¼ˆ","ï¼‰","ä¸¶","ã€","ã€‘",";","ï½","ã€","â–ª","ã‰¡","~","â€‹","ã€‰","ï½","ã€Œ","ã€ˆ","$","/","ã€”","â”‚","â€¦","ã€","â€œ","ãƒ»",":","â€","#","ï¼¡","ï¼","ï¼‚","-","ğŸ’›",",","â€“","-","ã","ï¼",'"',".","â€’","!","ğŸ‘","?","ï¼›","ï¼","ï¼…","ï¿½","!","â†’","+","\"","\'","â– ","ï¼Œ","ï¼š","â”€","â—‡",")","â“","â–¶","â–¼","â™©","â™¥","â—€","â™ª","ã€‹","ã…¡","&","_","â˜†","ï¼˜","ï¼","ï¼»","ã€Š","{","}","Â·","[","ï¼Ÿ","=","]","Â©","*","(","~","^","^","\\","â€”","ã","ï¼","ï¹","1","2","3","4","5","6","7","8","9","0","â€˜","â€™","<",">","â–","ã¢","ï¼Š","â˜…"];
			
			
			limiters = limitersHangeul;
			replaceCharacters = replaceCharactersHangeul;
			regExp = /^\S*$/;
			document.getElementById("DictionaryTabButton").click();
			window.addEventListener('resize', OnResize);

			$(document).ready(function() {
			
				if (firebase.auth().currentUser)
				{
					ShowSigninElements(false);
				}
				else
				{
					ShowSigninElements(true);
				}
			
				var chartDropDown = document.getElementById("chartOption");
				chartDropDown.selectedIndex=0;
			
				var table = $('#unknownWordsDataTable').DataTable( {
					"paging":         true,
					"scrollCollapse": false,
					"deferRender": true,
					"iDisplayLength": 25,
					"info": false,
					"order": [[ 0, "desc" ]],
					select: 'single',
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Frequency" },
						{ title: "HSK" },
						{ title: "Global" },
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 3},
						{type: 'non-empty-string', targets: 4}
					]
				} );

							var table2 = $('#learningWordsDataTable').DataTable( {
					"paging":         true,
					"scrollCollapse": false,
					"deferRender": true,
					"info": false,
					"iDisplayLength": 25,
					"order": [[ 0, "desc" ]],
					select: 'single',
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Frequency" },
						{ title: "HSK" },
						{ title: "Global" },
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 3},
						{type: 'non-empty-string', targets: 4}
					]
				} );
				
							var table3 = $('#knownWordsDataTable').DataTable( {
					"paging":         true,
					"scrollCollapse": false,
					"deferRender": true,
					"info": false,
					"iDisplayLength": 25,
					"order": [[ 0, "desc" ]],
					select: 'single',
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Frequency" },
						{ title: "HSK" },
						{ title: "Global" },
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 3},
						{type: 'non-empty-string', targets: 4}
					]
				} );
				
							var table4 = $('#allWordsDataTable').DataTable( {
					"paging":         true,
					"scrollCollapse": false,
					"deferRender": true,
					"info": false,
					"iDisplayLength": 25,
					"order": [[ 0, "desc" ]],
					select: 'single',
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Frequency" },
						{ title: "HSK" },
						{ title: "Global" },
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 3},
						{type: 'non-empty-string', targets: 4}
					]
				} );
				
							var table5 = $('#vocabularyDataTable').DataTable( {
				    "scrollY":        300,
					"scrollCollapse": false,
					"paging":         false,
					"deferRender": true,
					"info": false,
					"order": [[ 0, "desc" ]],
					select: true,
					columns: [
						{ title: "Word" },
						{ title: "State" }
					]
				} );
				
							var table6 = $('#compareDataTable').DataTable( {
					"scrollCollapse": false,
					"paging":         false,
					"deferRender": true,
					"searching": false,
					"info": false,
					"order": [[ 3, "desc" ]],
					select: false,
					columns: [
						{ title: "Word List" },
						{ title: "Unknown %" },
						{ title: "Learning %" },
						{ title: "Known %" },
						{ title: "Unknown Unique Words" },
						{ title: "Total Unique Words" }
					]
				} );
				
				var table7 = $('#unknownWordsDataTableSummary').DataTable( {
					"scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Unknown Words" },
						{ title: "Total Words" },
						{ title: "Unique Unknown Words" },
						{ title: "Total Unique Words" }
					]
				} );
				
							var table8 = $('#learningWordsDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Learning Words" },
						{ title: "Total Words" },
						{ title: "Unique Learning Words" },
						{ title: "Total Unique Words" }
					]
				} );
				
							var table9 = $('#knownWordsDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Known Words" },
						{ title: "Total Words" },
						{ title: "Unique Known Words" },
						{ title: "Total Unique Words" }
					]
				} );
				
							var table10 = $('#allWordsDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total Words" },
						{ title: "Total Unique Words" }
					]
				} );
				
					var table11 = $('#vocabularyDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 0, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total"},
						{ title: "Unknown" },
						{ title: "Learning" },
						{ title: "Known" }
					]
				} );
				
						var table12 = $('#achievementsDataTable').DataTable( {
				    "scrollY":        300,
					"scrollCollapse": false,
					"paging":         false,
					"searching": false,
					"deferRender": true,
					"info": false,
					"order": [[ 0, "desc" ]],
					select: true,
					"language": {
					  "emptyTable": "No achievements recorded yet, check again later."
					},
					columns: [
						{ title: "Known Vocabulary" },
						{ title: "Date Achieved" }
					]
				} );
				
				var table13 = $('#charactersVocabularyDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 0, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total"},
						{ title: "Unknown" },
						{ title: "Learning" },
						{ title: "Known" }
					]
				} );
				
				var table14 = $('#sentencesDataTable').DataTable( {
					"scrollCollapse": false,
					"paging":         false,
					"searching": true,
					"deferRender": true,
					"info": false,
					"order": [[ 4, "asc" ]],
					select: true,
					"language": {
					  "emptyTable": "Loading..."
					},
					columns: [
						{ title: "#" },
						{ title: "Sentence" },
						{ title: "n"},
						{ title: "?"},
						{ title: "%"}
					]
				} );
				
				var table15 = $('#charactersVocabularyDataTableSummary2').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 0, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total"},
						{ title: "Unknown" },
						{ title: "Learning" },
						{ title: "Known" }
					]
				} );
				
				var table16 = $('#charactersCurrentTextDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 0, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total"},
						{ title: "Unknown" },
						{ title: "Learning" },
						{ title: "Known" }
					]
				} );
				
				var table17 = $('#charactersVocabularyDataTable').DataTable( {
					"paging":         true,
					"iDisplayLength": 10,
					"scrollCollapse": false,
					"searching": true,
					"deferRender": true,
					"targets": 'no-sort',
					select: true,
					"order": [[ 5, "desc" ], [ 4, "asc" ]],
					"info": false,
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Pinyin" },
						{ title: "Frequency" },
						{ title: "Global"},
						{ title: "State"}
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 4}
					]
				} );
				
				var table18 = $('#charactersCurrentTextDataTable').DataTable( {
					"scrollCollapse": false,
					"paging":         true,
					"iDisplayLength": 10,
					"searching": true,
					"deferRender": true,
					"targets": 'no-sort',
					select: true,
					"order": [[ 5, "desc" ], [ 4, "asc" ]],
					"info": false,
					columns: [
						{ title: "Count" },
						{ title: "Word" },
						{ title: "Pinyin" },
						{ title: "Frequency"},
						{ title: "Global"},
						{ title: "State"}
					],
					columnDefs: [
						{type: 'non-empty-string', targets: 4}
					]
				} );
				
				var table19 = $('#grammarDataTable1').DataTable( {
				    "scrollY":        280,
					"scrollCollapse": false,
					"paging":         false,
					"searching": false,
					"deferRender": true,
					"info": false,
					select: true,
					"language": {
					  "emptyTable": "Grammar patterns not detected."
					},
					columns: [
						{ title: "#" },
						{ title: "Pattern" },
						{ title: "Description"}
					]
				} );
				
				var table20 = $('#grammarDataTable2').DataTable( {
				    "scrollY":        280,
					"scrollCollapse": false,
					"paging":         false,
					"searching": true,
					"deferRender": true,
					"info": false,
					select: true,
					"language": {
					  "emptyTable": "Loading..."
					},
					columns: [
						{ title: "#" },
						{ title: "Pattern" },
						{ title: "Description"}
					]
				} );
				
				var table21 = $('#charactersAllCurrentTextDataTableSummary').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 0, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Total"},
						{ title: "Unknown" },
						{ title: "Learning" },
						{ title: "Known" }
					]
				} );
				
				var table22 = $('#predictions_table').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 1, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Word Coverage" },
						{ title: "1 Unknown or Learning Word Per X Words in Current Text" },
						{ title: "Known Unique Words in Current Text" },
						{ title: "Est. Char. Total" },
						{ title: "Est. Additonal Words Required" }
					]
				} );
				
				var table23 = $('#global_table').DataTable( {
				    "scrollCollapse": false,
					"paging":         false,
					"targets": 'no-sort',
					"bSort": false,
					"order": [[ 1, "desc" ]],
					"searching": false,
					"info": false,
					columns: [
						{ title: "Frequency Wordlist" },
						{ title: "Unique Words" },
						{ title: "Words" }
					]
				} );
				
				var events = $('#events');
				
				table
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table.rows( indexes ).data().toArray();
					table.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpTo(rowData[0][1], true);
				} );

				
							table2
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table2.rows( indexes ).data().toArray();
					table2.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpTo(rowData[0][1], true);
				} );

				
							table3
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table3.rows( indexes ).data().toArray();
					table3.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];					
					JumpTo(rowData[0][1], true);
				} );

         				
							table4
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table4.rows( indexes ).data().toArray();
					table4.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpTo(rowData[0][1], true);
				} );
				
							table14
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table14.rows( indexes ).data().toArray();
					table14.rows( { selected: true } );
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpToSentence(rowData[0][1]);
					//SaveLastSentenceJump(indexes[0],rowData[0][1]);
				} );
				
				table17
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table17.rows( indexes ).data().toArray();
					table17.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpTo(rowData[0][1], false);
				} );
				
				table18
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table18.rows( indexes ).data().toArray();
					table18.rows( { selected: true } ).deselect();
					selectedWord = rowData[0][1];
					selectedIndex = indexes[0];
					JumpTo(rowData[0][1], false);
				} );

				
				/*						table5
				.on( 'select', function ( e, dt, type, indexes ) {
					var rowData = table5.rows( indexes ).data().toArray();
					for(var i=0;i<rowData.length;i++)
					{
						selectedVocabulary[i] = rowData[i][0];
					}
				} );
				
				table5
				.on( 'deselect', function ( e, dt, type, indexes ) {
					selectedVocabulary = [];
				} );
				*/
				
				jQuery.extend( jQuery.fn.dataTableExt.oSort, {
				"non-empty-string-asc": function (str1, str2) {
					if(str1 == "")
						return 1;
					if(str2 == "")
						return -1;
					return ((str1 < str2) ? -1 : ((str1 > str2) ? 1 : 0));
				},
			 
				"non-empty-string-desc": function (str1, str2) {
					if(str1 == "")
						return 1;
					if(str2 == "")
						return -1;
					return ((str1 < str2) ? 1 : ((str1 > str2) ? -1 : 0));
				}
			} );
				


				initdb();
			}
	
			);
			

			var contentArea = document.getElementById ("content");
			
					if (contentArea.addEventListener) {
					contentArea.addEventListener ("mouseup", function (event) {
						if(menuVisible)
						{
							ShowMenu(false);
						}
					
						if (event.altKey||event.ctrlKey||event.metaKey)
						{
							mouseUp(0);
						}
						else
						{
							switch (event.which) {
							case 1:
								mouseUp(1);
								break;
							case 2:
								//mouseUp(1);
								break;
							case 3:
								//mouseUp(2);
								break;
							default:
								mouseUp(1);
						}

						}
	
					}, false);
				}


					var sidebar2 = document.getElementById ("sidebar2");
					if (sidebar2.addEventListener) {
					sidebar2.addEventListener ("mouseup", function (event)
					{
						if(menuVisible)
						{
							ShowMenu(false);
						}
	
					}, false);
				}	

				
		}
		
		function NavigateFirstVisit()
		{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get("firstvisit$");
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					document.getElementById("DictionaryTabButton").click();
					
			}
			else
			{
				addwordtodb("firstvisit$",1);
				document.getElementById("AboutTabButton").click();
			}
	
				
			}
		}
		
		function InitialiseHighlighting()
		{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get("enableHighlighting$");
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					var a = request.result.appearances;
					if(a==0)
					{
						enableHighlighting = false;
						document.getElementById("enableHighlighting").checked = false;
					}
					else
					{
						enableHighlighting = true;
						document.getElementById("enableHighlighting").checked = true;
					}
			}
					else
					{
						if(enableHighlighting)
						{
							addwordtodb("enableHighlighting$",1);
							document.getElementById("enableHighlighting").checked = true;
						}
						else
						{
							addwordtodb("enableHighlighting$",0);
							document.getElementById("enableHighlighting").checked = false;
						}
					}
			}
		}
		
		function initdb()
		{
			if (!window.indexedDB) {
				alert("Your browser doesn't support a stable version of IndexedDB");
				console.log("Your browser doesn't support a stable version of IndexedDB");
			}
		else
		{			
			
			var request = indexedDB.open("wordsdb",3);
			
	
			request.onupgradeneeded = function() {
			  db = request.result;
			  var store = db.createObjectStore("wordsdb", {keyPath: "word"});
			  var appearancesIndex = store.createIndex("by_appearance", "appearance");
			  
	
			  
			};
			request.onerror = function(event) 
			{
			  console.log("Database error: " + event.target.errorCode);
			};
			request.onsuccess = function() {
			  db = request.result;
			  OnResize();
			  InitialiseColourInputField();
			  InitialiseStartingMark();
			  InitialiseHighlighting();
			  //InitialiseRomanisation();
			  InitialiseCharacterConversion();
			  InitialiseVoice();
			  InitialiseFontType(0);
			  InitialiseDictLanguage();
			  InitialiseHighlightingKnown();
			  InitialiseVocabulary();
			  SetDefaultReaderLanguage();
			  InitialiseFireDB();
			  InitialiseFontSize();
			  InitialiseExportWordlist();
			  InitialiseImport();
			  InitialiseUILanguage();
			  InitialiseHideKnownSentences();
			  var pasteArea = document.getElementById ("pasteArea");
			  pasteArea.innerText = "";
			  setTimeout(function()
			  {
				LoadHTML();
				JumpToSavedPageLocation();
				initialisationComplete = true;
				pasteArea.contentEditable = true;
				NavigateFirstVisit();
			  }, 200);
				
			};
			}
		}
		
		
		$(window).keydown(function(e) {
		
		if ($("input[type='search']").is(":focus")||enableWriting) {
				
				
				return;
			}
			
		  console.log(e.keyCode);
		  switch (e.keyCode) {
		  
						case 49: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("DictionaryTabButton").click(); e.preventDefault();} break; 
			case 50: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("WritingTabButton").click(); e.preventDefault();} break; 
			case 51: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("StatisticsTabButton").click(); e.preventDefault();} break; 
			case 52: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("UnknownWordsTabButton").click(); e.preventDefault();} break;
			case 53: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("LearningWordsTabButton").click(); e.preventDefault();} break;
			case 54: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("KnownWordsTabButton").click(); e.preventDefault();} break;
			case 55: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("AllWordsTabButton").click(); e.preventDefault();} break;
			case 56: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("VocabularyTabButton").click(); e.preventDefault();} break;
			case 57: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("CompareTabButton").click(); e.preventDefault();} break;
			case 48: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("GraphTabButton").click(); e.preventDefault();} break;
			case 97: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("DictionaryTabButton").click(); e.preventDefault();} break; 
			case 98: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("WritingTabButton").click(); e.preventDefault();} break; 
			case 99: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("StatisticsTabButton").click(); e.preventDefault();} break; 
			case 100: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("UnknownWordsTabButton").click(); e.preventDefault();} break;
			case 101: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("LearningWordsTabButton").click(); e.preventDefault();} break;
			case 102: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("KnownWordsTabButton").click(); e.preventDefault();} break;
			case 103: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("AllWordsTabButton").click(); e.preventDefault();} break;
			case 104: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("VocabularyTabButton").click(); e.preventDefault();} break;
			case 105: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("CompareTabButton").click(); e.preventDefault();} break;
			case 96: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("GraphTabButton").click(); e.preventDefault();} break;
			case 173: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("AchievementsTabButton").click(); e.preventDefault();} break;
			case 71: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("GrammarTabButton").click(); e.preventDefault();} break;
			case 61: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("GrammarTabButton").click(); e.preventDefault();} break;
			case 79: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("googleImagesLink").click(); e.preventDefault();} break;
			case 66: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("baiduImagesLink").click(); e.preventDefault();} break;
			case 89: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("yahooImagesLink").click(); e.preventDefault();} break;
			case 84: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("googleTranslateLink").click(); e.preventDefault();} break;
			case 83: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("SentencesTabButton").click(); e.preventDefault();} break;
			case 75: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("CharactersTabButton").click(); e.preventDefault();} break;
			case 87: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("wikipediaLink").click(); e.preventDefault();} break;
			case 69: if(openedTab!="OptionsTab"&&openedTab!="LoginTab"){document.getElementById("etymologyLink").click(); e.preventDefault();} break;
			
			
			case 46: DeleteVocabulary(); break;
			case 8: DeleteVocabulary(); break;
			case 27: Reset(); e.preventDefault(); break;
			  return;
		  }
		});
		
		function InitialiseCharacterConversion()
		{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request = objectStore.get("characterconversion$");
			request.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
					
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
						switch(a)
						{
							case "Convert simplified characters to traditional": chineseCharacterConversion = 1; OnInput(); break;
							case "Convert traditional characters to simplified": chineseCharacterConversion = 2; OnInput(); break;
							default: chineseCharacterConversion = 0;
						}
						//chineseCharacterConversion = a;					
					}
					else
					{
						chineseCharacterConversion = 0;
					}
					var dropDown = document.getElementById("characterConversionOption");
					dropDown.value = GetCharacterConversionOptionValue(chineseCharacterConversion);
				};
		}
		
		function ChangeCharacterConversion()
		{
			var mySelect = document.getElementById('characterConversionOption');
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request = objectStore.get("characterconversion$");
			request.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request.onsuccess = function(event) {          
					if(request.result)
					{
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "characterconversion$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("characterconversion$",mySelect.value);
					}
				}
				
			switch(mySelect.value)
			{
				case "Convert simplified characters to traditional": chineseCharacterConversion = 1; OnInput(); break;
				case "Convert traditional characters to simplified": chineseCharacterConversion = 2; OnInput(); break;
				default: chineseCharacterConversion = 0;
			}
		}
		
		function GetCharacterConversionOptionValue(index)
		{
			switch(index)
			{
				case 1: return("Convert simplified characters to traditional"); break;
				case 2: return("Convert traditional characters to simplified"); break;
				default: return("No conversion");
			}
		}
		
		function InitialiseVocabulary()
		{
			var mySelect = document.getElementById('filterVocabularyOption');
			mySelect.value = vocabularyFilter;
		}
		
		function DeleteVocabulary()
		{
			var selectedVocabulary=[];
			var table5 = $('#vocabularyDataTable').DataTable();
			var data = table5.rows('.selected').data();
			data.each(function (value, index) {
				selectedVocabulary.push(value[0]);
			});
		
			if(enableHighlighting&&!enableWriting && openedTab=="VocabularyTab")
			{
				if(selectedVocabulary.length>0)
				{
					for(var i=0;i<selectedVocabulary.length;i++)
					{
						var transaction = db.transaction(["wordsdb"], "readwrite");
						transaction.onerror = function(event)
						{
							console.log('Transaction not opened due to error: ' + transaction.error);
						};
						var objectStore = transaction.objectStore("wordsdb");
						var objectStoreRequest = objectStore.delete(selectedVocabulary[i]);
					}
	
				}
				OnInput();
			}
		
		}
		
		/**
			 * JavaScript code to detect available availability of a
			 * particular font in a browser using JavaScript and CSS.
			 *
			 * Author : Lalit Patel
			 * Website: http://www.lalit.org/lab/javascript-css-font-detect/
			 * License: Apache Software License 2.0
			 *          http://www.apache.org/licenses/LICENSE-2.0
			 * Version: 0.15 (21 Sep 2009)
			 *          Changed comparision font to default from sans-default-default,
			 *          as in FF3.0 font of child element didn't fallback
			 *          to parent element if the font is missing.
			 * Version: 0.2 (04 Mar 2012)
			 *          Comparing font against all the 3 generic font families ie,
			 *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3
			 *          then that font is 100% not available in the system
			 * Version: 0.3 (24 Mar 2012)
			 *          Replaced sans with serif in the list of baseFonts
			 */

			/**
			 * Usage: d = new Detector();
			 *        d.detect('font name');
			 */
			var Detector = function() {
				// a font will be compared against all the three default fonts.
				// and if it doesn't match all 3 then that font is not available.
				var baseFonts = ['monospace', 'sans-serif', 'serif'];

				//we use m or w because these two characters take up the maximum width.
				// And we use a LLi so that the same matching fonts can get separated
				var testString = "mmmmmmmmmmlli";

				//we test using 72px font size, we may use any size. I guess larger the better.
				var testSize = '72px';

				var h = document.getElementsByTagName("body")[0];

				// create a SPAN in the document to get the width of the text we use to test
				var s = document.createElement("span");
				s.style.fontSize = testSize;
				s.innerHTML = testString;
				var defaultWidth = {};
				var defaultHeight = {};
				for (var index in baseFonts) {
					//get the default width for the three base fonts
					s.style.fontFamily = baseFonts[index];
					h.appendChild(s);
					defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font
					defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font
					h.removeChild(s);
				}

				function detect(font) {
					var detected = false;
					for (var index in baseFonts) {
						s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.
						h.appendChild(s);
						var matched = (s.offsetWidth != defaultWidth[baseFonts[index]] || s.offsetHeight != defaultHeight[baseFonts[index]]);
						h.removeChild(s);
						detected = detected || matched;
					}
					return detected;
				}

				this.detect = detect;
			};

		function sleep(ms) {
		  return new Promise(resolve => setTimeout(resolve, ms));
		}

		function InitialiseFontType(attempts)
		{
			
		
			var fontTypeDropDown = document.getElementById("fontTypeOption");
			
			for (a in fontTypeDropDown.options) { fontTypeDropDown.options.remove(0); }
			
			d = new Detector();
			
			
			var fontList = [
			'Arial, Helvetica, tahoma, verdana, å®‹ä½“, SimSun, åæ–‡ç»†é»‘, STXihei, sans-serif',
			'Tahoma, Arial, Helvetica, Microsoft YaHei New, Microsoft Yahei, å¾®è½¯é›…é»‘, å®‹ä½“, SimSun, STXihei, åæ–‡ç»†é»‘, sans-serif',
			'Georgia, Times New Roman, FangSong, ä»¿å®‹, STFangSong, åæ–‡ä»¿å®‹, serif',
			'Georgia, Times New Roman, KaiTi, æ¥·ä½“, STKaiti, åæ–‡æ¥·ä½“, serif'
			];
			var fontName = [
			'Arial',
			'Microsoft YaHei New',
			'FangSong',
			'KaiTi',
			];
			
			var chosenFont = 'Arial, Helvetica, tahoma, verdana, å®‹ä½“, SimSun, åæ–‡ç»†é»‘, STXihei, sans-serif';
			fontTypeDropDown.value='Arial, Helvetica, tahoma, verdana, å®‹ä½“, SimSun, åæ–‡ç»†é»‘, STXihei, sans-serif';
			
			for(var i=0;i<fontList.length;i++)
			{
				var detection = d.detect(fontList[i]);
				if(detection)
				{
					var opt = document.createElement('option');
					opt.value = fontList[i];
					opt.innerHTML = fontName[i];
					fontTypeDropDown.appendChild(opt);
				}
				else if(attempts<30)
				{
					sleep(500).then(() => { InitialiseFontType(attempts+1); });
					return;
				}
			}
			
			var objectStore3 = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request3 = objectStore3.get("fonttype$");
			request3.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request3.onsuccess = function(event) {
				if(request3.result) {
						var a = request3.result.appearances;
					for(var i=0;i<fontTypeDropDown.options.length;i++)
					{
						if(fontTypeDropDown.options[i].value==a)
						{
							fontTypeDropDown.value=a;
							chosenFont= a;
						}
					}
						document.documentElement.style.setProperty('--font-type', chosenFont);
					}
	
				};
				
				
		}
		
		function InitialiseDictLanguage()
		{
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("dictlanguage$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
					
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
						dictionaryLanguage = a;					
					}
					else
					{
						dictionaryLanguage = dictionaryLanguageDefault;
					}
					var dropDown = document.getElementById("dictLanguageOption");
					dropDown.value = dictionaryLanguage;
					var dropDown2 = document.getElementById("dictLanguageOption2");
					dropDown2.value = dictionaryLanguage;
				};
		}

		
		
		function Reset(deleteWords)
		{
			clearTimeout(colourTimeout);
			clearTimeout(scrollTimeout);
			clearTimeout(vocabularyTimeout);
			clearTimeout(displaySortTimeout);
			clearTimeout(statisticsTimeout);
			clearTimeout(highlightTimeout);
			clearTimeout(unmarkJumpTimeout);
			clearTimeout(calculateStatisticsTimeout);
			if(deleteWords)
			{
			SaveHTML("");
			}
			var container = document.getElementById ("pasteArea");
			container.innerHTML="";
			ClearStatistics();
		}
		
		function CreateGraph(data,data2)
		{
		
			DestroyCharts();
			
			data.sort(sort_by('occurances', true, parseInt));
			data2.sort(sort_by('occurances', true, parseInt));
			var accumulativeWords = [];
			var xAxis=[];
			var total=0;
			for(var i=0;i<data.length;i++)
			{
				
				total+=data[i].occurances;
				xAxis.push(i+1);
				accumulativeWords.push(total);
			}
			var accumulativeWords2 = [];
			var xAxis2=[];
			var total2=0;
			for(var i=0;i<data2.length;i++)
			{
				
				total2+=data2[i].occurances;
				xAxis2.push(i+1);
				accumulativeWords2.push(total2);
			}
			
			var customTooltips = function(tooltip) {
			// Tooltip Element
			var tooltipEl = document.getElementById('chartjs-tooltip');

			if (!tooltipEl) {
				tooltipEl = document.createElement('div');
				tooltipEl.id = 'chartjs-tooltip';
				tooltipEl.innerHTML = '<table></table>';
				this._chart.canvas.parentNode.appendChild(tooltipEl);
			}

			// Hide if no tooltip
			if (tooltip.opacity === 0) {
				tooltipEl.style.opacity = 0;
				return;
			}

			// Set caret Position
			tooltipEl.classList.remove('above', 'below', 'no-transform');
			if (tooltip.yAlign) {
				tooltipEl.classList.add(tooltip.yAlign);
			} else {
				tooltipEl.classList.add('no-transform');
			}

			function getBody(bodyItem) {
				return bodyItem.lines;
			}

			// Set Text
			if (tooltip.body) {
				var titleLines = tooltip.title || [];
				var bodyLines = tooltip.body.map(getBody);

				var innerHtml = '<thead>';
				
				titleLines.forEach(function(title) {
					innerHtml += '<tr><th>' +"Unique Words: "+ title +" ("+(Math.round(((title/data.length)*100 + Number.EPSILON) * 100) / 100)+"%)"+'</th></tr>';
				});
				
				
				
				innerHtml += '</thead><tbody>';

				bodyLines.forEach(function(body, i) {
					var colors = tooltip.labelColors[i];
					var style = 'background:' + colors.backgroundColor;
					style += '; border-color:' + colors.borderColor;
					style += '; border-width: 2px';
					var b = []
					var body = (""+body);
					b = body.trim().split(/[, ]+/);
					var span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>';
					innerHtml += '<tr><td>' +span+ b[2] +" ("+(Math.round(((b[2]/total)*100 + Number.EPSILON) * 100) / 100)+"%)"+ '</td></tr>';
				});
				innerHtml += '</tbody>';

				var tableRoot = tooltipEl.querySelector('table');
				tableRoot.innerHTML = innerHtml;
			}

			var positionY = this._chart.canvas.offsetTop;
			var positionX = this._chart.canvas.offsetLeft;

			// Display, position, and set styles for font
			tooltipEl.style.opacity = 1;
			tooltipEl.style.left = positionX + tooltip.caretX + 'px';
			tooltipEl.style.top = positionY + tooltip.caretY + 'px';
			tooltipEl.style.fontFamily = tooltip._bodyFontFamily;
			tooltipEl.style.fontSize = tooltip.bodyFontSize + 'px';
			tooltipEl.style.fontStyle = tooltip._bodyFontStyle;
			tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
		};
			
			
			var ctx = document.getElementById('myChart').getContext('2d');
			myChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: xAxis,
					datasets: [{
					label: "Current Text",
						data: accumulativeWords,
						backgroundColor: 'rgba(153, 102, 255, .5)',
						borderColor: 'rgba(153, 102, 255, .5)',
						fill: true,
				}, {
					label: "Known Words",
						data: accumulativeWords2,
						backgroundColor: 'rgba(255, 159, 64, .5)',
						borderColor: 'rgba(255, 159, 64, .5)',
						fill: true,
				}]
				},
				options: {
					responsive: true,
				title: {
					display: true,
					text: 'Cumulative Word Total vs Unique Words'
				},
				tooltips: {
						enabled: false,
						mode: 'index',
						position: 'nearest',
						custom: customTooltips
					},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Unique Words'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Cumulative Word Total'
						}
					}]
				}
				}
			});
		}
		
		function CreateGraph2(data,data2)
		{
			DestroyCharts();
			
			data.sort(sort_by('occurances', true, parseInt));
			data2.sort(sort_by('occurances', true, parseInt));
			var accumulativeWords = [];
			var xAxis=[];
			var total=0;
			for(var i=0;i<data.length;i++)
			{
				total+=data[i].occurances;
				xAxis.push(i+1);
				accumulativeWords.push(total);
			}
			var accumulativeWords2 = [];
			var xAxis2=[];
			var total2=0;
			for(var i=0;i<data2.length;i++)
			{
				total2+=data2[i].occurances;
				xAxis2.push(i+1);
				accumulativeWords2.push(total2);
			}
			
			var customTooltips = function(tooltip) {
			// Tooltip Element
			var tooltipEl = document.getElementById('chartjs-tooltip');

			if (!tooltipEl) {
				tooltipEl = document.createElement('div');
				tooltipEl.id = 'chartjs-tooltip';
				tooltipEl.innerHTML = '<table></table>';
				this._chart.canvas.parentNode.appendChild(tooltipEl);
			}

			// Hide if no tooltip
			if (tooltip.opacity === 0) {
				tooltipEl.style.opacity = 0;
				return;
			}

			// Set caret Position
			tooltipEl.classList.remove('above', 'below', 'no-transform');
			if (tooltip.yAlign) {
				tooltipEl.classList.add(tooltip.yAlign);
			} else {
			
				tooltipEl.classList.add('no-transform');
			}

			function getBody(bodyItem) {
				return bodyItem.lines;
			}

			// Set Text
			if (tooltip.body) {
				var titleLines = tooltip.title || [];
				var bodyLines = tooltip.body.map(getBody);

				var innerHtml = '<thead>';
				
				titleLines.forEach(function(title) {
					innerHtml += '<tr><th>' +"Unique Characters: "+ title +" ("+(Math.round(((title/data.length)*100 + Number.EPSILON) * 100) / 100)+"%)"+'</th></tr>';
				});
				
				
				
				innerHtml += '</thead><tbody>';

				bodyLines.forEach(function(body, i) {
					var colors = tooltip.labelColors[i];
					var style = 'background:' + colors.backgroundColor;
					style += '; border-color:' + colors.borderColor;
					style += '; border-width: 2px';
					var b = []
					var body = (""+body);
					b = body.trim().split(/[, ]+/);
					var span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>';
					innerHtml += '<tr><td>' +span+ b[2] +" ("+(Math.round(((b[2]/total)*100 + Number.EPSILON) * 100) / 100)+"%)"+ '</td></tr>';
				});
				innerHtml += '</tbody>';

				var tableRoot = tooltipEl.querySelector('table');
				tableRoot.innerHTML = innerHtml;
			}

			var positionY = this._chart.canvas.offsetTop;
			var positionX = this._chart.canvas.offsetLeft;

			// Display, position, and set styles for font
			tooltipEl.style.opacity = 1;
			tooltipEl.style.left = positionX + tooltip.caretX + 'px';
			tooltipEl.style.top = positionY + tooltip.caretY + 'px';
			tooltipEl.style.fontFamily = tooltip._bodyFontFamily;
			tooltipEl.style.fontSize = tooltip.bodyFontSize + 'px';
			tooltipEl.style.fontStyle = tooltip._bodyFontStyle;
			tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
		};
			
			
			var ctx = document.getElementById('myChart2').getContext('2d');
			myChart2 = new Chart(ctx, {
				type: 'line',
				data: {
					labels: xAxis,
					datasets: [{
					label: "Current Text",
						data: accumulativeWords,
						backgroundColor: 'rgba(51, 204, 51, .5)',
						borderColor: 'rgba(51, 204, 51, .5)',
						fill: true,
				}, {
					label: "Known Characters",
						data: accumulativeWords2,
						backgroundColor: 'rgba(255, 159, 64, .5)',
						borderColor: 'rgba(255, 159, 64, .5)',
						fill: true,
				}]
				},
				options: {
					responsive: true,
				title: {
					display: true,
					text: 'Cumulative Character Total vs Unique Characters'
				},
				tooltips: {
						enabled: false,
						mode: 'index',
						position: 'nearest',
						custom: customTooltips
					},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Unique Characters'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Cumulative Character Total'
						}
					}]
				}
				}
			});
		}
		
		function CreatePredictionsTable(dataAll,dataKnown,dataLearning,dataUnknown)
		{
		
			var t = $('#predictions_table').DataTable();
			var totalIgnored=0;
			var totalUnique=0;
			var totalKnownUnique=0;
			var totalLearningUnique=0;
			var totalUnknownUnique=0;
			var totalOccurances=0;
			var totalKnownOccurances=0;
			var totalLearningOccurances=0;
			var totalUnknownOccurances=0;
			var known_words = [];
			var all_valid_words = [];
			var charsKnown = [];
			
			for(var i=0;i<dataAll.length;i++)
			{
				
				if(dataAll[i].rank=="")
				{
					totalIgnored++;
				}
				else
				{
					all_valid_words.push(dataAll[i]);
					var found = dataKnown.findIndex(w => w.word === dataAll[i].word);
					totalUnique++;
					totalOccurances+=dataAll[i].occurances;
					if(found == -1)
					{
						found = dataLearning.findIndex(w => w.word === dataAll[i].word);
						if(found == -1)
						{
							totalUnknownUnique++;
							totalUnknownOccurances+=dataAll[i].occurances;
						}
						else
						{
							totalLearningUnique++;
							totalLearningOccurances+=dataAll[i].occurances;
						}
					}
					else
					{
						totalKnownUnique++;
						totalKnownOccurances+=dataAll[i].occurances;
					
					}
				}
			}
			
			
		
			document.getElementById("predictions_text").innerText="See below table for estimated number of high frequency words required to reach particular milestones of text coverage based on the current text.\n\n"+totalIgnored +" unique words in the current text are not detected in the the 200,000 word frequency list and will be ignored. Of the remaining "+(totalUnique)+" unique words, "+totalKnownUnique+" are 'known', "+totalLearningUnique+" are 'learning', and "+totalUnknownUnique+" are 'unknown'.\n\n In terms of word coverage, "+(Math.round(((totalKnownOccurances/totalOccurances)*100 + Number.EPSILON) * 100) / 100)+"% of the text is 'known', "+(Math.round(((totalLearningOccurances/totalOccurances)*100 + Number.EPSILON) * 100) / 100)+"% of the text is 'learning', and "+(Math.round(((totalUnknownOccurances/totalOccurances)*100 + Number.EPSILON) * 100) / 100)+"% of the text is 'unknown'.\n\n\n";
			
			var current = Math.round(((totalKnownOccurances/totalOccurances)*100 + Number.EPSILON) * 100) / 100;
			var wordsPer = Math.round((1/(1-(current/100)) + Number.EPSILON) * 100) / 100;
			
			
			
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						var a = req[i].appearances;
						
						if(!w.includes("$"))
						{
							var remainder = a%3;
							if(remainder==2)
							{
								known_words.push(w);
							}
						}
					}
					
					var g = globalList();
					var globalListValue = [];

					for(var j=0;j<g.length;j++)
					{
						var found = known_words.includes(g[j].w);
						if(!found)
						{
							globalListValue.push(g[j].w);
						}
					}
					
					var arrKnownChar=[];
					for(var i=0;i<known_words.length;i++)
					{
						var chars = known_words[i].split('');
								for(var j=0;j<chars.length;j++)
								{
									var found = arrKnownChar.includes(chars[j]);
									if(!found)
									{
										arrKnownChar.push(chars[j]);
									}
								}
					}
					
					
					t.clear();
					t.row.add( [
							current+"% (current)",wordsPer,totalKnownUnique,arrKnownChar.length,0
						] );
					
					var falseVocabulary = [];
					var finished = false;
					var index = 0;
					var interval=1000;
					var sum = index + interval;
					if(sum<globalListValue.length)
					{
						while(!finished)
						{
							for(var i=index;i<index+interval;i++)
							{
								//add INTERVAL number of words from global list to vocabulary
								falseVocabulary.push(globalListValue[i]);
								
								var chars = globalListValue[i].split('');
								for(var j=0;j<chars.length;j++)
								{
									var found = arrKnownChar.includes(chars[j]);
									if(!found)
									{
										arrKnownChar.push(chars[j]);
									}
								}
							}
							
							totalKnownUnique= 0;
							totalKnownOccurances = 0;
								
							for(var i=0;i<all_valid_words.length;i++)
							{
								var found2 = dataKnown.findIndex(w => w.word === all_valid_words[i].word);
								var found3 = falseVocabulary.includes(all_valid_words[i].word);

								if(found2!=-1||found3)
								{
									totalKnownUnique++;
									totalKnownOccurances += all_valid_words[i].occurances;
								}
							}
							
							current = (Math.round(((totalKnownOccurances/totalOccurances)*100 + Number.EPSILON) * 100) / 100);
							wordsPer = Math.round((1/(1-(current/100)) + Number.EPSILON) * 100) / 100;
							
							t.row.add( [
								current+"%",wordsPer,totalKnownUnique,arrKnownChar.length,index+interval
							] );
							
							sum = index + (interval*2);
							//check if finished
							//if(index + interval<globalListValue.length&&totalKnownOccurances/totalOccurances<0.99)
							if(sum<globalListValue.length&&totalKnownOccurances/totalOccurances<1)
							{
								index+=interval;
							}
							else
							{
								finished = true;
							}
							
						}
					}
							
						
					t.draw();
				}
			}

		}
		
		
		
		
		function CreateGlobalWordChart(data)
		{
			DestroyCharts();
			
			var t = $('#global_table').DataTable();
			
			
			
			
			var data2 = [];
				for(var i=0;i<data.length;i++)
				{
					if(data[i].rank!="")
					{
						data2.push(data[i]);
					}
				}
			
			var g = globalList();
			var globalListValue = [];

			for(var j=0;j<g.length;j++)
			{
					globalListValue.push(g[j].w);
			}
			
			var index = 0;
			var interval = 1000;
			var finished  = false;
			t.clear();
			var uniqueWordsTotal = 0;
			var occurancesTotal = 0;
			var rowArray = [];
			
			if(index + interval<globalListValue.length)
			{
				while(!finished)
				{
					var words1000 = [];
					var occurances = 0;
					var uniqueWords = 0;
					
					for(var i=index;i<interval+index;i++)
					{
						words1000.push(globalListValue[i]);
					}
					
					for(var i=0;i<words1000.length;i++)
					{
						var found2 = data2.findIndex(w => w.word === words1000[i]);
						if(found2!=-1)
						{
							uniqueWords++;
							occurances+=data2[found2].occurances;
							uniqueWordsTotal++;
							occurancesTotal+=data2[found2].occurances;
						
							
							
						}
					}
					
					var row=[];
							row.uniqueWords = uniqueWords;
							row.occurances = occurances;
							row.index = index;
							rowArray.push(row);
					
					if(index + interval<globalListValue.length)
					{
						index+=interval;
					}
					else
					{
						finished = true;
					}
				}
	
			}
				
				for(var i=0;i<rowArray.length;i++)
				{
					t.row.add( [(rowArray[i].index+1)+" to "+(rowArray[i].index+interval),rowArray[i].uniqueWords+" ("+ Math.round(((rowArray[i].uniqueWords/uniqueWordsTotal)*100 + Number.EPSILON) * 100) / 100+"%)",rowArray[i].occurances+" ("+ Math.round(((rowArray[i].occurances/occurancesTotal)*100 + Number.EPSILON) * 100) / 100+"%)"] );
				}
			
			
			t.draw();	
		
			data.sort(sort_by('occurances', true, parseInt));
			data2.sort(sort_by('occurances', true, parseInt));
			var accumulativeWords = [];
			var xAxis=[];
			var total=0;
			for(var i=0;i<data.length;i++)
			{
				
				total+=data[i].occurances;
				xAxis.push(i+1);
				accumulativeWords.push(total);
			}
			var accumulativeWords2 = [];
			var xAxis2=[];
			var total2=0;
			for(var i=0;i<data2.length;i++)
			{
				
				total2+=data2[i].occurances;
				xAxis2.push(i+1);
				accumulativeWords2.push(total2);
			}
			
			var customTooltips = function(tooltip) {
			// Tooltip Element
			var tooltipEl = document.getElementById('chartjs-tooltip');

			if (!tooltipEl) {
				tooltipEl = document.createElement('div');
				tooltipEl.id = 'chartjs-tooltip';
				tooltipEl.innerHTML = '<table></table>';
				this._chart.canvas.parentNode.appendChild(tooltipEl);
			}

			// Hide if no tooltip
			if (tooltip.opacity === 0) {
				tooltipEl.style.opacity = 0;
				return;
			}

			// Set caret Position
			tooltipEl.classList.remove('above', 'below', 'no-transform');
			if (tooltip.yAlign) {
				tooltipEl.classList.add(tooltip.yAlign);
			} else {
				tooltipEl.classList.add('no-transform');
			}

			function getBody(bodyItem) {
				return bodyItem.lines;
			}

			// Set Text
			if (tooltip.body) {
				var titleLines = tooltip.title || [];
				var bodyLines = tooltip.body.map(getBody);

				var innerHtml = '<thead>';
				
				titleLines.forEach(function(title) {
					innerHtml += '<tr><th>' +"Unique Words: "+ title +" ("+(Math.round(((title/data.length)*100 + Number.EPSILON) * 100) / 100)+"%)"+'</th></tr>';
				});
				
				
				
				innerHtml += '</thead><tbody>';

				bodyLines.forEach(function(body, i) {
					var colors = tooltip.labelColors[i];
					var style = 'background:' + colors.backgroundColor;
					style += '; border-color:' + colors.borderColor;
					style += '; border-width: 2px';
					var b = []
					var body = (""+body);
					b = body.trim().split(/[, ]+/);
					var span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>';
					innerHtml += '<tr><td>' +span+ b[2] +" ("+(Math.round(((b[2]/total)*100 + Number.EPSILON) * 100) / 100)+"%)"+ '</td></tr>';
				});
				innerHtml += '</tbody>';

				var tableRoot = tooltipEl.querySelector('table');
				tableRoot.innerHTML = innerHtml;
			}

			var positionY = this._chart.canvas.offsetTop;
			var positionX = this._chart.canvas.offsetLeft;

			// Display, position, and set styles for font
			tooltipEl.style.opacity = 1;
			tooltipEl.style.left = positionX + tooltip.caretX + 'px';
			tooltipEl.style.top = positionY + tooltip.caretY + 'px';
			tooltipEl.style.fontFamily = tooltip._bodyFontFamily;
			tooltipEl.style.fontSize = tooltip.bodyFontSize + 'px';
			tooltipEl.style.fontStyle = tooltip._bodyFontStyle;
			tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
		};
		
		var ctx2 = document.getElementById('chart_global_words_vs_text').getContext('2d');
			chart_global_words_vs_text = new Chart(ctx2, {
				type: 'line',
				data: {
					labels: xAxis,
					datasets: [{
					label: "Current Text",
						data: accumulativeWords,
						backgroundColor: 'rgba(153, 102, 255, .5)',
						borderColor: 'rgba(153, 102, 255, .5)',
						fill: true,
				}, {
					label: "Global List",
						data: accumulativeWords2,
						backgroundColor: 'rgba(51, 102, 105, .5)',
						borderColor: 'rgba(51, 102, 105, .5)',
						fill: true,
				}]
				},
				options: {
					responsive: true,
				title: {
					display: true,
					text: 'Cumulative Word Total vs Unique Words'
				},
				tooltips: {
						enabled: false,
						mode: 'index',
						position: 'nearest',
						custom: customTooltips
					},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Unique Words'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Cumulative Word Total'
						}
					}]
				}
				}
			});
		
			
		}
		
		
		
		function CreateGraph3(data)
		{
		
			DestroyCharts();
			
			var HSK1Array = [];
			var HSK2Array = [];
			var HSK3Array = [];
			var HSK4Array = [];
			var HSK5Array = [];
			var HSK6Array = [];
			var HSK789Array = [];
			var HSKOtherArray = [];
			
			var HSK1ArrayCount = 0;
			var HSK2ArrayCount = 0;
			var HSK3ArrayCount = 0;
			var HSK4ArrayCount = 0;
			var HSK5ArrayCount = 0;
			var HSK6ArrayCount = 0;
			var HSK789ArrayCount = 0;
			var HSKOtherArrayCount = 0;
			
			
			var data2 = [];
				for(var i=0;i<data.length;i++)
				{
					if(data[i].topik!="")
					{
						data2.push(data[i]);
					}
					
					switch(data[i].topik)
						{
							case "HSK1": HSK1Array.push(data[i]); HSK1ArrayCount+=data[i].occurances; break;
							case "HSK2": HSK2Array.push(data[i]); HSK2ArrayCount+=data[i].occurances; break;
							case "HSK3": HSK3Array.push(data[i]); HSK3ArrayCount+=data[i].occurances; break;
							case "HSK4": HSK4Array.push(data[i]); HSK4ArrayCount+=data[i].occurances; break;
							case "HSK5": HSK5Array.push(data[i]); HSK5ArrayCount+=data[i].occurances; break;
							case "HSK6": HSK6Array.push(data[i]); HSK6ArrayCount+=data[i].occurances; break;
							case "HSK7-9": HSK789Array.push(data[i]); HSK789ArrayCount+=data[i].occurances; break;
							default:HSKOtherArray.push(data[i]); HSKOtherArrayCount+=data[i].occurances; break;
						}
				}
		
			
			
			
			data.sort(sort_by('occurances', true, parseInt));
			data2.sort(sort_by('occurances', true, parseInt));
			var accumulativeWords = [];
			var xAxis=[];
			var total=0;
			for(var i=0;i<data.length;i++)
			{
				
				total+=data[i].occurances;
				xAxis.push(i+1);
				accumulativeWords.push(total);
			}
			var accumulativeWords2 = [];
			var xAxis2=[];
			var total2=0;
			for(var i=0;i<data2.length;i++)
			{
				
				total2+=data2[i].occurances;
				xAxis2.push(i+1);
				accumulativeWords2.push(total2);
			}
			
			var customTooltips = function(tooltip) {
			// Tooltip Element
			var tooltipEl = document.getElementById('chartjs-tooltip');

			if (!tooltipEl) {
				tooltipEl = document.createElement('div');
				tooltipEl.id = 'chartjs-tooltip';
				tooltipEl.innerHTML = '<table></table>';
				this._chart.canvas.parentNode.appendChild(tooltipEl);
			}

			// Hide if no tooltip
			if (tooltip.opacity === 0) {
				tooltipEl.style.opacity = 0;
				return;
			}

			// Set caret Position
			tooltipEl.classList.remove('above', 'below', 'no-transform');
			if (tooltip.yAlign) {
				tooltipEl.classList.add(tooltip.yAlign);
			} else {
				tooltipEl.classList.add('no-transform');
			}

			function getBody(bodyItem) {
				return bodyItem.lines;
			}

			// Set Text
			if (tooltip.body) {
				var titleLines = tooltip.title || [];
				var bodyLines = tooltip.body.map(getBody);

				var innerHtml = '<thead>';
				
				titleLines.forEach(function(title) {
					innerHtml += '<tr><th>' +"Unique Words: "+ title +" ("+(Math.round(((title/data.length)*100 + Number.EPSILON) * 100) / 100)+"%)"+'</th></tr>';
				});
				
				
				
				innerHtml += '</thead><tbody>';

				bodyLines.forEach(function(body, i) {
					var colors = tooltip.labelColors[i];
					var style = 'background:' + colors.backgroundColor;
					style += '; border-color:' + colors.borderColor;
					style += '; border-width: 2px';
					var b = []
					var body = (""+body);
					b = body.trim().split(/[, ]+/);
					var span = '<span class="chartjs-tooltip-key" style="' + style + '"></span>';
					innerHtml += '<tr><td>' +span+ b[2] +" ("+(Math.round(((b[2]/total)*100 + Number.EPSILON) * 100) / 100)+"%)"+ '</td></tr>';
				});
				innerHtml += '</tbody>';

				var tableRoot = tooltipEl.querySelector('table');
				tableRoot.innerHTML = innerHtml;
			}

			var positionY = this._chart.canvas.offsetTop;
			var positionX = this._chart.canvas.offsetLeft;

			// Display, position, and set styles for font
			tooltipEl.style.opacity = 1;
			tooltipEl.style.left = positionX + tooltip.caretX + 'px';
			tooltipEl.style.top = positionY + tooltip.caretY + 'px';
			tooltipEl.style.fontFamily = tooltip._bodyFontFamily;
			tooltipEl.style.fontSize = tooltip.bodyFontSize + 'px';
			tooltipEl.style.fontStyle = tooltip._bodyFontStyle;
			tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
		};
			
			
			var ctx = document.getElementById("chart_hsk_vs_text").getContext('2d');
			
			chart_hsk_vs_text = new Chart(ctx, {
			  type: 'bar',
			  data: {
				labels: ["HSK1", "HSK2", "HSK3", "HSK4", "HSK5", "HSK6", "HSK789", "OTHER"],
				datasets: [{
				  //label: '',
				  
				  
				  data: [Math.round(((HSK1ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK2ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK3ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK4ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK5ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK6ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSK789ArrayCount/total)*100 + Number.EPSILON) * 100) / 100, Math.round(((HSKOtherArrayCount/total)*100 + Number.EPSILON) * 100) / 100],
				  backgroundColor: [
					'rgba(255, 99, 132, 0.2)',
					'rgba(54, 162, 235, 0.2)',
					'rgba(255, 206, 86, 0.2)',
					'rgba(75, 192, 192, 0.2)',
					'rgba(153, 102, 255, 0.2)',
					'rgba(255, 159, 64, 0.2)',
					'rgba(5, 99, 132, 0.2)',
					'rgba(54, 5, 235, 0.2)'
				  ],
				  borderColor: [
					'rgba(255,99,132,1)',
					'rgba(54, 162, 235, 1)',
					'rgba(255, 206, 86, 1)',
					'rgba(75, 192, 192, 1)',
					'rgba(153, 102, 255, 1)',
					'rgba(255, 159, 64, 1)',
					'rgba(5,99,132,1)',
					'rgba(54, 5, 235, 1)'
				  ],
				  borderWidth: 1
				}]
			  },
			  options: {
				responsive: true,
				legend: {
					display: false
				  },
				scales: {
				  xAxes: [{
					ticks: {
					  maxRotation: 90,
					  minRotation: 80
					},
					  gridLines: {
					  offsetGridLines: true
					}
				  },
				  {
					position: "top",
					ticks: {
					  maxRotation: 90,
					  minRotation: 80
					},
					gridLines: {
					  offsetGridLines: true
					}
				  }],
				  yAxes: [{
				  display: true,
						scaleLabel: {
							display: true,
							labelString: 'Percent of Current Text'
						},
					ticks: {
					  beginAtZero: true
					}
				  }]
				}
			  }
			});
			
			
			var ctx2 = document.getElementById('myChart3').getContext('2d');
			myChart3 = new Chart(ctx2, {
				type: 'line',
				data: {
					labels: xAxis,
					datasets: [{
					label: "Current Text",
						data: accumulativeWords,
						backgroundColor: 'rgba(153, 102, 255, .5)',
						borderColor: 'rgba(153, 102, 255, .5)',
						fill: true,
				}, {
					label: "HSK Words",
						data: accumulativeWords2,
						backgroundColor: 'rgba(51, 102, 255, .5)',
						borderColor: 'rgba(51, 102, 255, .5)',
						fill: true,
				}]
				},
				options: {
					responsive: true,
				title: {
					display: true,
					text: 'Cumulative Word Total vs Unique Words'
				},
				tooltips: {
						enabled: false,
						mode: 'index',
						position: 'nearest',
						custom: customTooltips
					},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Unique Words'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Cumulative Word Total'
						}
					}]
				}
				}
			});
		}
		
		function InitialiseVoice()
		{
			var sliderPitch = document.getElementById("voicePitchSlider");
			var outputPitch = document.getElementById("pitchOutput");
			
			var objectStore4 = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request4 = objectStore4.get("voicePitch$");
			request4.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
					
				outputPitch.innerHTML = (sliderPitch.value/10);
				
				request4.onsuccess = function(event) {
					if(request4.result) 
					{
							var a = request4.result.appearances;
							sliderPitch.value = a*10;
							outputPitch.innerHTML = a;
							voicePitch = a;
					}
	
				};
			
			sliderPitch.oninput = function() {
				var value = this.value/10;
			  outputPitch.innerHTML = (value);
			  voicePitch = (value);
			  
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("voicePitch$");
				request.onerror = function(event) {
					alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "voicePitch$",appearances: value});
					}
					else
					{
						addwordtodb("voicePitch$",value);
					}
				}
			}
			
			var sliderVolume = document.getElementById("voiceVolumeSlider");
			var outputVolume = document.getElementById("volumeOutput");
			
			
			var objectStore5 = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request5 = objectStore5.get("voiceVolume$");
			request5.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
					
				outputVolume.innerHTML = (sliderVolume.value/10); 
				
				request5.onsuccess = function(event) {
					if(request5.result) 
					{
							var a = request5.result.appearances;
							sliderVolume.value = a*10;
							outputVolume.innerHTML = a;
							voiceVolume = a;
							
					}
	
				};
			
			
			sliderVolume.oninput = function() {
			var value = this.value/10;
			  outputVolume.innerHTML = (value);
			  voiceVolume = (value);
			  
			  			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("voiceVolume$");
				request.onerror = function(event) {
					alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "voiceVolume$",appearances: value});
					}
					else
					{
						addwordtodb("voiceVolume$",value);
					}
				}
			}
			
			var sliderSpeed = document.getElementById("voiceSpeedSlider");
			var outputSpeed = document.getElementById("speedOutput");
			
					var objectStore6 = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request6 = objectStore6.get("voiceSpeed$");
			request6.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
					
						outputSpeed.innerHTML = (sliderSpeed.value/10);
				
				request6.onsuccess = function(event) {
					if(request6.result) 
					{
							var a = request6.result.appearances;
							sliderSpeed.value = a*10;
							outputSpeed.innerHTML = a;
							voiceSpeed = a;
							
					}
	
				};
			sliderSpeed.oninput = function() {
			var value = this.value/10;
			  outputSpeed.innerHTML = (value);
			  voiceSpeed = (value);
			  
			  			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("voiceSpeed$");
				request.onerror = function(event) {
					alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "voiceSpeed$",appearances: value});
					}
					else
					{
						addwordtodb("voiceSpeed$",value);
					}
				}
			}
		
			var objectStore2 = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request2 = objectStore2.get("enableVoice$");
	        request2.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request2.onsuccess = function(event) {          
	          if(request2.result) {
					var a = request2.result.appearances;
					if(a==0)
					{
						enableVoice = false;
						document.getElementById("enableVoice").checked = false;
					}
					else
					{
						enableVoice = true;
						document.getElementById("enableVoice").checked = true;
					}
			}
					else
					{
						if(enableVoice)
						{
							addwordtodb("enableVoice$",1);
							document.getElementById("enableVoice").checked = true;
						}
						else
						{
							addwordtodb("enableVoice$",0);
							document.getElementById("enableVoice").checked = false;
						}
					}
			};
			
			var voices;
			if(window.speechSynthesis.getVoices().length == 0) {
				window.speechSynthesis.addEventListener('voiceschanged', function() {
					voices = window.speechSynthesis.getVoices();
					PopulateVoiceDropDown(voices);
				});
			}
			else {
				voices = window.speechSynthesis.getVoices();
				PopulateVoiceDropDown(voices);
			}
		}
		
		function PopulateVoiceDropDown(voices)
		{
			var voiceDropDown = document.getElementById("voiceOption");
			var length = voiceDropDown.options.length;
			for (i = length-1; i >= 0; i--) {
			  voiceDropDown.options[i] = null;
			}
				voices.forEach(function(voice) {
				//console.log(voice.lang);
				//if(voice.lang=="zh-CN")
				//{
					var opt = document.createElement('option');
					opt.value = voice.name;
					opt.innerHTML = voice.name;
					voiceDropDown.appendChild(opt);
				//}
			});
			
					var objectStore3 = db.transaction(["wordsdb"]).objectStore("wordsdb");
			var request3 = objectStore3.get("voice$");
			request3.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				
				request3.onsuccess = function(event) {
				if(request3.result) {
						var a = request3.result.appearances;
					for(var i=0;i<voiceDropDown.options.length;i++)
					{
						if(voiceDropDown.options[i].value==a)
						{
							voiceDropDown.value=voiceDropDown.options[i].value;
						}
					}
						
					}
	
				};
		}
		
		function GetIndexOfVoice(name)
		{
			var index =-1;
			var voices = window.speechSynthesis.getVoices();
			for(var i=0;i<voices.length;i++)
			{
				if(name==voices[i].name)
				{
					index=i;
					break;
				}
			}
			return index;
		}
		
		function SpeakWord(word)
		{
			var w = word.replace(/\s/g, '');
			var voiceDropDown = document.getElementById("voiceOption").value;
			var voiceIndex=GetIndexOfVoice(voiceDropDown); //TODO move elsewhere?
			if(voiceIndex==-1)
			{
				alert("Voice not found");
			}
			else
			{
				speechSynthesis.cancel();
				var msg = new SpeechSynthesisUtterance();
				var voices = window.speechSynthesis.getVoices();
				msg.voice = voices[voiceIndex]; // Note: some voices don't support altering params
	
				msg.voiceURI = 'native';
				msg.volume = voiceVolume;
				msg.rate = voiceSpeed;
				msg.pitch = voicePitch;
				msg.text = w;
				speechSynthesis.speak(msg);
			}
		}
		
		function AsyncChangeColour(word, incrementByOne, skipJump)
		{
		
							if(colourTimeout)
						{	
							clearTimeout(colourTimeout);
						}
						colourTimeout = setTimeout(function() {
							ChangeColour(word, incrementByOne, skipJump);
						}, 50);
		}
	
		
		function ChangeColour(word, incrementByOne, skipJump)
		{

		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get(word);
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					var w = request.result.word;
					var a;
						if(incrementByOne)
						{
							a = request.result.appearances+1;
						}
						else
						{
							a = request.result.appearances;
						}
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: w,appearances: a});
					
					var remainder = a%3;
					if(remainder==0)
					{
						unknownWordsTabUpToDate = false;
						knownWordsTabUpToDate = false;
						GetPageAndHighlight(w,0,skipJump);
						
					}
					else if(remainder==1)
					{	
						unknownWordsTabUpToDate = false;
						learningWordsTabUpToDate = false;
						GetPageAndHighlight(w,1,skipJump);
						
					}
					else if(remainder==2)
					{
						knownWordsTabUpToDate = false;
						learningWordsTabUpToDate = false;
						GetPageAndHighlight(w,2,skipJump);
						
					}
	
	          } else {
					unknownWordsTabUpToDate = false;
					addwordtodb(word,((startingMark+1)%3));
					GetPageAndHighlight(word,((startingMark+1)%3),skipJump);
					
	          }

			  AsyncCalculateStatistics();
			 
	        };
		}
		
		function setCurrentColour(word,pageNo)
		{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get(word);
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					var w = request.result.word;
					var a = request.result.appearances;
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: w,appearances: a});
					
					var remainder = a%3;
					if(remainder==0)
					{
						AsyncHighlight(w,0,true,pageNo);
					}
					else if(remainder==1)
					{
						AsyncHighlight(w,1,true,pageNo);
					}
					else if(remainder==2)
					{
						AsyncHighlight(w,2,true,pageNo);
					}
	
	          } else {
					addwordtodb(word,startingMark);
					AsyncHighlight(word,startingMark,true,pageNo);
	          }
	        };
		}
		
		function UnmarkJump(items)
		{
		
			var word="";
			if(items.length > 0)
			{
				word=(items[0].innerText);
			}
		
			var optionsDeleteJump = {
			"className": 'jump'
			}
			
			if(word!="")
			{
				ChangeColour(word,false,true);
			}
			
			var instance = new Mark(document.querySelector("div.content"));
			instance.unmark(optionsDeleteJump);
			
			
		}
		
		function JumpToSentence(word)
		{
			//if(!disableJump)
			//{
				window.find(word,false,true,true);
				pendingLookup = word;
				if(enableVoice)
				{
					SpeakWord(word);
				}
			//}
		}
		
	//	function SaveLastSentenceJump(i,w)
	//	{
		//	lastSentenceJumpIndex = i+1;
		//	lastSentenceJumpWord = w;
		//	lastSentenceScrollPos = $("#SentencesTab").scrollTop();
	//	}
		
	//	function LoadLastSentenceJump()
	//	{
		/*
			var table = $('#sentencesDataTable').DataTable();
			
			var index=0;
			 table.rows().every(function(){
				if(this.data()[0]==lastSentenceJumpIndex)
				{
					disableJump = true;
					table.row(':eq('+index+')', { page: 'current' }).select();
					disableJump = false;
					return;
				}
				index++;
			});
			*/
		//	$("#SentencesTab").scrollTop(lastSentenceScrollPos);
				
	//	}
		
		function JumpTo(word, exactly)
		{
				//if(browser=="edge")
				//{
				//	return false;
				//}
				
				var container = document.getElementById ("pasteArea");
				const items = container.getElementsByClassName('jump');
				if(items.length > 0)
				{
					if(items[0].innerText==word)
					{
						jumpAttempts=(jumpAttempts+1)%items.length;
					}
					else
					{
						jumpAttempts = 0;
					}
					
				}
				else
				{
					jumpAttempts = 0;
				}
				UnmarkJump(items);
				
				var optionsJump;
				
				if(exactly)
				{
					optionsJump = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'jump'
					};
					var instance = new Mark(document.querySelector("div.content"));
					instance.mark(word,optionsJump);
				}
				else
				{
					optionsJump = {
						"accuracy": {
							"value": "partially",
							"limiters": limiters
						}, "className": 'jump'
					};
					window.find(word,false,true,true);
					//var instance = new Mark(document.querySelector("div.content"));
					//instance.mark(word,optionsJump);
					
					
				}
		
			
			
			
			if(enableVoice)
			{
				SpeakWord(word);
			}
			if(!enableWriting)
			{
				dictionaryLookup(word);
			}
			imagesLookup(word);
			pendingLookup = word;
			GrammarLookup(word);
			
			if (items.length > 0) {
			  scrollTo({
				top: items[jumpAttempts].offsetTop-(window.innerHeight*.1),
			behavior: 'auto'
			  });
			}
			jumpMarked = true;
		}
		
		function GetPageAndHighlight(word,colorIndex, skipJump)
		{
			var divs = document.getElementsByClassName("individualPage");
			var pageTop = $(window).scrollTop();
			var pageBot = pageTop + $(window).height();
					//var toMark = [];
					for(var i=0;i<divs.length;i++)
					{
						var divTop = divs[i].offsetTop;
						var divBot = divTop+divs[i].offsetHeight;
	
						if(divBot>pageTop-450&&divTop<pageBot+450)
						{
							if(divs[i].marked)
							{	
								AsyncHighlight(word,colorIndex,skipJump,i);
							}
						}
					}
		}
		
		function AsyncHighlight(word, colourIndex, skipJump, pageNo)
		{
			
						highlightTimeout = setTimeout(function() {
							Highlight(word, colourIndex, skipJump,pageNo);
						}, 100);
			
		}
		
		function Highlight(word, colourIndex, skipJump, pageNo)
		{
				if(skipJump)
				{
						var optionsTertiary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'tertiary',
						"exclude":['.jump']
					};
			
					var optionsSecondary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'secondary',
						"exclude":['.jump']
					};
					
					var optionsPrimary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'primary',
						"exclude":['.jump']
					};
				}
				else
				{
						var optionsTertiary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'tertiary'
					};
			
					var optionsSecondary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'secondary'
					};
					
					var optionsPrimary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'primary'
					};
				}

						var instance = new Mark(GetPage(pageNo));
					
					
					if(colourIndex==0)
					{
						instance.mark(word,optionsPrimary);
					}
					else if (colourIndex==1)
					{
						instance.mark(word,optionsSecondary);
					}
					else if (colourIndex==2)
					{
						instance.mark(word,optionsTertiary);
					}
				//}
		}
		
		function unmark()
		{
			if(all_marked)
			{
				var instance = new Mark(document.querySelector("div.content"));
				instance.unmark();
				all_marked = false;
			}
		}
	
		
		function markAll(toMark)
		{
				for(var i=0;i<toMark.length;i++)
				{	
					var page = GetPage(toMark[i]);
					if(page.marked==false)
					{
						var words = page.innerText;
						words=words.replace(replaceCharacters," ");
	
						var wordArray = words.trim().split(/[, ]+/);
						for(var j=0;j<wordArray.length;j++)
						{
							setCurrentColour(wordArray[j],toMark[i]);
						}
						page.marked = true;
					}
				}
				all_marked = true;
		}
	
		function addwordtodb(w,a)
		{
			var request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").add({ word: w,appearances: a});
	                                 
	        request.onsuccess = function(e) {
	        };
	         
	        request.onerror = function(e) {     
	        }   
	
		}
		
		function mouseUp(modifier){
		
			if(enableWriting)
			{
				return;
			}
			
			if(!all_marked&&enableHighlighting&&!enableWriting)
			{
				onScroll();
			}
			
			var selectedText = getSelectionText();
			
			
			if(jumpMarked)
			{
				var container = document.getElementById ("pasteArea");
				const items = container.getElementsByClassName('jump');
				
				
				unmarkJumpTimeout = setTimeout(function() {
							UnmarkJump(items);
						}, 200);
				
				
				
				jumpMarked = false;
			}
			else if(modifier==0||modifier==1)
			{
				if(selectedText!="")
				{

						if(enableVoice)
						{
							SpeakWord(selectedText);
						}
						if(!enableWriting)
						{
							dictionaryLookup(selectedText);
						}
						imagesLookup(selectedText);
						pendingLookup = selectedText;
						GrammarLookup(selectedText);
				}
				else
				{
					var selection = window.getSelection();	
					if (!selection || selection.rangeCount < 1) return true;
					var range = selection.getRangeAt(0);
					var node = selection.anchorNode;
					var word_regexp = regExp;
					
					while ((range.startOffset > 0) && range.toString().match(word_regexp)) {
					  range.setStart(node, (range.startOffset - 1));
					}
					if (!range.toString().match(word_regexp)) {
					  range.setStart(node, range.startOffset + 1);
					}
					while ((range.endOffset < node.length) && range.toString().match(word_regexp)) {
					  range.setEnd(node, range.endOffset + 1);
					}
					if (!range.toString().match(word_regexp)) {
					  range.setEnd(node, range.endOffset - 1);
					}
				
					var word = range.toString(); 
					word=word.replace(replaceCharacters,"");
					
					
					if(word==""&&browser=="chrome")
					{
					   var t = '';
						if (window.getSelection && (sel = window.getSelection()).modify) {
							// Webkit, Gecko
							var s = window.getSelection();
							

								s.modify('extend', 'forward', 'character');
								var testString = s.toString();
								testString = testString.replace(replaceCharacters,"");
								if(testString!='')
								{
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									s.modify('extend', 'forward', 'word');
									t = s.toString();
									t=t.replace(replaceCharacters," ");
									
									
									
									t=t.trim();
									for (var i = 0; i < t.length; i++) {
									  if(t.charAt(i)==" ")
									  {
										t = t.substring(0,i);
										break;
									  }
									}
								}
								
								
							
								
							word = t;
						}
					}	
					
					if(word!="")
					{
							if(modifier==1&&enableHighlighting&&!enableWriting)
							{
								
								AsyncChangeColour(word, true,false);
							}
							if(enableVoice)
								{
									SpeakWord(word);
								}	
							
							if(!enableWriting)
							{
								dictionaryLookup(word);
							}
							imagesLookup(word);
							pendingLookup = word;
							GrammarLookup(word);
							
							var selection = window.getSelection ? window.getSelection() : document.selection ? document.selection : null;
							if(!!selection) selection.empty ? selection.empty() : selection.removeAllRanges();
					}
						
					
				}
				
				if(modifier==0)
				{
					if(openedTab!="DictionaryTab")
					{
						document.getElementById("DictionaryTabButton").click();
					}
					
				}
				
			}
			else
			{
				selectedText=selectedText.replace(replaceCharacters,"");
				if(selectedText!="")
				{
					if(enableHighlighting&&!enableWriting)
					{
						AsyncChangeColour(selectedText, true,false);
					}
					if(enableVoice)
					{
						SpeakWord(selectedText);
					}
					if(!enableWriting)
					{
						dictionaryLookup(selectedText);
					}
					imagesLookup(selectedText);
					pendingLookup = selectedText;
					GrammarLookup(word);
				}
				var selection = window.getSelection ? window.getSelection() : document.selection ? document.selection : null;
				if(!!selection) selection.empty ? selection.empty() : selection.removeAllRanges();
			}
		}
	
		function getSelectionText() {
			var text = "";
			if (window.getSelection) {
				text = window.getSelection().toString();
			} else if (document.selection && document.selection.type != "Control") {
				text = document.selection.createRange().text;
			}
			return text;
		}
		
		
		function dictionaryLookup(word)
		{

			if(openedTab=="DictionaryTab")
			{
				var maxLength = 30;
				if(word.length>maxLength)
				{
					word = word.substring(0, maxLength);	
				}
				
				if(dictionaryLookingUp!=word)
				{
					
					changeDictionarySrc(word);
				}
				dictionaryLookingUp = word;
			}
		}
		
		function RemoveSelection(index)
		{
			if(enableWriting)
			{
				return;
			}
		
			if(index==0)
			{
				var naverIframe = document.getElementById('naverIframe');
				naverIframe.blur();
			}
			else
			{
				var body = document.getElementById('body');
				body.blur;
			}
		}
		
		function imagesLookup(word)
		{	
			if(openedTab=="ImagesTab")
			{
				var maxLength = 30;
				if(word.length>maxLength)
				{
					word = word.substring(0, maxLength);	
				}
				
				if(imagesLookingUp!=word)
				{
					
					changeImagesSrc(word);
				}
				imagesLookingUp = word;
				
			}
		}
		
		function ConvertLangCode(w)
		{
			var code;
			switch(w)
			{
				case "Youdao Korean":code="ko"; break;
				case "Youdao English":code="eng"; break;
				case "Youdao Japanese":code="jap"; break;
				case "Youdao French":code="fr"; break;
				case "Zdic Chinese-Chinese":code="hans"; break;
				default: alert("Language code not found");
			}
			return code;
		}
		
		function GetDictionaryType(dictName)
		{
			if(dictName.includes("Youdao"))
			{
				return("Youdao");
			}
			if(dictName.includes("MDBG"))
			{
				return("MDBG");
			}
			if(dictName.includes("Naver"))
			{
				return("Naver");
			}
			if(dictName.includes("Zdic"))
			{
				return("Zdic");
			}
			if(dictName.includes("Baike"))
			{
				return("Baike");
			}
		}
		
		function changeDictionarySrc(text)
		{
			var loc;
			var dictType =GetDictionaryType(dictionaryLanguage);
			
			switch(dictType)
			{
				case "Youdao": 
					var langCode = ConvertLangCode(dictionaryLanguage);
					loc = "https://www.youdao.com/w/"+langCode+"/"+text+"/#keyfrom=dict2.index";
					break;
				case "MDBG": 
					loc = "https://www.mdbg.net/chinese/dictionary?page=worddict&wdrst=0&wdqb="+text;
					break;
				case "Naver": 
						if(!mobileMode)
						{
							loc = "https://zh.dict.naver.com/#/mini/search?query="+text;
						}
						else if(mobileMode)
						{
							loc = "https://zh.dict.naver.com/#/search?query="+text;
						}
					break;
				case "Zdic": 
					var langCode = ConvertLangCode(dictionaryLanguage);
					loc = "https://www.zdic.net/"+langCode+"/"+text;
					break;
				case "Baike":
					loc = "https://baike.baidu.com/item/"+text;
					break;
				default: console.log("dictionary type not found");
			}
			
			var naverIframe = document.getElementById('naverIframe');
			naverIframe.src = loc;
			//http://www.youdao.com/w/eng/%E9%9B%BE/#keyfrom=dict2.index
			
			/*
			var loc;
			
			var langCode = ConvertLangCode(dictionaryLanguage);
			if(langCode.length==2&&!mobileMode)
			{
				loc = "https://"+langCode+".dict.naver.com/#/mini/search?query="+text;
			}
			else if(langCode.length==2&&mobileMode)
			{
				loc = "https://"+langCode+".dict.naver.com/#/search?query="+text;
			}
			else
			{ 
				loc = "https://dict.naver.com/"+langCode+"/#/mini/search?query="+text;
			}
			var naverIframe = document.getElementById('naverIframe');
			naverIframe.src = loc;
			
			
		*/
			
			//}
			
			setTimeout(function() {RemoveSelection(0);},100);
			setTimeout(function() {RemoveSelection(0);},200);
			setTimeout(function() {RemoveSelection(0);},300);
			setTimeout(function() {RemoveSelection(0);},400);
			setTimeout(function() {RemoveSelection(0);},500);
			setTimeout(function() {RemoveSelection(0);},600);
			setTimeout(function() {RemoveSelection(0);},700);
			setTimeout(function() {RemoveSelection(0);},800);
			setTimeout(function() {RemoveSelection(0);},900);
			setTimeout(function() {RemoveSelection(0);},1000);
			setTimeout(function() {RemoveSelection(0);},1500);
			setTimeout(function() {RemoveSelection(0);},2000);
		}
		
		function changeImagesSrc(text)
		{

			var loc;
			//loc = "https://www.bing.com/images/search?q="+text;
			loc = "https://www.picsearch.com/index.cgi?q="+text;
			imagesIframe = document.getElementById('imagesIframe');
			imagesIframe.src = loc;

			
			setTimeout(function() {RemoveSelection(1);},100);
			setTimeout(function() {RemoveSelection(1);},200);
			setTimeout(function() {RemoveSelection(1);},300);
			setTimeout(function() {RemoveSelection(1);},400);
			setTimeout(function() {RemoveSelection(1);},500);
			setTimeout(function() {RemoveSelection(1);},600);
			setTimeout(function() {RemoveSelection(1);},700);
			setTimeout(function() {RemoveSelection(1);},800);
			setTimeout(function() {RemoveSelection(1);},900);
			setTimeout(function() {RemoveSelection(1);},1000);
			setTimeout(function() {RemoveSelection(1);},1500);
			setTimeout(function() {RemoveSelection(1);},2000);
		}
		
		function toggleEnableVoice()
		{
			if(document.getElementById("enableVoice").checked)
			{
				enableVoice=true;
			
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("enableVoice$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "enableVoice$",appearances: 1});
					}
					else
					{
						addwordtodb("enableVoice$",1);
					}
				}
	
						
			}
			else
			{
				enableVoice=false;
				speechSynthesis.cancel();	
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("enableVoice$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "enableVoice$",appearances: 0});
					}
											else
					{
						addwordtodb("enableVoice$",0);
					}
				}
		
			}
		}
		
		
		function toggleEnableHighlighting()
		{
		if(document.getElementById("enableHighlighting").checked)
			{
				enableHighlighting=true;
				all_marked=false;
			
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("enableHighlighting$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "enableHighlighting$",appearances: 1});
					}
					else
					{
						addwordtodb("enableHighlighting$",1);
					}
				}
	
						
			}
			else
			{
				enableHighlighting=false;
				all_marked=true;
				unmark();
				
				ClearStatistics();
				
				
					
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("enableHighlighting$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "enableHighlighting$",appearances: 0});
					}
											else
					{
						addwordtodb("enableHighlighting$",0);
					}
				}
		
			}
			OnInput();
		}
	
	
	function ClearStatistics()
	{
		var tt = $('#unknownWordsDataTableSummary').DataTable();
					tt.clear().draw();

				var t = $('#unknownWordsDataTable').DataTable();
					t.clear().draw();
					
					var tt2 = $('#learningWordsDataTableSummary').DataTable();
					tt2.clear().draw();

				var t2 = $('#learningWordsDataTable').DataTable();
					t2.clear().draw();
					
					var tt3 = $('#knownWordsDataTableSummary').DataTable();
					tt3.clear().draw();

				var t3 = $('#knownWordsDataTable').DataTable();
					t3.clear().draw();
					
					var tt4 = $('#allWordsDataTableSummary').DataTable();
					tt4.clear().draw();

				var t4 = $('#allWordsDataTable').DataTable();
					t4.clear().draw();
					
				var t5 = $('#vocabularyDataTable').DataTable();
				t5.clear().draw();
				
			var tt5 = $('#vocabularyDataTableSummary').DataTable();
			tt5.clear().draw();
			
				var t6 = $('#compareDataTable').DataTable();
				t6.clear().draw();
						
				DestroyCharts();
				
			document.getElementById("UnknownWordsTabButton").innerHTML='Unknown Words <sup>[4]</sup>';
			document.getElementById("LearningWordsTabButton").innerHTML="Learning Words <sup>[5]</sup>";
			document.getElementById("KnownWordsTabButton").innerHTML="Known Words <sup>[6]</sup>";
		//	disableJump = false;
	}
	
	function openTab(evt, tabName, tabLink) {
	
	if(!initialisationComplete)
	{
		return false;
	}
	
	ShowMenu(false);
	
	if((openedTab==tabName&&(tabName=="OptionsTab"||tabName=="WritingTab"||tabName=="DictionaryTab"||tabName=="LanguageTab"||tabName=="LoginTab"||tabName=="AboutTab"||tabName=="GrammarTab"||tabName=="ImagesTab"||tabName=="StatisticsTab"||tabName=="ExportTab"||tabName=="ImportTab"))
	||
	((tabName=="StatisticsTab")&&(openedTab!=""&&openedTab!="OptionsTab"&&openedTab!="GrammarTab"&&openedTab!="LanguageTab"&&openedTab!="DictionaryTab"&&openedTab!="LoginTab"&&openedTab!="AboutTab"&&openedTab!="WritingTab"&&openedTab!="ExportTab"&&openedTab!="ImagesTab"&&openedTab!="ImportTab"))
	)
	{
		ShowSidebar(false); 
		openedTab="";
		tabcontent = document.getElementsByClassName("tabcontent");
		  for (i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		  }
		  tablinks = document.getElementsByClassName(tabLink);
		  for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		  }
		  return;
	}
	else
	{
		ShowSidebar(true);
		openedTab = tabName;
		  var i, tabcontent, tablinks;
		
		  tabcontent = document.getElementsByClassName("tabcontent");
		  for (i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		  }
		  tablinks = document.getElementsByClassName(tabLink);
		  for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		  }
		  document.getElementById(tabName).style.display = "block";
		  evt.currentTarget.className += " active";
		  
	  }
	  
	
	  
	  
	  if(tabName=="OptionsTab"||tabName=="DictionaryTab"||tabName=="AboutTab"||tabName=="LoginTab"||tabName=="WritingTab"||tabName=="ImagesTab"||tabName=="ExportTab"||tabName=="ImportTab"||tabName=="LanguageTab"||tabName=="GrammarTab")
	   {
		document.documentElement.style.setProperty('--tab-top-percent', '0%');
		document.documentElement.style.setProperty('--tab-bot-percent', '100%');
		/*document.getElementById("UnknownWordsTabButton").style.display="none";
		document.getElementById("KnownWordsTabButton").style.display="none";
		document.getElementById("AllWordsTabButton").style.display="none";
		document.getElementById("LearningWordsTabButton").style.display="none";
		document.getElementById("VocabularyTabButton").style.display="none";
		document.getElementById("CompareTabButton").style.display="none";
		document.getElementById("GraphTabButton").style.display="none";*/
		
	  }
	  else
	  {
	  tablinks = document.getElementsByClassName('toptabs');
		for (i = 0; i < tablinks.length; i++)
		{
			
			tablinks[i].className = tablinks[i].className.replace(" active", "");

			
			if(tablinks[i].id=="StatisticsTabButton")
			{
				tablinks[i].className+= " active";
			}
		}
	  
		document.documentElement.style.setProperty('--tab-top-percent', '15%');
		document.documentElement.style.setProperty('--tab-bot-percent', '85%');
	  }
	  
	  if(tabName=="WritingTab")
	  {
		if(!enableWriting)
		{
			enableWriting = true;
			ExecuteEnableWriting();
		}
	  }
	  else
	  {
		if(enableWriting)
		{
			enableWriting = false;
			ExecuteEnableWriting();
		}
	  }
	  
	  if(tabName=="StatisticsTab")
	  {
		var button = "UnknownWordsTabButton";
		
		switch(lastUsedStatsTab)
		{
			case "LearningWordsTab": button = "LearningWordsTabButton"; break;
			case "KnownWordsTab": button = "KnownWordsTabButton"; break;
			case "AllWordsTab": button = "AllWordsTabButton"; break;
			case "VocabularyTab": button = "VocabularyTabButton"; break;
			case "CompareTab": button = "CompareTabButton"; break;
			case "GraphTab": button = "GraphTabButton"; break;
			case "SentencesTab": button = "SentencesTabButton"; break;
			case "AchievementsTab": button = "AchievementsTabButton"; break;
			case "CharactersTab": button = "CharactersTabButton"; break;
			
		}
		document.getElementById(button).click();
	  }
	  else if((tabName=="UnknownWordsTab"||tabName=="LearningWordsTab"||tabName=="KnownWordsTab"||tabName=="AllWordsTab"||tabName=="GraphTab"||tabName=="AchievementsTab"||tabName=="SentencesTab"||tabName=="CharactersTab")
	  && enableHighlighting&&!enableWriting)
	  {
		AsyncCalculateStatistics();
	  }
	  else if ((tabName=="VocabularyTab"||tabName=="ExportTab"||tabName=="ImportTab") && enableHighlighting&&!enableWriting)
	  {
	  
	  
	  					if(vocabularyTimeout)
						{	
							clearTimeout(vocabularyTimeout);
						}
						vocabularyTimeout = setTimeout(function() {
							CalculateVocabulary();
						}, 200);
						
	  }
	  else if(tabName=="CompareTab" && enableHighlighting&&!enableWriting)
	  {
		CompareVocabulary();
		
	  }
	  else if(tabName=="DictionaryTab" && !enableWriting)
	  {
		dictionaryLookup(pendingLookup);
		setTimeout(function() {RemoveSelection(0);},100);
		setTimeout(function() {RemoveSelection(0);},200);
		setTimeout(function() {RemoveSelection(0);},300);
		setTimeout(function() {RemoveSelection(0);},400);
		setTimeout(function() {RemoveSelection(0);},500);
		setTimeout(function() {RemoveSelection(0);},600);
		setTimeout(function() {RemoveSelection(0);},700);
		setTimeout(function() {RemoveSelection(0);},800);
		setTimeout(function() {RemoveSelection(0);},900);
		setTimeout(function() {RemoveSelection(0);},1000);
		setTimeout(function() {RemoveSelection(0);},1500);
		setTimeout(function() {RemoveSelection(0);},2000);
	  }
	  else if(tabName=="ImagesTab")
	  {
		imagesLookup(pendingLookup);
	  }
	  else if(tabName=="GrammarTab")
	  {
		PopulateGrammarTab();
	  }
	  
	  switch(tabName)
	  {
			case "UnknownWordsTab": lastUsedStatsTab = "UnknownWordsTab"; break;
			case "LearningWordsTab": lastUsedStatsTab = "LearningWordsTab"; break;
			case "KnownWordsTab": lastUsedStatsTab = "KnownWordsTab"; break;
			case "AllWordsTab": lastUsedStatsTab = "AllWordsTab"; break;
			case "VocabularyTab": lastUsedStatsTab = "VocabularyTab"; break;
			case "CompareTab": lastUsedStatsTab = "CompareTab"; break;
			case "GraphTab": lastUsedStatsTab = "GraphTab"; break;
			case "AchievementsTab": lastUsedStatsTab = "AchievementsTab"; break;
			case "SentencesTab": lastUsedStatsTab = "SentencesTab"; break;
			case "CharactersTab": lastUsedStatsTab = "CharactersTab"; break;
		}
	  
	  
	}
	
	
	function AsyncCalculateStatistics()
	{
						if(statisticsTimeout)
						{	
							clearTimeout(statisticsTimeout);
						}
						statisticsTimeout = setTimeout(function() {

							CalculateStatistics();
						}, global_total_words/1);
	}
	
	
	
	function CalculateStatistics()
	{
			var words = document.getElementById ("content").innerText;
			words=words.replace(replaceCharacters," ");
	
			var wordArray = words.trim().split(/[, ]+/);

			unknownArray = [];
			learningArray = [];
			knownArray = [];
			allArray = [];
			
			
			SortWords2(wordArray);
	}
	
	function SortWords2(wordArray)
	{
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
			
	        request.onsuccess = function(event) {          
	          if(request.result) {
				data = request.result;
				var filteredWords=[];
				var filteredRemainder=[];
				
				for(var i=0;i<data.length;i++)
				{
					var remainder = data[i].appearances%3;
					if(remainder!=startingMark)
					{
						filteredWords.push(data[i].word);
						filteredRemainder.push(remainder);
					}
				}
				for(var i=0;i<wordArray.length;i++)
				{
					var index = filteredWords.indexOf(wordArray[i]);
						
					
					var remainder = filteredRemainder[index];
					
					var w = wordArray[i];
							
					if(index > -1)
					{
							
						switch(remainder)
						{
								case 0:
							var found = unknownArray.findIndex(w => w.word === wordArray[i]);
							if(found == -1)
							{
							var n = [];
							n.word = w;
							n.occurances = 1;
							n.topik="";
							n.rank="";
							unknownArray.push(n);
							}
							else
							{
							unknownArray[found].occurances++;
							}
								break;
								
								case 1: 
								var found = learningArray.findIndex(w => w.word === wordArray[i]);
							if(found == -1)
							{
							var n = [];
							n.word = w;
							n.occurances = 1;
							n.topik="";
							n.rank="";
							learningArray.push(n);
							}
							else
							{
							learningArray[found].occurances++;
							}
								
								break;
								case 2:
								var found = knownArray.findIndex(w => w.word === wordArray[i]);
							if(found == -1)
							{
							var n = [];
							n.word = w;
							n.occurances = 1;
							n.topik="";
							n.rank="";
							knownArray.push(n);
							}
							else
							{
							knownArray[found].occurances++;
							}
								break;
						}
					}
					else
					{
							switch(startingMark)
							{
								case 0:
									var found = unknownArray.findIndex(w => w.word === wordArray[i]);
									if(found == -1)
									{
									var n = [];
									n.word = w;
									n.occurances = 1;
									n.topik="";
									n.rank="";
									unknownArray.push(n);
									}
									else
									{
									unknownArray[found].occurances++;
									}
								break;
																case 1:
									var found = learningArray.findIndex(w => w.word === wordArray[i]);
									if(found == -1)
									{
									var n = [];
									n.word = w;
									n.occurances = 1;
									n.topik="";
									n.rank="";
									learningArray.push(n);
									}
									else
									{
									learningArray[found].occurances++;
									}
								break;
																case 2:
									var found = knownArray.findIndex(w => w.word === wordArray[i]);
									if(found == -1)
									{
									var n = [];
									n.word = w;
									n.occurances = 1;
									n.topik="";
									n.rank="";
									knownArray.push(n);
									}
									else
									{
									knownArray[found].occurances++;
									}
								break;
							}
					}

					
				}

				DisplaySort();
			  }
	        };
	}
	
	function CalculateVocabulary()
	{
			var t = $('#vocabularyDataTable').DataTable();
			var tt = $('#vocabularyDataTableSummary').DataTable();
			var ttt = $('#charactersVocabularyDataTableSummary').DataTable();
			var t4 = $('#charactersVocabularyDataTableSummary2').DataTable();
			var t5 = $('#charactersCurrentTextDataTableSummary').DataTable();
			var t6 = $('#charactersCurrentTextDataTable').DataTable();
			var t7 = $('#charactersVocabularyDataTable').DataTable();
			var t8 = $('#charactersAllCurrentTextDataTableSummary').DataTable();
	
			t.clear();
			tt.clear();
			ttt.clear();
			t4.clear();
			t5.clear();
			t6.clear();
			t7.clear();
			t8.clear();
			
			var arrLearning = [];
			var arrKnown = [];
			var arrUnknown = [];
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						var a = req[i].appearances;
						
						if(!w.includes("$"))
						{
							var remainder = a%3;
							
							if(remainder==0)
								{
								arrUnknown.push(w);
								
								if(vocabularyFilter=='Unknown'||vocabularyFilter=='All')
								{
									t.row.add( [
									w,"Unknown"] );
								}
							}
							else if(remainder==1)
								{
								arrLearning.push(w);
								if(vocabularyFilter=='Learning'||vocabularyFilter=='All')
								{
									t.row.add( [
									w,"Learning"] );
								}
							}
							else if(remainder==2)
							{
								arrKnown.push(w);
								if(vocabularyFilter=='Known'||vocabularyFilter=='All')
								{
									t.row.add( [
									w,"Known"] );
								}
							}
						}
				  }
				  			//tt.clear().draw();
									
				tt.row.add( [
					arrUnknown.length+arrKnown.length+arrLearning.length,arrUnknown.length,arrLearning.length,arrKnown.length
				] );
				
				//sort character count summary
				var arrKnownChar=[];
				var arrLearningChar=[];
				var arrUnknownChar=[];
				var charList=[];
				for(var i=0;i<arrKnown.length;i++)
				{
					var chars = arrKnown[i].split('');
					charList+=chars;
					for(var j=0;j<chars.length;j++)
					{
						var found = arrKnownChar.includes(chars[j]);
						if(!found)
						{
							arrKnownChar.push(chars[j]);
						}
					}
				}
				for(var i=0;i<arrLearning.length;i++)
				{
					var chars = arrLearning[i].split('');
					charList+=chars;
					for(var j=0;j<chars.length;j++)
					{
						var found2 = arrKnownChar.includes(chars[j]);
						var found = arrLearningChar.includes(chars[j]);
						if(!found&&!found2)
						{
							arrLearningChar.push(chars[j]);
						}
					}
				}
				for(var i=0;i<arrUnknown.length;i++)
				{
					var chars = arrUnknown[i].split('');
					charList+=chars;
					for(var j=0;j<chars.length;j++)
					{
						var found2 = arrKnownChar.includes(chars[j]);
						var found3 = arrLearningChar.includes(chars[j]);
						var found = arrUnknownChar.includes(chars[j]);
						if(!found&&!found2&&!found3)
						{
							arrUnknownChar.push(chars[j]);
						}
					}
				}
				
				ttt.row.add( [
					arrUnknownChar.length+arrKnownChar.length+arrLearningChar.length,arrUnknownChar.length,arrLearningChar.length,arrKnownChar.length
				] );
				
				t4.row.add( [
					arrUnknownChar.length+arrKnownChar.length+arrLearningChar.length,arrUnknownChar.length,arrLearningChar.length,arrKnownChar.length
				] );
				
			
				  if(openedTab=="VocabularyTab")
				  {
					  ttt.draw();
					  tt.draw();
					  t.draw();
				  }
				
				var allCurrentTextChars=[];
				if((openedTab=="GraphTab" && chartFilter == "chart2")||openedTab=="CharactersTab")
				  {
				  
				  
				  
				  
				  var cl = globalCharList();
				  var globalCharListValue = [];
					for(var j=0;j<cl.length;j++)
					{
						globalCharListValue.push(cl[j].w);
					}
				  

		

					
				
				var knownCurrentTextChars=[];
				var learningCurrentTextChars=[];
				var unknownCurrentTextChars=[];				
				for(var i=0;i<allArray.length;i++)
				{
					var chars = allArray[i].word;
					
					
						for(var j=0;j<chars.length;j++)
						{
							var a = -1;
							for(var k=0;k<allCurrentTextChars.length;k++)
							{
								if(allCurrentTextChars[k].character==chars[j])
								{
									a=k;
									break;
								}
							}
							if(a==-1)
							{
								var item = new Object();
								item.character=chars[j];
								item.occurances=allArray[i].occurances;
								allCurrentTextChars.push(item);
							}
							else
							{
								allCurrentTextChars[a].occurances+=allArray[i].occurances;
							}
						}
						 
					}
					
					if(openedTab=="GraphTab")
					{

						for(var i=0;i<allCurrentTextChars.length;i++)
						{
						//console.log(allCurrentTextChars[i].occurances);
							var found = arrKnownChar.includes(allCurrentTextChars[i].character);
							
							if(found)
							{
								knownCurrentTextChars.push(allCurrentTextChars[i]);
							}
						}
					 
							CreateGraph2(allCurrentTextChars,knownCurrentTextChars);	
					}
					
						if(openedTab=="CharactersTab")
					  {
						var countKnownChar=0;
						var countUnknownChar=0;
						var countLearningChar=0;
						var countUnknownCharUnique=0;
						var countKnownCharUnique=0;
						var countLearningCharUnique=0;
						
						var totalCharsCurrentText=0;
						for(var i=0;i<allCurrentTextChars.length;i++)
						{
							totalCharsCurrentText+=allCurrentTextChars[i].occurances;
						}
						
						for(var i=0;i<allCurrentTextChars.length;i++)
						{
						//console.log(allCurrentTextChars[i].occurances);
							var found = arrKnownChar.includes(allCurrentTextChars[i].character);
							
							
							var rank = "";
							for(var j=0;j<globalCharListValue.length;j++)
							{
								if(globalCharListValue[j].includes(allCurrentTextChars[i].character))
								{
									rank = j+1;
									break;
								}
							}
		
							
							if(found)
							{
								knownCurrentTextChars.push(allCurrentTextChars[i]);
								countKnownChar+=allCurrentTextChars[i].occurances;
								countKnownCharUnique++;
								t6.row.add( [
								allCurrentTextChars[i].occurances,allCurrentTextChars[i].character,Pinyin(allCurrentTextChars[i].character),(100*allCurrentTextChars[i].occurances/totalCharsCurrentText).toFixed(2)+"%",rank,"Known"
								] );
							}
							else
							{
								var found2 = arrLearningChar.includes(allCurrentTextChars[i].character);
								if(found2)
								{
									countLearningChar+=allCurrentTextChars[i].occurances;
									countLearningCharUnique++;
									t6.row.add( [
									allCurrentTextChars[i].occurances,allCurrentTextChars[i].character,Pinyin(allCurrentTextChars[i].character),(100*allCurrentTextChars[i].occurances/totalCharsCurrentText).toFixed(2)+"%",rank,"Learning"
									] );
								}
								else
								{
									countUnknownChar+=allCurrentTextChars[i].occurances;
									countUnknownCharUnique++;
									t6.row.add( [
									allCurrentTextChars[i].occurances,allCurrentTextChars[i].character,Pinyin(allCurrentTextChars[i].character),(100*allCurrentTextChars[i].occurances/totalCharsCurrentText).toFixed(2)+"%",rank,"Unknown"
									] );
								}
							}
						}		
						
						
						t4.draw();
						
						
						
						
						
						for(var i=0;i<arrKnownChar.length;i++)
						{
							var count = 0;
							for(var j=0;j<charList.length;j++)
							{
								if(charList[j]==arrKnownChar[i])
								{
									
									count++;
								}
							}
							
							var rank = "";
							for(var j=0;j<globalCharListValue.length;j++)
							{
								if(globalCharListValue[j].includes(arrKnownChar[i]))
								{
									rank = j+1;
									break;
								}
							}
							
							t7.row.add( [
						count,arrKnownChar[i],Pinyin(arrKnownChar[i]),(100*count/charList.length).toFixed(2)+"%",rank,"Known"
						] );
						}
						
						for(var i=0;i<arrUnknownChar.length;i++)
						{
							var count=0;
							for(var j=0;j<charList.length;j++)
							{
								if(charList[j]==arrUnknownChar[i])
								{
									
									count++
								}
							}
							
							var rank = "";
							for(var j=0;j<globalCharListValue.length;j++)
							{
								if(globalCharListValue[j].includes(arrUnknownChar[i]))
								{
									rank = j+1;
									break;
								}
							}
							
							t7.row.add( [
						count,arrUnknownChar[i],Pinyin(arrUnknownChar[i]),(100*count/charList.length).toFixed(2)+"%",rank,"Unknown"
						] );
						}
						
						for(var i=0;i<arrLearningChar.length;i++)
						{
							var count=0;
							for(var j=0;j<charList.length;j++)
							{
								if(charList[j]==arrLearningChar[i])
								{
									
									count++;
								}
							}
							
							var rank = "";
							for(var j=0;j<globalCharListValue.length;j++)
							{
								if(globalCharListValue[j].includes(arrLearningChar[i]))
								{
									rank = j+1;
									break;
								}
							}
							
							t7.row.add( [
						count,arrLearningChar[i],Pinyin(arrLearningChar[i]),(100*count/charList.length).toFixed(2)+"%",rank,"Learning"
						] );
						}
						
						
						
						
						for(var i=0;i<allCurrentTextChars.length;i++)
						{
							var foundKnown = arrKnownChar.includes(allCurrentTextChars[i].character);
							var foundLearning= arrLearningChar.includes(allCurrentTextChars[i].character);
							
							if(foundKnown)
							{
								knownCurrentTextChars.push(allCurrentTextChars[i]);
							}
							else if(foundLearning)
							{
								learningCurrentTextChars.push(allCurrentTextChars[i]);
							}
							else
							{
								unknownCurrentTextChars.push(allCurrentTextChars[i]);
							}
							
						}
						
						var currentTextTotalCharacters = 0;
						for(var i=0;i<allCurrentTextChars.length;i++)
						{
							currentTextTotalCharacters+=allCurrentTextChars[i].occurances;
						}
						
						/*
						for(var i=0;i<knownCurrentTextChars.length;i++)
						{
							t6.row.add( [
						knownCurrentTextChars[i].occurances,knownCurrentTextChars[i].character,Pinyin(knownCurrentTextChars[i].character),(100*knownCurrentTextChars[i].occurances/currentTextTotalCharacters).toFixed(2)+"%","Known"
						] );
						}
						
						for(var i=0;i<unknownCurrentTextChars.length;i++)
						{
							t6.row.add( [
						unknownCurrentTextChars[i].occurances,unknownCurrentTextChars[i].character,Pinyin(unknownCurrentTextChars[i].character),(100*unknownCurrentTextChars[i].occurances/currentTextTotalCharacters).toFixed(2)+"%","Unknown"
						] );
						}
						
						for(var i=0;i<learningCurrentTextChars.length;i++)
						{
							t6.row.add( [
						learningCurrentTextChars[i].occurances,learningCurrentTextChars[i].character,Pinyin(learningCurrentTextChars[i].character),(100*learningCurrentTextChars[i].occurances/currentTextTotalCharacters).toFixed(2)+"%","Learning"
						] );
						}
						*/
						t6.draw();
						
						var totalWords = countLearningCharUnique+countKnownCharUnique+countUnknownCharUnique;
						var percentUnknown = Math.round(((countUnknownCharUnique/totalWords)*100 + Number.EPSILON) * 100) / 100;
						var percentLearning = Math.round(((countLearningCharUnique/totalWords)*100 + Number.EPSILON) * 100) / 100;
						var percentKnown = Math.round(((countKnownCharUnique/totalWords)*100 + Number.EPSILON) * 100) / 100;
						
						t5.row.add( [
						totalWords,countUnknownCharUnique+" ("+percentUnknown+"%)",countLearningCharUnique+" ("+percentLearning+"%)",countKnownCharUnique+" ("+percentKnown+"%)"
						] );
						
						
						
						
						totalWords = countKnownChar+countLearningChar+countUnknownChar;
						percentUnknown = Math.round(((countUnknownChar/totalWords)*100 + Number.EPSILON) * 100) / 100;
						percentLearning = Math.round(((countLearningChar/totalWords)*100 + Number.EPSILON) * 100) / 100;
						percentKnown = Math.round(((countKnownChar/totalWords)*100 + Number.EPSILON) * 100) / 100;
						
						t8.row.add( [
						totalWords,countUnknownChar+" ("+percentUnknown+"%)",countLearningChar+" ("+percentLearning+"%)",countKnownChar+" ("+percentKnown+"%)"
						] );
						
						t5.draw();
						t8.draw();
						t7.draw();
					  }
				  }
				  
				  
				  
				  
				  
				  
				  
				  
			  }
			  
			  	switch(toExport)
				{
					case "Vocabulary - All":Export(arrUnknown.concat(arrLearning).concat(arrKnown),"Chinese - Vocabulary - All"); break;
					case "Vocabulary - Unknown":Export(arrUnknown,"Chinese - Vocabulary - Unknown"); break;
					case "Vocabulary - Learning":Export(arrLearning,"Chinese - Vocabulary - Learning"); break;
					case "Vocabulary - Known":Export(arrKnown,"Chinese - Vocabulary - Known"); break;
				}
			  
			  };
	}
	
	function ChangeVocabularyFilter()
	{
		var t = $('#vocabularyDataTable').DataTable();
		t.clear().draw();
		var mySelect = document.getElementById('filterVocabularyOption');
		vocabularyFilter=mySelect.value;
		if(vocabularyTimeout)
						{	
							clearTimeout(vocabularyTimeout);
						}
						vocabularyTimeout = setTimeout(function() {
							CalculateVocabulary();
						}, 50);
	}
	
	
	function GetTopikName(index)
	{
		var name;
		switch(index)
		{
			case 0: name = "HSK1"; break;
			case 1: name = "HSK2"; break;
			case 2: name = "HSK3"; break;
			case 3: name = "HSK4"; break;
			case 4: name = "HSK5"; break;
			case 5: name = "HSK6"; break;
			case 6: name = "HSK7-9"; break;
			default: name = "";
		}
		return name;
	}
	
	function DisplaySort()
	{
		
		const numberOfLists = 7;
	
		var topikList = [];
		
					
		for(var i=0;i<numberOfLists;i++)
		{
			topikList[i] = [];
			var list = [];
			
			switch(i)
			{
				case 0: list = hsk1();break;
				case 1: list = hsk2();break;
				case 2: list = hsk3();break;
				case 3: list = hsk4();break;
				case 4: list = hsk5();break;
				case 5: list = hsk6();break;
				case 6: list = hsk7();break;
			}
			
			for(var j=0;j<list.length;j++)
			{
				topikList[i].push(list[j].w);
			}
		}
		
		var g = globalList();
		var globalListValue = [];
		for(var j=0;j<g.length;j++)
			{
				globalListValue.push(g[j].w);
			}
		
		
		
		var unknownCount=0;
		var knownCount=0;
		var learningCount=0;
		
		
		for(var i=0;i<unknownArray.length;i++)
		{
			var rank = globalListValue.indexOf(unknownArray[i].word);
			if(rank==-1)
			{
				unknownArray[i].rank = "";
			}
			else
			{
				unknownArray[i].rank = rank+1;
			}
		
		
			unknownCount+=unknownArray[i].occurances;
			
			
			for(var j=topikList.length-1;j>-1;j--)
			{
				if(topikList[j].includes(unknownArray[i].word))
				{
					unknownArray[i].topik = GetTopikName(j);
				}
			}
		}
			for(var i=0;i<learningArray.length;i++)
		{
		
			var rank = globalListValue.indexOf(learningArray[i].word);
			if(rank==-1)
			{
				learningArray[i].rank = "";
			}
			else
			{
				learningArray[i].rank = rank+1;
			}
		
		
			learningCount+=learningArray[i].occurances;
			
			for(var j=topikList.length-1;j>-1;j--)
			{
				if(topikList[j].includes(learningArray[i].word))
				{
					
					learningArray[i].topik = GetTopikName(j);
				}
			}
		}
			for(var i=0;i<knownArray.length;i++)
		{
			var rank = globalListValue.indexOf(knownArray[i].word);
			if(rank==-1)
			{
				knownArray[i].rank = "";
			}
			else
			{
				knownArray[i].rank = rank+1;
			}
		
			knownCount+=knownArray[i].occurances;
			
			for(var j=topikList.length-1;j>-1;j--)
			{
				if(topikList[j].includes(knownArray[i].word))
				{
					
					knownArray[i].topik = GetTopikName(j);
				}
			}  
		}
		
		allArray = knownArray.concat(learningArray).concat(unknownArray);
		
		var totalWords = knownCount + learningCount + unknownCount;
		
		global_total_words = allArray.length;
		
		var percentUnknown = Math.round(((unknownCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		var percentLearning = Math.round(((learningCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		var percentKnown = Math.round(((knownCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		
		var percentUniqueUnknown = Math.round(((unknownArray.length/allArray.length)*100 + Number.EPSILON) * 100) / 100;
		var percentUniqueLearning = Math.round(((learningArray.length/allArray.length)*100 + Number.EPSILON) * 100) / 100;
		var percentUniqueKnown = Math.round(((knownArray.length/allArray.length)*100 + Number.EPSILON) * 100) / 100;
	
		document.getElementById("UnknownWordsTabButton").innerHTML="Unknown Words ("+percentUnknown+"%) <"+percentUniqueUnknown+"%> <sup>[4]</sup>";
		document.getElementById("LearningWordsTabButton").innerHTML="Learning Words ("+percentLearning+"%) <"+percentUniqueLearning+"%> <sup>[5]</sup>";
		document.getElementById("KnownWordsTabButton").innerHTML="Known Words ("+percentKnown+"%) <"+percentUniqueKnown+"%> <sup>[6]</sup>";
		
		if((lastUsedStatsTab=="UnknownWordsTab"&&!unknownWordsTabUpToDate)||(openedTab=="UnknownWordsTab"&&!unknownWordsTabUpToDate))
		{
			var tt = $('#unknownWordsDataTableSummary').DataTable();
			tt.clear();
			tt.row.add( [
	            unknownCount + " ("+percentUnknown+"%)",totalWords,unknownArray.length+" ("+percentUniqueUnknown+"%)",allArray.length
	        ] );	
			
			var t = $('#unknownWordsDataTable').DataTable();
			t.clear();
	
			for(var i=0;i<unknownArray.length;i++)
			{
				var wordPercent = Math.round(((unknownArray[i].occurances/totalWords)*100 + Number.EPSILON) * 100) / 100; 
				t.row.add( [
	            unknownArray[i].occurances,unknownArray[i].word,wordPercent+"%",unknownArray[i].topik,unknownArray[i].rank
	        ] );
			}
			tt.draw();
			t.draw();
			unknownWordsTabUpToDate = true;
		}
		if((lastUsedStatsTab=="LearningWordsTab"&&!learningWordsTabUpToDate)||(openedTab=="LearningWordsTab"&&!learningWordsTabUpToDate))
		{
		
				var tt2 = $('#learningWordsDataTableSummary').DataTable();
			tt2.clear();
			tt2.row.add( [
	            learningCount + " ("+percentLearning+"%)",totalWords,learningArray.length+" ("+percentUniqueLearning+"%)",allArray.length
	        ] );	
			
					var t2 = $('#learningWordsDataTable').DataTable();
			t2.clear();
	
			for(var i=0;i<learningArray.length;i++)
			{
			var wordPercent = Math.round(((learningArray[i].occurances/totalWords)*100 + Number.EPSILON) * 100) / 100; 
				
				t2.row.add( [
	            learningArray[i].occurances,learningArray[i].word,""+wordPercent+"%",learningArray[i].topik,learningArray[i].rank
	        ] );
			}
			tt2.draw();
			t2.draw();
			learningWordsTabUpToDate = true;
		}
		if((lastUsedStatsTab=="KnownWordsTab"&&!knownWordsTabUpToDate)||(openedTab=="KnownWordsTab"&&!knownWordsTabUpToDate))
		{
						var tt3 = $('#knownWordsDataTableSummary').DataTable();
			tt3.clear();
			tt3.row.add( [
	            knownCount+ " ("+percentKnown+"%)",totalWords,knownArray.length+" ("+percentUniqueKnown+"%)",allArray.length
	        ] );	
					var t3 = $('#knownWordsDataTable').DataTable();
			t3.clear();
	
			for(var i=0;i<knownArray.length;i++)
			{
			var wordPercent = Math.round(((knownArray[i].occurances/totalWords)*100 + Number.EPSILON) * 100) / 100; 
				
				t3.row.add( [
	            knownArray[i].occurances,knownArray[i].word,""+wordPercent+"%",knownArray[i].topik,knownArray[i].rank
	        ] );
			}
			tt3.draw();
			t3.draw();
			knownWordsTabUpToDate = true;
		}
		if((lastUsedStatsTab=="AllWordsTab"&&!allWordsTabUpToDate)||(openedTab=="AllWordsTab"&&!allWordsTabUpToDate))
		{
				var tt4 = $('#allWordsDataTableSummary').DataTable();
			tt4.clear();
			tt4.row.add( [
	            totalWords,allArray.length
	        ] );	
		
					var t4 = $('#allWordsDataTable').DataTable();
			t4.clear();
	
			if(printJSON)
				{
					var json=[];
				}						
			for(var i=0;i<allArray.length;i++)
			{
			var wordPercent = Math.round(((allArray[i].occurances/totalWords)*100 + Number.EPSILON) * 100) / 100; 
				
				t4.row.add( [
	            allArray[i].occurances,allArray[i].word,""+wordPercent+"%",allArray[i].topik,allArray[i].rank
				] );
				
				if(printJSON)
				{ 
					var ww = {o:allArray[i].occurances,w:allArray[i].word};
					json.push(ww); 
				}
			}
			
			if(printJSON)
				{
					console.log(json);
				}	
				
			tt4.draw();
			t4.draw();
			allWordsTabUpToDate = true;
		}
		
		if(openedTab=="CompareTab")
		{
			CompareVocabulary();
		}
		if(openedTab=="GraphTab")
		{
			
		
			SwapChart();
			
			
			
			
			//CreateGraph2(allArray,knownArray);
		}
		if(openedTab=="VocabularyTab")
		{
			if(vocabularyTimeout)
						{	
							clearTimeout(vocabularyTimeout);
						}
						vocabularyTimeout = setTimeout(function() {
							CalculateVocabulary();
						}, 200);
		}
		if(openedTab=="CharactersTab")
		{
			if(vocabularyTimeout)
						{	
							clearTimeout(vocabularyTimeout);
						}
						vocabularyTimeout = setTimeout(function() {
							CalculateVocabulary();
						}, 200);
		}
		if(openedTab=="AchievementsTab")
		{
		
			if(achievementsTimeout)
			{	
				clearTimeout(achievementsTimeout);
			}
						achievementsTimeout = setTimeout(function() {
							CountAndDrawAchievements();
						}, 500);
			
		}
		if(openedTab=="SentencesTab")
		{
		
			if(sentencesTimeout)
			{	
				clearTimeout(sentencesTimeout);
			}
						sentencesTimeout = setTimeout(function() {
							CreateSentences();
						}, 500);
			
		}
		else
		{
			if(achievementsTimeout)
			{	
				clearTimeout(achievementsTimeout);
			}
						achievementsTimeout = setTimeout(function() {
							CountAndDrawAchievements();
						}, 10000);
		}
		
		if(unknownFireDBDocumentLoaded!=false&&learningFireDBDocumentLoaded!=false&&knownFireDBDocumentLoaded!=false)
		{
			if(saveFireDBTimeout)
			{	
					clearTimeout(saveFireDBTimeout);
			}
			saveFireDBTimeout = setTimeout(function() {
				SaveFireDB();
			}, 5000);
		}
		
		
		switch(toExport)
		{
			case "Current Text - All":
				var wordArr = [];
				for(var i=0;i<allArray.length;i++)
				{
					wordArr[i]=allArray[i].word;
				}
				Export(wordArr,"Chinese - Current Text - All");
			break;
			case "Current Text - Unknown":
				var wordArr = [];
				for(var i=0;i<unknownArray.length;i++)
				{
					wordArr[i]=unknownArray[i].word;
				}
				Export(wordArr,"Chinese - Current Text - Unknown");
			break;
			case "Current Text - Learning":
				var wordArr = [];
				for(var i=0;i<learningArray.length;i++)
				{
					wordArr[i]=learningArray[i].word;
				}
				Export(wordArr,"Chinese - Current Text - Learning");
			break;
			case "Current Text - Known":
				var wordArr = [];
				for(var i=0;i<knownArray.length;i++)
				{
					wordArr[i]=knownArray[i].word;
				}
				Export(wordArr,"Chinese - Current Text - Known");
			break;
		}
	}
	
	function Export(list,name)
	{
		toExport="";
		var str="";
		for(var i=0;i<list.length;i++)
		{
			if(i==list.length-1)
			{
				str+=list[i];
			}
			else
			{
				str+=list[i]+"\n";
			}
		}
		
		var blob = new Blob([str],
                { type: "text/plain;charset=utf-8" });
		saveAs(blob, name+".txt");
	}
	
	function Jieba()
	{
		//var _text = "é€™å€‹å¸ƒä¸æ˜¯åœ¨ç„¡èŠçš„ä¸–ç•Œä¸­æ‰¾å°‹æ¨‚è¶£çš„ä¸€ç¨®ä¸èƒ½åƒçš„é£Ÿç‰©ï¼Œå–œæ„›å‹•æ¼«ç•«ã€éŠæˆ²ã€ç¨‹å¼ï¼Œä»¥åŠè·Ÿä¸–é–“è„«ç¯€çš„ç”Ÿæ´»æ­¥èª¿ã€‚";
		//call_jieba_cut(_text, function (_result) {
		//	console.log(_result);
		//});
		
		var pasteArea = document.getElementById ("pasteArea");
		var wordArray=[];
		call_jieba_cut(pasteArea.innerText, function (_result)
		{
			for(var i=0;i<_result.length;i++)
			{
				if(_result[i][0])
				{
					if(_result[i][0]!=" ")
					{
						wordArray.push(_result[i]);
					}
				}
			}
		});
		
		var string = wordArray.join(" ");
		pasteArea.innerText=string;
		//console.log(string);
	}
	
	function ConvertChineseCharacters()
	{
		switch(chineseCharacterConversion)
		{
			case 1: var pasteArea = document.getElementById ("pasteArea"); var string = $.s2t(pasteArea.innerText); pasteArea.innerText=string; break;
			case 2: var pasteArea = document.getElementById ("pasteArea"); var string = $.t2s(pasteArea.innerText); pasteArea.innerText=string; break;
		}
	}
	
	function OnInput()
	{
		var pasteArea = document.getElementById ("pasteArea");
	
		clearTimeout(colourTimeout);
			clearTimeout(scrollTimeout);
			clearTimeout(vocabularyTimeout);
			clearTimeout(displaySortTimeout);
			clearTimeout(statisticsTimeout);
			clearTimeout(highlightTimeout);	
			clearTimeout(unmarkJumpTimeout);
			clearTimeout(calculateStatisticsTimeout);
	
		if(enableHighlighting&&!enableWriting)
		{
			var divs = document.getElementsByClassName("individualPage");
			for(var i=0;i<divs.length;i++)
			{
				divs[i].marked=false;
			}
			
			unmark();
			var pasteArea = document.getElementById ("pasteArea");
			pasteArea.style.fontSize = fontSize+"em";
			if(initialisationComplete)
			{	
				SaveHTML(pasteArea.innerHTML);
			};
			Jieba();
			ConvertChineseCharacters();
			paginate();
			onScroll();
			unknownWordsTabUpToDate = false;
			learningWordsTabUpToDate = false;
			knownWordsTabUpToDate = false;
			allWordsTabUpToDate = false;
			AsyncCalculateStatistics();
		}
		else
		{
			var pasteArea = document.getElementById ("pasteArea");
			pasteArea.style.fontSize = fontSize+"em";
			if(initialisationComplete)
			{	
				SaveHTML(pasteArea.innerHTML);
			}
		}
		
		var innerhtml = document.getElementById("pasteArea").innerHTML;
		if(innerhtml.length<100)
		{
			innerhtml=innerhtml.replace(replaceCharacters,"");
			if(innerhtml=="")
			{
				document.getElementById ("pasteArea").innerHTML="";
			}
		}
		
	}
	
	function LoadHTML()
	{
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("html$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
											
						if(a) 
						{
							
							document.getElementById ("pasteArea").innerHTML=a;

								var $div = $('.romanisedText');
								$div.empty();

							 OnInput();
						}
					}
				};
	}
	
	function SaveHTML(html)
	{
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("html$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "html$",appearances: html});
					}
					else
					{
						addwordtodb("html$",html);
					}
				}
	}

		function GetPage(index)
		{
			var divs = document.getElementsByClassName("individualPage");
			
			return(divs[index]);
	
		}
		
		function scrollOperation()
		{
			var pageTop = $(window).scrollTop();
				var pageBot = pageTop + $(window).height();
				
				if(initialisationComplete)
			{			
				SavePageLocation(pageTop);
			}
				
				var divs = document.getElementsByClassName("individualPage");
					var toMark = [];
					for(var i=0;i<divs.length;i++)
					{
						var divTop = divs[i].offsetTop;
						var divBot = divTop+divs[i].offsetHeight;
	
						if(divBot>pageTop-450&&divTop<pageBot+450)
						{
							if(divs[i].marked==false||divs[i].marked==null)
							{	
								divs[i].marked=false;
								toMark.push(i);
							}
						}
						else
						{
							divs[i].marked=false;
						}
					}
					
					
					
						if(enableHighlighting&&!enableWriting&&toMark.length>0)
						{
							if(colourTimeout)
							{
								clearTimeout(colourTimeout);
							}		
							colourTimeout = setTimeout(function()
								{
									markAll(toMark);
								}	
								,200);
							
							if(openedTab=="VocabularyTab")
							{
								if(vocabularyTimeout)
								{
									clearTimeout(vocabularyTimeout);
								}	
								vocabularyTimeout = setTimeout(function()
								{
									CalculateVocabulary();
									
								}, 700);
							}
						}
		}
	
		function onScroll()
		{
				if(scrollTimeout)
				{
					clearTimeout(scrollTimeout);
				}
									
				scrollTimeout = setTimeout(function() {
    scrollOperation();
},60);
		}
		
		
	function RomaniseText(t)
	{
		return(Pinyin(t));
	}
	
	String.prototype.isEmpty = function() 
				{
					return (this.length === 0 || !this.trim());
				};
	
	function paginate() {
		var b = document.getElementsByClassName('individualPage');
		var pasteArea = document.getElementById("pasteArea");
		
		var $div = $('.romanisedText');
		$div.empty();
		

		
		while(b.length) {
			var parent = b[ 0 ].parentNode;
			while( b[ 0 ].firstChild ) {
				parent.insertBefore(  b[ 0 ].firstChild, b[ 0 ] );
			}
			 parent.removeChild( b[ 0 ] );
		}

		var oldHTML = pasteArea.innerText;
		var replace = /[\n]/g;
		var split = oldHTML.replace(replace,'<br>');
		split = split.split('<br>');
		var newHTML = "";
		for(var i=0;i<split.length;i++)
		{
			if(split[i].length>0)
			{
				var words = split[i];
				words=words.trim();

				if(!words.isEmpty())
				{
					newHTML = newHTML + '<div class="individualPage">'+words+'<br></div>';
					
					//if(romanisationMode==1)
					//{
					//	newHTML = newHTML + '<div class="romanisedText" style="color:blue">' + RomaniseText(words) +'</div>';
					//}
					newHTML+='<br>';
				}
			}
		}

		pasteArea.innerHTML = newHTML ;
	}
	
	function ChangeFont()
	{
		var mySelect = document.getElementById('fontSizeOption');
		fontSize = mySelect.value;
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("fontSize$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "fontSize$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("fontSize$",mySelect.value);
					}
				}
				var pasteArea = document.getElementById ("pasteArea");
			pasteArea.style.fontSize = fontSize+"em";
	}
	
	/*
	function ChangeRomanisation()
	{
		var mySelect = document.getElementById('romanisationOption');
		switch(mySelect.value)
		{
			case "Off": romanisationMode = 0; break;
			case "On": romanisationMode = 1; break;
			default: romanisationMode = 0;
		}
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("romanisationOption$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "romanisationOption$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("romanisationOption$",mySelect.value);
					}
				}
				
				if(romanisationMode==0)
							{
								var $div = $('.romanisedText');
								$div.empty();
							}
				
				OnInput();
	}
	*/
	/*
	function InitialiseRomanisation()
	{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("romanisationOption$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				var dropDown = document.getElementById("romanisationOption");
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
						switch(a)
						{
						case "Off": romanisationMode = 0; dropDown.value = "Off"; break;
						case "On": romanisationMode = 1; dropDown.value = "On"; break;
						default: romanisationMode = 0; dropDown.value = "Off";;					
						}					
					}
					else
					{
						romanisationMode = 0;
						dropDown.value = "Off";
					}
				}
	}
	*/
	
	function InitialiseFontSize()
	{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("fontSize$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
					
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;				
						if(a>0) 
						{
							fontSize = a;
						}
						else
						{
							if(mobileMode)
							{
								fontSize = 1;
							}
							else
							{
								fontSize = fontSizeDefault;
							}
						}
					}
					else
					{
						if(mobileMode)
							{
								fontSize = 1;
							}
							else
							{
								fontSize = fontSizeDefault;
							}
					}
					var dropDown = document.getElementById("fontSizeOption");
					dropDown.value = fontSize;
				};
	}
	
	
	function InitialiseHighlightingKnown()
	{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("highlightingknown$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {
				if(request.result) {
				var a = request.result.appearances;
					if(a==0)
					{
						document.getElementById("enableHighlightingKnown").checked = false;
						SetHighlightingKnown(false,true);
						
						
					}
					else
					{
						document.getElementById("enableHighlightingKnown").checked = true;
					}
			}
					else
					{
						document.getElementById("enableHighlightingKnown").checked = true;
					}
			};		
	}
	
	function ToggleEnableHighlightingKnown()
	{
		//console.log(document.getElementById("enableHighlightingKnown").checked);
		if(document.getElementById("enableHighlightingKnown").checked)
			{
				SetHighlightingKnown(true, true);
				
						
			}
			else
			{
				SetHighlightingKnown(false, true);
			}
	}
	
	function SetHighlightingKnown(activated,reInitialise)
	{
		if(activated)
		{
							var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("highlightingknown$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "highlightingknown$",appearances: 1});
					}
					else
					{
						addwordtodb("highlightingknown$",1);
					}
					
				}
				if(reInitialise)
				{
					InitialiseColourInputField();
				}
		}
		else
		{
							var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("highlightingknown$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "highlightingknown$",appearances: 0});
					}
					else
					{
						addwordtodb("highlightingknown$",0);
					}
					var documentColour = getComputedStyle(document.documentElement).getPropertyValue('--page-bg');
					document.documentElement.style.setProperty('--tertiary-bg', documentColour);
				}
		}
	}
	
	
	function InitialiseColourInputField()
	{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
			
			var request = objectStore.get("primaryField$");
			request.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request.onsuccess = function(event) 
				{
				if(request.result) {
				var a = request.result.appearances;
						if(a)
						{		
							colourPrimary=a;
						}
						else
						{
							colourPrimary=colourPrimaryDefault;
						}
					}
					else
					{
						colourPrimary=colourPrimaryDefault;
					}
						var primaryField = document.getElementById("fieldHC1");
						primaryField.value = colourPrimary;
						primaryField.style.backgroundColor=colourPrimary;
						document.documentElement.style.setProperty('--primary-bg', colourPrimary);
				};
			var objectStore2 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request2 = objectStore2.get("secondaryField$");
			request2.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request2.onsuccess = function(event) 
				{
				if(request2.result) {
						var a = request2.result.appearances;
						if(a)
						{	
							colourSecondary=a;
						}
						else
						{
							colourSecondary=colourSecondaryDefault;
						}
					}
					else
					{
						colourSecondary=colourSecondaryDefault;
					}
						var secondaryField = document.getElementById("fieldHC2");
		secondaryField.value = colourSecondary;
		secondaryField.style.backgroundColor=colourSecondary;
		document.documentElement.style.setProperty('--secondary-bg', colourSecondary);
				};
			var objectStore3 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request3 = objectStore3.get("tertiaryField$");
			request3.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request3.onsuccess = function(event) 
				{
				if(request3.result) {
						var a = request3.result.appearances;
						if(a)
						{
									
							colourTertiary=a;
						}
						else
						{
							colourTertiary=colourTertiaryDefault;
						}
					}
					else
					{
						colourTertiary=colourTertiaryDefault;
					}
						var tertiaryField = document.getElementById("fieldHC3");
		tertiaryField.value = colourTertiary;
		tertiaryField.style.backgroundColor=colourTertiary;
		document.documentElement.style.setProperty('--tertiary-bg', colourTertiary);
				};
			var objectStore4 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request4 = objectStore4.get("jumpField$");
			request4.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request4.onsuccess = function(event) 
				{
				if(request4.result) {
				var a = request4.result.appearances;
				
						if(a)
						{
									
							colourJump=a;
						}
						else
						{
							colourJump=colourJumpDefault;
						}
					}
					else
					{
						colourJump=colourJumpDefault;
					}
						var jumpField = document.getElementById("fieldHC4");
		jumpField.value = colourJump;
		jumpField.style.backgroundColor=colourJump;
		document.documentElement.style.setProperty('--jump-bg', colourJump);
				};
				
			var objectStore5 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request5 = objectStore5.get("bgColourField$");
			request5.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request5.onsuccess = function(event) 
				{
				if(request5.result) {
				var a = request5.result.appearances;
				
						if(a)
						{
									
							colourBackground=a;
						}
						else
						{
							colourBackground=colourBackgroundDefault;
						}
					}
					else
					{
						colourBackground=colourBackgroundDefault;
					}
						var bgField = document.getElementById("fieldHC5");
		bgField.value = colourBackground;
		bgField.style.backgroundColor=colourBackground;
		document.documentElement.style.setProperty('--page-bg', colourBackground);
				};
				
				
							var objectStore6 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request6 = objectStore6.get("fontColourField$");
			request6.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request6.onsuccess = function(event) 
				{
				if(request6.result) {
				var a = request6.result.appearances;
				
						if(a)
						{
									
							colourFont=a;
						}
						else
						{
							colourFont=colourFontDefault;
						}
					}
					else
					{
						colourFont=colourFontDefault;
					}
						var fontField = document.getElementById("fieldHC6");
		fontField.value = colourFont;
		fontField.style.backgroundColor=colourFont;
		document.documentElement.style.setProperty('--font-bg', colourFont);
				};
				
				var objectStore7 = db.transaction(["wordsdb"]).objectStore("wordsdb");	
			var request7 = objectStore7.get("borderColourField$");
			request7.onerror = function(event) {
				alert("Unable to retrieve data from database!");
			};
				request7.onsuccess = function(event) 
				{
				if(request7.result) {
				var a = request7.result.appearances;
				
						if(a)
						{
									
							colourBorder=a;
						}
						else
						{
							colourBorder=colourBorderDefault;
						}
					}
					else
					{
						colourBorder=colourBorderDefault;
					}
						var borderField = document.getElementById("fieldHC7");
		borderField.value = colourBorder;
		borderField.style.backgroundColor=colourBorder;
		document.documentElement.style.setProperty('--document-bg', colourBorder);
				};	
	}
	
	function ValidateColour(c)
	{
		return(/^#([0-9A-F]{3}){1,2}$/i.test(c));
	}
	
	function HC1Submit()
	{
		var primaryField = document.getElementById("fieldHC1");
		if(ValidateColour(primaryField.value))
		{
			colourPrimary=primaryField.value;
		}
		else
		{
			colourPrimary=colourPrimaryDefault;
		}
		
		primaryField.value = colourPrimary;
		primaryField.style.backgroundColor=colourPrimary;
		document.documentElement.style.setProperty('--primary-bg', colourPrimary);
		
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("primaryField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "primaryField$",appearances: colourPrimary});
					}
					else
					{
						addwordtodb("primaryField$",colourPrimary);
					}
				}
	}
	
	function HC2Submit()
	{
			var secondaryField = document.getElementById("fieldHC2");
		if(ValidateColour(secondaryField.value))
		{
			colourSecondary=secondaryField.value;
		}
		else
		{
			colourSecondary=colourSecondaryDefault;
		}
		
		secondaryField.value = colourSecondary;
		secondaryField.style.backgroundColor=colourSecondary;
		document.documentElement.style.setProperty('--secondary-bg', colourSecondary);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("secondaryField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "secondaryField$",appearances: colourSecondary});
					}
					else
					{
						addwordtodb("secondaryField$",colourSecondary);
					}
				}
	}
	
	function HC3Submit()
	{
			var tertiaryField = document.getElementById("fieldHC3");
		if(ValidateColour(tertiaryField.value))
		{
			colourTertiary=tertiaryField.value;
		}
		else
		{
			colourTertiary=colourTertiaryDefault;
		}
		tertiaryField.value = colourTertiary;
		tertiaryField.style.backgroundColor=colourTertiary;
		document.documentElement.style.setProperty('--tertiary-bg', colourTertiary);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("tertiaryField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "tertiaryField$",appearances: colourTertiary});
					}
					else
					{
						addwordtodb("tertiaryField$",colourTertiary);
					}
				}
				document.getElementById("enableHighlightingKnown").checked = true;
				SetHighlightingKnown(true,false);
	}
	
	function HC4Submit()
	{
			var jumpField = document.getElementById("fieldHC4");
		if(ValidateColour(jumpField.value))
		{
			colourJump=jumpField.value;
		}
		else
		{
			colourJump=colourJumpDefault;
		}
		
		jumpField.value = colourJump;
		jumpField.style.backgroundColor=colourJump;
		document.documentElement.style.setProperty('--jump-bg', colourJump);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("jumpField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "jumpField$",appearances: colourJump});
					}
					else
					{
						addwordtodb("jumpField$",colourJump);
					}
				}
	}
	
		function HC5Submit()
	{
			var bgField = document.getElementById("fieldHC5");
		if(ValidateColour(bgField.value))
		{
			colourBackground=bgField.value;
		}
		else
		{
			colourBackground=colourBackgroundDefault;
		}
		
		bgField.value = colourBackground;
		bgField.style.backgroundColor=colourBackground;
		document.documentElement.style.setProperty('--page-bg', colourBackground);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("bgColourField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "bgColourField$",appearances: colourBackground});
					}
					else
					{
						addwordtodb("bgColourField$",colourBackground);
					}
				}
		if(document.getElementById("enableHighlightingKnown").checked)
			{
				SetHighlightingKnown(true, true);
				
						
			}
			else
			{
				SetHighlightingKnown(false, true);
			}		
	}
	
		function HC6Submit()
	{
			var fontField = document.getElementById("fieldHC6");
		if(ValidateColour(fontField.value))
		{
			colourFont=fontField.value;
		}
		else
		{
			colourFont=colourFontDefault;
		}
		
		fontField.value = colourFont;
		fontField.style.backgroundColor=colourFont;
		document.documentElement.style.setProperty('--font-bg', colourFont);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("fontColourField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "fontColourField$",appearances: colourFont});
					}
					else
					{
						addwordtodb("fontColourField$",colourFont);
					}
				}
	}
	
		function HC7Submit()
	{
			var borderField = document.getElementById("fieldHC7");
		if(ValidateColour(borderField.value))
		{
			colourBorder=borderField.value;
		}
		else
		{
			colourBorder=colourBorderDefault;
		}
		
		borderField.value = colourBorder;
		borderField.style.backgroundColor=colourBorder;
		document.documentElement.style.setProperty('--document-bg', colourBorder);
		
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("borderColourField$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "borderColourField$",appearances: colourBorder});
					}
					else
					{
						addwordtodb("borderColourField$",colourBorder);
					}
				}
	}
	
	function ChangeVoice()
	{
		var mySelect = document.getElementById('voiceOption');
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("voice$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result) {
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "voice$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("voice$",mySelect.value);
					}
				}
	}
	
	function QuickSortWords(word,appearances,last,listName,index,unknownArrayCompare,learningArrayCompare,knownArrayCompare,allArrayCompare)
	{
	
			
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get(word);
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
			  
					var w = request.result.word;
					var a = request.result.appearances;
					var remainder = a%3;
					if(remainder==0)
					{
						const found = unknownArrayCompare.findIndex(w => w.word === word);
						if(found == -1)
						{
						var n = [];
						n.word = w;
						n.occurances = appearances;
						unknownArrayCompare.push(n);
						}
						else
						{
						unknownArrayCompare[found].occurances+=appearances;
						}
					}
					else if(remainder==1)
					{
						const found = learningArrayCompare.findIndex(w => w.word === word);
						if(found == -1)
						{
						var n = [];
						n.word = w;
						n.occurances = appearances;
						learningArrayCompare.push(n);
						}
						else
						{
						learningArrayCompare[found].occurances+=appearances;
						}
					}
					else if(remainder==2)
					{
						const found = knownArrayCompare.findIndex(w => w.word === word);
						if(found == -1)
						{
						var n = [];
						n.word = w;
						n.occurances = appearances;
						knownArrayCompare.push(n);
						}
						else
						{
						knownArrayCompare[found].occurances+=appearances;
						}
					}
	
	          } 
			  else 
			  {
						var n = [];
						n.word = word;
						n.occurances = appearances;
						unknownArrayCompare.push(n);
	          }
			  
			  if(last)
			  {
					allArrayCompare = knownArrayCompare.concat(learningArrayCompare).concat(unknownArrayCompare);
					//if(displayComparisonTimeout)
					//{	
					//	clearTimeout(displayComparisonTimeout);
					//}
					displayComparisonTimeout = setTimeout(function() {
					  DisplayComparison(listName,index,unknownArrayCompare,learningArrayCompare,knownArrayCompare,allArrayCompare);
					}, 50);
			  }
	        };
			
	}
	
	  
	function CompareVocabulary()
	{
			if(statisticsTimeout)
			{	
				clearTimeout(statisticsTimeout);
			}
	
			
				

					if(compareLoop==false)
					{
						var t = $('#compareDataTable').DataTable();
					t.clear().draw();
					  CompareLoop(0);
					}
	}
	
	function CompareLoop(index)
	{ 
		compareLoop=true;
		var list;
		var name = GetTopikName(index);

		switch(index)
		{
				case 0: list = hsk1();break;
				case 1: list = hsk2();break;
				case 2: list = hsk3();break;
				case 3: list = hsk4();break;
				case 4: list = hsk5();break;
				case 5: list = hsk6();break;
				case 6: list = hsk7();break;
			default: compareLoop=false; index=-1;
		}
		
		if(index!=-1)
		{
				var unknownArrayCompare = [];
				var learningArrayCompare = [];
				var knownArrayCompare = [];
				var allArrayCompare = [];
			
			for(var i=0;i<list.length;i++)
			{
				//var splitList = list[i].split(' ');
				
				if(list.length-1==i)
					{
						QuickSortWords(list[i].w,list[i].o,true,name,index,unknownArrayCompare,learningArrayCompare,knownArrayCompare,allArrayCompare);
					}
					else{
						QuickSortWords(list[i].w,list[i].o,false,name,index,unknownArrayCompare,learningArrayCompare,knownArrayCompare,allArrayCompare);
					}
				
			}
		}
	}

	function DisplayComparison(listName, index,unknownArrayCompare,learningArrayCompare,knownArrayCompare,allArrayCompare)
	{
			var unknownCount=0;
		var knownCount=0;
		var learningCount=0;
		
		for(var i=0;i<unknownArrayCompare.length;i++)
		{
			unknownCount+=unknownArrayCompare[i].occurances;
		}
			for(var i=0;i<learningArrayCompare.length;i++)
		{
			learningCount+=learningArrayCompare[i].occurances;
		}
			for(var i=0;i<knownArrayCompare.length;i++)
		{
			knownCount+=knownArrayCompare[i].occurances;
		}
		
		var totalWords = knownCount + learningCount + unknownCount;
		
		var percentUnknown = Math.round(((unknownCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		var percentLearning = Math.round(((learningCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		var percentKnown = Math.round(((knownCount/totalWords)*100 + Number.EPSILON) * 100) / 100;
		
		var percentUniqueUnknown = Math.round(((unknownArrayCompare.length/allArrayCompare.length)*100 + Number.EPSILON) * 100) / 100;
				var t = $('#compareDataTable').DataTable();
				t.row.add( [
	            listName,percentUnknown,percentLearning,percentKnown,
				unknownArrayCompare.length +" ("+percentUniqueUnknown+"%)",allArrayCompare.length
	        ] );
			
			t.draw();
			CompareLoop(index+1);
	}
	
	function ChangeFontType()
	{
		var mySelect = document.getElementById('fontTypeOption');
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("fonttype$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result)
					{
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "fonttype$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("fonttype$",mySelect.value);
					}
				}
			document.documentElement.style.setProperty('--font-type', mySelect.value);
		
	}
	
	function ChangeDictLanguage()
	{
		var mySelect = document.getElementById('dictLanguageOption');
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("dictlanguage$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result)
					{
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "dictlanguage$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("dictlanguage$",mySelect.value);	
					}
					dictionaryLanguage = mySelect.value;
					var dropDown = document.getElementById("dictLanguageOption");
					dropDown.value = dictionaryLanguage;
					var dropDown2 = document.getElementById("dictLanguageOption2");
					dropDown2.value = dictionaryLanguage;
					
					if(!enableWriting)
					{
						dictionaryLookup(pendingLookup);
					}
				}
			dictionaryLookingUp="";
			
	}
	
	function ChangeDictLanguage2()
	{
		var mySelect = document.getElementById('dictLanguageOption2');
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("dictlanguage$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result)
					{
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "dictlanguage$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("dictlanguage$",mySelect.value);	
					}
					dictionaryLanguage = mySelect.value;
					var dropDown = document.getElementById("dictLanguageOption");
					dropDown.value = dictionaryLanguage;
					var dropDown2 = document.getElementById("dictLanguageOption2");
					dropDown2.value = dictionaryLanguage;
					dictionaryLookingUp="";
					if(!enableWriting)
					{
						dictionaryLookup(pendingLookup);
					}
				}
	}
	
	function OnResize()
	{
		if (/Mobi/.test(navigator.userAgent)||window.innerWidth<900)
		{
			mobileMode =true;
			document.documentElement.style.setProperty('--pasteArea-percent', '50%');
			document.documentElement.style.setProperty('--sidebar2-percent', '50%');
			SetCurrentSidebar();
			//document.documentElement.style.setProperty('--tabcontent-padding', '.1vh');
			
		}
		else
		{
			mobileMode =false;
			document.documentElement.style.setProperty('--sidebar2-percent', '30%');
			SetCurrentSidebar();
			//document.documentElement.style.setProperty('--tabcontent-padding', '.1vh');
		}
		
		var c = document.getElementsByClassName("wrapper3");
		//c[0].style.height = $(window).height()-($(window).height()*.075)+"px";
		c[0].style.height = $(window).outerHeight()-($(window).outerHeight()*.075)+"px";
	}
	 
	function ToggleOpenMenu()
	{
		if(!initialisationComplete)
		{
			return false;
		}	
		if(menuVisible)
		{
			ShowMenu(false)
			
		}
		else
		{
			ShowMenu(true)
		}
	
	}
	
		function ShowMenu(show)
	{
		if(show)
		{
			var tablinks = document.getElementsByClassName('toptabs');
			
			//if(openedTab!="OptionsTab"&&openedTab!="AboutTab")
			//{
				//for (i = 0; i < tablinks.length; i++)
				//{
				//	tablinks[i].className = tablinks[i].className.replace(" active", "");
				//	openedTab="";
				//}
			//}
			
			
			//ShowSidebar(false);
			document.getElementById("menu").style.visibility="visible";
			menuVisible = true;
			
			
		}
		else
		{
			//var tablinks = document.getElementsByClassName('topbarbutton');
			//for (i = 0; i < tablinks.length; i++)
			//{
				
			//	tablinks[i].className = tablinks[i].className.replace(" active", "");
				
			//}
		
			document.getElementById("menu").style.visibility="hidden";
			menuVisible = false;
		}
	
	}
	
	function SetCurrentSidebar()
	{
		if(sidebarVisible)
		{
			if(!mobileMode)
			{
				document.getElementById("sidebar2").style.display="block";
				sidebarVisible = true;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '70%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '30%');
			}
			else
			{
				document.getElementById("sidebar2").style.display="block";
				sidebarVisible = true;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '50%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '40%');
			}
			
		}
		else
		{
			if(!mobileMode)
			{
				document.getElementById("sidebar2").style.display="none";
				sidebarVisible = false;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '100%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '30%');
			}
			else
			{
				document.getElementById("sidebar2").style.display="none";
				sidebarVisible = false;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '100%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '40%');
			}
		}
	}
	

	function ShowSidebar(show)
	{
		if(show&&!sidebarVisible)
		{
			if(!mobileMode)
			{
				document.getElementById("sidebar2").style.display="block";
				sidebarVisible = true;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '70%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '30%');
			}
			else
			{
				document.getElementById("sidebar2").style.display="block";
				sidebarVisible = true;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '50%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '40%');
			}
			
		}
		else if(!show&&sidebarVisible)
		{
			if(!mobileMode)
			{
				document.getElementById("sidebar2").style.display="none";
				sidebarVisible = false;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '100%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '30%');
			}
			else
			{
				document.getElementById("sidebar2").style.display="none";
				sidebarVisible = false;
			
				document.documentElement.style.setProperty('--pasteArea-percent', '100%');
				//document.documentElement.style.setProperty('--sidebar2-percent', '40%');
			}
		}
	}
function InitialiseStartingMark()
{
		var dropDown = document.getElementById("startingMarkOption");
		dropDown.value = "Unknown";
		
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("startingmark$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
											
						startingMark = a;
					}
					else
					{
						addwordtodb("startingmark$",startingMarkDefault);
						startingMark = startingMarkDefault;
					}
					
					var dropDownValue = "Unknown";
					switch(startingMark)
					{
						case 0: dropDownValue = "Unknown"; break;
						case 1: dropDownValue = "Learning"; break;
						case 2: dropDownValue = "Known"; break;
						default: dropDownValue = "Unknown"; 
					}
					
					dropDown.value = dropDownValue;
				};
}

function ButtonDeleteCurrentTextSubmit()
{
	var r = confirm("Delete current text's words from vocabulary?");
	if (r == true) {
	  DeleteCurrentTextVocabulary();
	}
}

function ButtonDeleteAllSubmit()
{

	var r = confirm("Delete all words from vocabulary?");
	if (r == true) {
	  DeleteAllVocabulary();
	}
}


function DeleteAllVocabulary()
{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
			var selectedVocab=[];
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						if(!w.includes("$"))
						{
							selectedVocab.push(w);
						}
				  }
			  }
			  
					for(var i=0;i<selectedVocab.length;i++)
					{
						var transaction2 = db.transaction(["wordsdb"], "readwrite");
						transaction2.onerror = function(event) {
						  };
						var objectStore2 = transaction2.objectStore("wordsdb");
						var objectStoreRequest2 = objectStore2.delete(selectedVocab[i]);
					}
					OnInput();					
			  };										
}

function DeleteCurrentTextVocabulary()
{
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        /*var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
			var selectedVocab=[];
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						if(!w.includes("$"))
						{
							selectedVocab.push(w);
						}
				  }
			  }
			  */
					var pasteArea = document.getElementById ("pasteArea");
					var words = pasteArea.innerText;
						words=words.replace(replaceCharacters," ");
	
						var wordArray = words.trim().split(/[, ]+/);
						//for(var j=0;j<wordArray.length;j++)
						//{
						//	setCurrentColour(wordArray[j],toMark[i]);
						//}
			  
			  
					for(var i=0;i<wordArray.length;i++)
					{
						var transaction2 = db.transaction(["wordsdb"], "readwrite");
						transaction2.onerror = function(event) {
						  };
						var objectStore2 = transaction2.objectStore("wordsdb");
						var objectStoreRequest2 = objectStore2.delete(wordArray[i]);
					}
					OnInput();					
			  //};										
}


function ChangeStartingMark()
{
		var mySelect = document.getElementById('startingMarkOption');
		var s = mySelect.value;
		var sIndex = 0;
		//var toDelete = false;
		
		switch(s)
		{
						case "Unknown": sIndex = 0;  break;
						case "Learning": sIndex = 1; break;
						case "Known": sIndex = 2; break;
						default: sIndex = 0; 
		}
		//console.log(sIndex +" "+startingMark);
		
		//console.log(sIndex);
		
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("startingmark$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result) {
					//console.log("putting word "+sIndex);
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "startingmark$",appearances: sIndex});
					}
					else
					{
						//console.log("adding to db "+sIndex);
						addwordtodb("startingmark$",sIndex);
					}
				}
				startingMark = sIndex;
				unknownWordsTabUpToDate = false;
				learningWordsTabUpToDate = false;
				knownWordsTabUpToDate = false;	
}

function CountAndDrawAchievements()
{
	var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
			var count=0;
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var reqe = request.result;
					for(var i=0;i<reqe.length;i++)
					{
						var w = reqe[i].word;
						var a = reqe[i].appearances;
						
						if(!w.includes("$"))
						{
							var remainder = a%3;
							if(remainder==2)
							{
								count++;
								
							}
						}
				  }
				  DrawAchievements(count);
			  }
			};
			
}

function DrawAchievements(count)
{
		var awardEvery = 1000;

		var tttt = $('#achievementsDataTable').DataTable();
		if(openedTab=="AchievementsTab")
		{
			//tttt.draw();
			tttt.clear();
		}
		
		var achievementsArray;

		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("achievements$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) 
				{
					if(request.result) {
						achievementsArray = request.result.appearances;
					}
					else
					{
						achievementsArray=[];
					}
					
					var c = count;
					c = c/awardEvery;
					for(var i=achievementsArray.length;i<c;i++)
					{
						var d = new Date();
						achievementsArray.push(d);
					}
					
					
					for(var i=1;i<achievementsArray.length;i++)
					{
						tttt.row.add( [
							i*awardEvery, DateFormat(achievementsArray[i])
						] );
					}
					
				if(request.result) {
				request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "achievements$",appearances: achievementsArray});
					}
					else
					{
						addwordtodb("achievements$",achievementsArray);
					}
					if(openedTab=="AchievementsTab")
					{
						var text = document.getElementById ("achievementsText");
						text.innerText = "Current known word count: "+count + " words";
						tttt.draw();
					}  
					
				};
}

function DateFormat(d)
{
	var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
	var minutes = d.getMinutes();
	if(minutes<10)
	{
		minutes = "0"+minutes;
	}
	var string = d.getHours()+":"+minutes+"   "+months[d.getMonth()] + " "+d.getDate()+" "+d.getFullYear();
	return string;
}

function ButtonDeleteAchievementsSubmit()
{
	var r = confirm("Delete all achievements?");
	if (r == true) {
	  DeleteAllAchievements();
	}
	
}

function DeleteAllAchievements()
{
	clearTimeout(achievementsTimeout);


	var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("achievements$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				var emptyArray = [];
				request.onsuccess = function(event) 
				{
				if(request.result) {
				request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "achievements$",appearances: emptyArray});
					}
					else
					{
						//console.log("adding to db "+sIndex);
						addwordtodb("achievements$",emptyArray);
					}

	var tttt = $('#achievementsDataTable').DataTable();
	tttt.clear().draw();
	};
}

function ButtonExportWordlistSubmit()
{
	var mySelect = document.getElementById('filterExportWordlistOption');
	var selectText = mySelect.value;
	
	switch(selectText)
	{
		case "Vocabulary - All": CalculateVocabulary(); toExport="Vocabulary - All"; break;
		case "Vocabulary - Unknown": CalculateVocabulary(); toExport="Vocabulary - Unknown"; break;
		case "Vocabulary - Learning": CalculateVocabulary(); toExport="Vocabulary - Learning"; break;
		case "Vocabulary - Known": CalculateVocabulary(); toExport="Vocabulary - Known"; break;
		case "Current Text - All":CalculateStatistics(); toExport="Current Text - All"; break;
		case "Current Text - Unknown":CalculateStatistics(); toExport="Current Text - Unknown"; break;
		case "Current Text - Learning":CalculateStatistics(); toExport="Current Text - Learning"; break;
		case "Current Text - Known":CalculateStatistics(); toExport="Current Text - Known"; break;
		default: return;
	}
}

function ChangeFilterExportWordlist()
{
	var mySelect = document.getElementById('filterExportWordlistOption');
	chosenExportWordlist=mySelect.value;
}

function InitialiseExportWordlist()
{
	var mySelect = document.getElementById('filterExportWordlistOption');
	mySelect.value = chosenExportWordlist;
}
function HC1OnInput()
{
	var primaryField = document.getElementById("fieldHC1");
		if(ValidateColour(primaryField.value))
		{
			primaryField.style.backgroundColor=primaryField.value;
		}
}

function HC2OnInput()
{
	var secondaryField = document.getElementById("fieldHC2");
		if(ValidateColour(secondaryField.value))
		{
			secondaryField.style.backgroundColor=secondaryField.value;
		}
}

function HC3OnInput()
{
	var tertiaryField = document.getElementById("fieldHC3");
		if(ValidateColour(tertiaryField.value))
		{
			tertiaryField.style.backgroundColor=tertiaryField.value;
		}
}

function HC4OnInput()
{
	var jumpField = document.getElementById("fieldHC4");
		if(ValidateColour(jumpField.value))
		{
			jumpField.style.backgroundColor=jumpField.value;
		}
}

function HC5OnInput()
{
	var bgField = document.getElementById("fieldHC5");
		if(ValidateColour(bgField.value))
		{
			bgField.style.backgroundColor=bgField.value;
		}
}

function HC6OnInput()
{
	var fontColourField = document.getElementById("fieldHC6");
		if(ValidateColour(fontColourField.value))
		{
			fontColourField.style.backgroundColor=fontColourField.value;
		}
}

function HC7OnInput()
{
	var borderColourField = document.getElementById("fieldHC7");
		if(ValidateColour(borderColourField.value))
		{
			borderColourField.style.backgroundColor=borderColourField.value;
		}
}

function ChangeFilterImport()
{

	var importDropDown = document.getElementById("filterImportOption");
	importWordlistFilter=importDropDown.value;
}

function ButtonImportSubmit()
{
	var w = document.getElementById("importTextArea").value;
	
	var replace = /[\n]/g;
	var wordArray = w.replace(replace,' ');
	wordArray = wordArray.trim().split(/[, ]+/);
	
	if(wordArray.length>0)
	{
		var state = 0;
		switch(importWordlistFilter)
		{
			case "Unknown": state = 0;break;
			case "Learning": state = 1;break;
			case "Known": state = 2; break;
		}
		
		QuickImport(wordArray,state);
		
		
		document.getElementById("importTextArea").value="";
	}
}

function ReadFile(f) 
{
  
  if (!f) {
        alert("Failed to load file");
    } else if (!f.type.match('text.*')) {
		    alert(f.name + " is not a valid text file.");
    }
	else
	{
		var reader = new FileReader();
		reader.onload = function(event)
		{
			var words = reader.result;
			words=words.replace(replaceCharacters," ");
			document.getElementById("importTextArea").value=words;
		};
		
		reader.readAsText(f);
	}
}

function InitialiseImport()
{
	var importDropDown = document.getElementById("filterImportOption");
	importDropDown.value=importWordlistFilter;
}

function UpdateOrAddDBRow(w,a)
{
			
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get(w);
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					
					request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: w,appearances: a});
	          } else
			  {
					
					addwordtodb(w,a);
					
	          }
			  
	        };
}

function ClearImportSubmit()
{
	document.getElementById("importTextArea").value="";
	fileSelector.value="";
}

function ChangeUILanguage()
{
	var mySelect = document.getElementById('uiLanguageOption');
		var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("uilanguage$");
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
				request.onsuccess = function(event) {          
					if(request.result)
					{
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "uilanguage$",appearances: mySelect.value});
					}
					else
					{
						addwordtodb("uilanguage$",mySelect.value);	
					}
					SetUILanguage(mySelect.value);
				}
}

function InitialiseUILanguage()
{
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
		var request = objectStore.get("uilanguage$");
		var uilanguage="";
		request.onerror = function(event) {
			alert("Unable to retrieve data from database!");
		};
					
					
				request.onsuccess = function(event) {
				if(request.result) {
						var a = request.result.appearances;
						uilanguage=a;
										
					}
					else
					{
						uilanguage = uidefault;
					}
					SetUILanguage(uilanguage);
					var dropDown = document.getElementById("uiLanguageOption");
					dropDown.value = uilanguage;
				};
}

function ChangeReaderLanguage()
{
	var lang = document.getElementById("readerLanguageOption").value;
	switch(lang)
	{
		case "English": window.open("https://lance388.github.io/reader/en/index.html"); break;
		case "Chinese": break;
		case "Korean": window.open("https://koreanreader.com/"); break;
		case "Vietnamese": window.open("https://lance388.github.io/reader/vn/index.html"); break;
		case "Spanish": window.open("https://lance388.github.io/reader/es/index.html"); break;
	}
}

function SetDefaultReaderLanguage()
{
	document.getElementById("readerLanguageOption").value = "Chinese";
}

function ChangeChart()
{
	var chartDropDown = document.getElementById("chartOption");
	chartFilter=chartDropDown.value;
	SwapChart();
}

function DestroyCharts()
{

	if(myChart instanceof Chart)
	{
		myChart.destroy();
	}
	if(myChart2 instanceof Chart)
	{
		myChart2.destroy();
	}
	if(myChart3 instanceof Chart)
	{
		myChart3.destroy();
	}
	if(chart_hsk_vs_text instanceof Chart)
	{
		chart_hsk_vs_text.destroy();
	}
	if(chart_global_words_vs_text instanceof Chart)
	{
		chart_global_words_vs_text.destroy();
	}
}

function SwapChart()
{
	DestroyCharts();
	
	
	myChart = document.getElementById("myChart");
	myChart2 = document.getElementById("myChart2");
	myChart3 = document.getElementById("myChart3");
	chart_hsk_vs_text = document.getElementById("chart_hsk_vs_text");
	chart_global_words_vs_text = document.getElementById("chart_global_words_vs_text");
	var predictions_text = document.getElementById("predictions_text");
	
	myChart.style.display = "none";
	myChart2.style.display = "none";
	myChart3.style.display = "none";
	chart_hsk_vs_text.style.display = "none";
	chart_global_words_vs_text.style.display = "none";
	document.getElementById("predictions_table").style.display="none";
	predictions_text.style.display="none";
	document.getElementById("global_table").style.display="none";

	switch(chartFilter)
			{
				case "chart1": 
				myChart.style.display = "block";
				CreateGraph(allArray,knownArray); break;
				
				case "chart2":
				myChart2.style.display = "block";

				if(vocabularyTimeout)
						{	
							clearTimeout(vocabularyTimeout);
						}
						vocabularyTimeout = setTimeout(function() {
							CalculateVocabulary();
						}, 200); break;
				case "chart3":
				
				myChart3.style.display = "block";
				chart_hsk_vs_text.style.display="block";
				CreateGraph3(allArray); break;
				case "chart4":
				
				chart_global_words_vs_text.style.display="block";
				CreateGlobalWordChart(allArray);
				document.getElementById("global_table").style.display="block";
				break;
				case "chart5":
				predictions_text.style.display="block";
				document.getElementById("predictions_table").style.display="block";
				CreatePredictionsTable(allArray,knownArray,learningArray,unknownArray); break;
			}
}

function toggleSignIn() {
      if (firebase.auth().currentUser) {
        // [START signout]
		handleSignOut();
        //firebase.auth().signOut();
		ShowSigninElements(true);
        // [END signout]
      } else {
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        if (email.length < 4) {
          alert('Please enter an email address.');
          return;
        }
        if (password.length < 4) {
          alert('Please enter a password.');
          return;
        }
        // Sign in with email and pass.
        // [START authwithemail]
        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // [START_EXCLUDE]
          if (errorCode === 'auth/wrong-password') {
            alert('Wrong password.');
          } else {
            alert(errorMessage);
          }
          console.log(error);
          document.getElementById('quickstart-sign-in').disabled = false;
          // [END_EXCLUDE]
        });
        // [END authwithemail]
		ShowSigninElements(false);
      }
    }

    /**
     * Handles the sign up button press.
     */
    function handleSignUp() {
      var email = document.getElementById('email').value;
      var password = document.getElementById('password').value;
      if (email.length < 4) {
        alert('Please enter an email address.');
        return;
      }
      if (password.length < 4) {
        alert('Please enter a password.');
        return;
      }
      // Create user with email and pass.
      // [START createwithemail]
      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // [START_EXCLUDE]
        if (errorCode == 'auth/weak-password') {
          alert('The password is too weak.');
        } else {
          alert(errorMessage);
        }
        console.log(error);
        // [END_EXCLUDE]
      });
	  sendEmailVerification();
      // [END createwithemail]
    }

    /**
     * Sends an email verification to the user.
     */
    function sendEmailVerification() {
      // [START sendemailverification]
      firebase.auth().currentUser.sendEmailVerification().then(function() {
        // Email Verification sent!
        // [START_EXCLUDE]
        alert('Email Verification Sent!');
        // [END_EXCLUDE]
      });
      // [END sendemailverification]
    }

    function sendPasswordReset() {
      var email = document.getElementById('email').value;
      // [START sendpasswordemail]
      firebase.auth().sendPasswordResetEmail(email).then(function() {
        // Password Reset Email Sent!
        // [START_EXCLUDE]
        alert('Password Reset Email Sent!');
        // [END_EXCLUDE]
      }).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // [START_EXCLUDE]
        if (errorCode == 'auth/invalid-email') {
          alert(errorMessage);
        } else if (errorCode == 'auth/user-not-found') {
          alert(errorMessage);
        }
        console.log(error);
        // [END_EXCLUDE]
      });
      // [END sendpasswordemail];
    }
	
			 // [START googlecallback]
    function onSignIn(googleUser) {
		var provider = new firebase.auth.GoogleAuthProvider();
		firebase.auth()
		  .signInWithPopup(provider)
		  .then((result) => {
			/** @type {firebase.auth.OAuthCredential} */
			var credential = result.credential;

			// This gives you a Google Access Token. You can use it to access the Google API.
			var token = credential.accessToken;
			// The signed-in user info.
			var user = result.user;
			// IdP data available in result.additionalUserInfo.profile.
			  // ...
			  
			  ShowSigninElements(false);
		  }).catch((error) => {
			// Handle Errors here.
			var errorCode = error.code;
			var errorMessage = error.message;
			// The email of the user's account used.
			var email = error.email;
			// The firebase.auth.AuthCredential type that was used.
			var credential = error.credential;
			// ...
		  });
    }
    // [END googlecallback]

    /**
     * Check that the given Google user is equals to the given Firebase user.
     */
    // [START checksameuser]
    function isUserEqual(googleUser, firebaseUser) {
      if (firebaseUser) {
        var providerData = firebaseUser.providerData;
        for (var i = 0; i < providerData.length; i++) {
          if (providerData[i].providerId === firebase.auth.GoogleAuthProvider.PROVIDER_ID &&
              providerData[i].uid === googleUser.getBasicProfile().getId()) {
            // We don't need to reauth the Firebase connection.
            return true;
          }
        }
      }
      return false;
    }
    // [END checksameuser]

    /**
     * Handle the sign out button press.
     */
function handleSignOut() {
	firebase.auth().signOut().then(() => {
	  // Sign-out successful.
	  ShowSigninElements(true);
	}).catch((error) => {
	  // An error happened.
	});
}

function CalculateVocabularyAndCreateDocument(collection,_type,lang,uid,docid)
{			
			if(_type=="unknown")
			{
				if(unknownFireDBDocumentSaved)
				{
					return;
				}
			}
			
			if(_type=="learning")
			{
				if(learningFireDBDocumentSaved)
				{
					return;
				}
			}
			
			if(_type=="known")
			{
				if(knownFireDBDocumentSaved)
				{
					return;
				}
			}
			
			var arrLearning = [];
			var arrKnown = [];
			var arrUnknown = [];
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						var a = req[i].appearances;
						
						if(!w.includes("$"))
						{
							var remainder = a%3;
							
							if(remainder==0)
								{
								arrUnknown.push(w);
							}
							else if(remainder==1)
								{
								arrLearning.push(w);
							}
							else if(remainder==2)
							{
								arrKnown.push(w);
							}
						}
				  }
			  }
			  
				if(docid=="false")
				{
					switch(_type)
					{
						case "unknown":CreateDocument(collection,_type,lang,uid,arrUnknown); unknownFireDBDocumentSaved=true; break;
						case "learning":CreateDocument(collection,_type,lang,uid,arrLearning); learningFireDBDocumentSaved=true; break;
						case "known":CreateDocument(collection,_type,lang,uid,arrKnown); knownFireDBDocumentSaved=true; break;
					}
				}
				else
				{	switch(_type)
					{
						case "unknown":UpdateDocument(collection,_type,lang,uid,arrUnknown,docid);unknownFireDBDocumentSaved=true; break;
						case "learning":UpdateDocument(collection,_type,lang,uid,arrLearning,docid);learningFireDBDocumentSaved=true; break;
						case "known":UpdateDocument(collection,_type,lang,uid,arrKnown,docid);knownFireDBDocumentSaved=true; break;
					}
				}
			  };
}

function UpdateDocument(collection,_type,lang,uid,w,docid)
{
	dbfire.collection(collection).doc(docid).update({
		words: w
	})
	.then(function() {
		console.log("Document "+_type+" Updated!");
	})
	.catch(function(error) {
		console.error("Error updating document: ", error);
	});
}

function LogUser(user)
{
	dbfire.collection("users").doc(user.uid).set({
		name: user.displayName,
		email: user.email,
		verified: user.emailVerified,
		author_uid: user.uid
	})
	.then(function() {
		console.log("User logged in");
	})
	.catch(function(error) {
		console.error("Error writing document: ", error);
	});
}


function CreateDocument(collection,_type,lang,uid,w)
{
	dbfire.collection(collection).add({
		words: w,
		language: lang,
		type: _type,
		author_uid: uid
	}, { merge: true })
	.then(function() {
		console.log("Document "+_type+ " written!");
	})
	.catch(function(error) {
		console.error("Error writing document: ", error);
	});
		switch(_type)
		{
			case "unknown": unknownFireDBDocumentLoaded=true; break;
			case "learning": learningFireDBDocumentLoaded=true; break;
			case "known": knownFireDBDocumentLoaded=true; break;
		} 
}

			function InitialiseFireDB()
		{
			dbfire = firebase.firestore();
			//document.getElementById('signout').addEventListener('click', handleSignOut, false);
			// Listening for auth state changes.
		  // [START authstatelistener]
		  firebase.auth().onAuthStateChanged(function(user) {
				// [START_EXCLUDE silent]
				// [END_EXCLUDE]
				if (user) {
				  // User is signed in.
				  var displayName = user.displayName;	
				  var email = user.email;
				  var emailVerified = user.emailVerified;
				  var photoURL = user.photoURL;
				  var isAnonymous = user.isAnonymous;
				  var uid = user.uid;
				  var providerData = user.providerData;
				  // [START_EXCLUDE]
				  document.getElementById('quickstart-sign-in-status').textContent = 'Signed in';
				  document.getElementById('quickstart-sign-in').textContent = 'Sign out';
				  //document.getElementById('signout').disabled = false;
				  //document.getElementById('quickstart-account-details').textContent = JSON.stringify(user, null, '  ');
				//  if (!emailVerified) {
				//    document.getElementById('quickstart-verify-email').disabled = false;
			   //   }
				  // [END_EXCLUDE]
				  
				  LoadAccountData();
				  
				} else {
				  // User is signed out.
				  // [START_EXCLUDE]
				  
				  learningFireDBDocumentLoaded=false;
				  knownFireDBDocumentLoaded=false;
				  unknownFireDBDocumentLoaded=false;
				  unknownFireDBDocumentSaved=false;
				  knownFireDBDocumentSaved=false;
				  learningFireDBDocumentSaved=false;
				  
				  document.getElementById('quickstart-sign-in-status').textContent = 'Signed out';
				  document.getElementById('quickstart-sign-in').textContent = 'Sign in';
				  //document.getElementById('signout').disabled = true;
				  //document.getElementById('quickstart-account-details').textContent = 'null';
				  // [END_EXCLUDE]
				}
				// [START_EXCLUDE silent]
				document.getElementById('quickstart-sign-in').disabled = false;
				// [END_EXCLUDE]
			  });
			  // [END authstatelistener]

			  document.getElementById('quickstart-sign-in').addEventListener('click', toggleSignIn, false);
			  document.getElementById('quickstart-sign-up').addEventListener('click', handleSignUp, false);
			 // document.getElementById('quickstart-verify-email').addEventListener('click', sendEmailVerification, false);
			  document.getElementById('quickstart-password-reset').addEventListener('click', sendPasswordReset, false);
		}

function ImportVocabularyFromFireDB(words,s)
{
	if(s=="unknown")
	{
		if(unknownFireDBDocumentLoaded)
		{
			return;
		}
	}
	
	if(s=="learning")
	{
		if(learningFireDBDocumentLoaded)
		{
			return;
		}
	}
	
	if(s=="known")
	{
		if(knownFireDBDocumentLoaded)
		{
			return;
		}
	}

	console.log("Importing vocab from DB "+s);

	if(words.length>0)
	{
		var state = 0;
		switch(s)
		{
			case "unknown": state = 0;break;
			case "learning": state = 1;break;
			case "known": state = 2; break;
		}
		
				switch(s)
		{
			case "unknown": unknownFireDBDocumentLoaded=true; break;
			case "learning": learningFireDBDocumentLoaded=true; break;
			case "known": knownFireDBDocumentLoaded=true; break;
		}
		
		QuickImport(words,state);

		//if(unknownFireDBDocumentLoaded&&learningFireDBDocumentLoaded&&knownFireDBDocumentLoaded)
		//{
		//	OnInput();
		//}
	}
	
		switch(s)
		{
			case "unknown": unknownFireDBDocumentLoaded=true; break;
			case "learning": learningFireDBDocumentLoaded=true; break;
			case "known": knownFireDBDocumentLoaded=true; break;
		}
}

function SaveFireDB()
{
	if(unknownFireDBDocumentLoaded==false||learningFireDBDocumentLoaded==false||knownFireDBDocumentLoaded==false)
	{
		return;
	}
	
	unknownFireDBDocumentSaved=false;
	knownFireDBDocumentSaved=false;
	learningFireDBDocumentSaved=false;
	
	var user = firebase.auth().currentUser;
	var lang = "chinese";
	if(user)
	{
		console.log("Saving fireDB");
		dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "known").where("language", "==", lang)
	.get()
	.then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
            //console.log(doc.id, " => ", doc.data());
			//console.log(doc.id, " => ", doc.data().words);
			CalculateVocabularyAndCreateDocument("vocabulary","known",lang,user.uid,doc.id);
        });
		if(querySnapshot.empty)
		{
			CalculateVocabularyAndCreateDocument("vocabulary","known",lang,user.uid,"false");
		}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
		
		
			dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "learning").where("language", "==", lang)
		.get()
		.then(function(querySnapshot) {
			querySnapshot.forEach(function(doc) {
				//console.log(doc.id, " => ", doc.data());
				//console.log(doc.id, " => ", doc.data().words);
				CalculateVocabularyAndCreateDocument("vocabulary","learning",lang,user.uid,doc.id);
			});
			if(querySnapshot.empty)
			{
				CalculateVocabularyAndCreateDocument("vocabulary","learning",lang,user.uid,"false");
			}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
		
		
				dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "unknown").where("language", "==", lang)
		.get()
		.then(function(querySnapshot) {
			querySnapshot.forEach(function(doc) {
				//console.log(doc.id, " => ", doc.data());
				//console.log(doc.id, " => ", doc.data().words);
				CalculateVocabularyAndCreateDocument("vocabulary","unknown",lang,user.uid,doc.id);
			});
			if(querySnapshot.empty)
			{
				CalculateVocabularyAndCreateDocument("vocabulary","unknown",lang,user.uid,"false");
			}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
	}
}

function LoadAccountData(uid)
{
	var user = firebase.auth().currentUser;
	var lang = "chinese";
	
	if(user)
	{
		LogUser(user);
	
		ShowSigninElements(false);
		dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "known").where("language", "==", lang)
		.get()
		.then(function(querySnapshot) {
			querySnapshot.forEach(function(doc) {
				//console.log(doc.id, " => ", doc.data());
				//console.log(doc.id, " => ", doc.data().words);
				ImportVocabularyFromFireDB(doc.data().words,"known");
			});
			if(querySnapshot.empty)
			{
				CalculateVocabularyAndCreateDocument("vocabulary","known",lang,user.uid,"false");
			}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
		
		
			dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "learning").where("language", "==", lang)
		.get()
		.then(function(querySnapshot) {
			querySnapshot.forEach(function(doc) {
				//console.log(doc.id, " => ", doc.data());
				//console.log(doc.id, " => ", doc.data().words);
				ImportVocabularyFromFireDB(doc.data().words,"learning");
			});
			if(querySnapshot.empty)
			{
				CalculateVocabularyAndCreateDocument("vocabulary","learning",lang,user.uid,"false");
			}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
		
		
				dbfire.collection("vocabulary").where("author_uid", "==", user.uid).where("type", "==", "unknown").where("language", "==", lang)
		.get()
		.then(function(querySnapshot) {
			querySnapshot.forEach(function(doc) {
				//console.log(doc.id, " => ", doc.data());
				//console.log(doc.id, " => ", doc.data().words);
				ImportVocabularyFromFireDB(doc.data().words,"unknown");
			});
			if(querySnapshot.empty)
			{
				CalculateVocabularyAndCreateDocument("vocabulary","unknown",lang,user.uid,"false");
			}
		})
		.catch(function(error) {
			console.log("Error getting documents: ", error);
		});
	}
}

function ShowSigninElements(show)
{
	if(show)
	{
				document.getElementById("email").style.display = 'block';
		document.getElementById("password").style.display = 'block';
		document.getElementById("quickstart-sign-up").style.display = 'block';
		document.getElementById("quickstart-password-reset").style.display = 'block';
		document.getElementById("fireSigninText").style.display = 'block';
		document.getElementById("googleSignin").style.display = 'block';
		document.getElementById("googleSigninText").style.display = 'block';
		
				document.getElementById("LoginTabButton").innerHTML='<b>Login</b>';
	}
	else
	{
		document.getElementById("email").style.display = 'none'; 
		document.getElementById("password").style.display = 'none'; 
		document.getElementById("quickstart-sign-up").style.display = 'none'; 
		document.getElementById("quickstart-password-reset").style.display = 'none'; 
		document.getElementById("fireSigninText").style.display = 'none'; 
		document.getElementById("googleSignin").style.display = 'none'; 
		document.getElementById("googleSigninText").style.display = 'none';
		document.getElementById("LoginTabButton").innerHTML='<b>Logged-in</b>';

	}
}

function QuickImport(words,state)
{
	var arrLearning = [];
			var arrKnown = [];
			var arrUnknown = [];
			var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.getAll();
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {  
	          if(request.result) {
			  		var req = request.result;
					for(var i=0;i<req.length;i++)
					{
						var w = req[i].word;
						var a = req[i].appearances;
						
						if(!w.includes("$"))
						{
							var remainder = a%3;
							
							if(remainder==0)
								{
								arrUnknown.push(w);
								
						
							}
							else if(remainder==1)
								{
								arrLearning.push(w);

							}
							else if(remainder==2)
							{
								arrKnown.push(w);
	
							}
						}
				  }
			  }
	
				var arr;
				switch(state)
				{
					case 0:  arr=arrUnknown; break;
					case 1:  arr=arrLearning; break;
					case 2:  arr=arrKnown; break;
					default: console.log("state out of range");
				}
				for(var j=0;j<words.length;j++)
					{
						if(!arr.includes(words[j]))
						{
							UpdateOrAddDBRow(words[j],state);
						}
							
					}
					
					if(unknownFireDBDocumentLoaded&&knownFireDBDocumentLoaded&&learningFireDBDocumentLoaded)
					{
						OnInput();
					}
			}
}

function OpenGoogleImages()
{
	window.open("https://www.google.com/search?q="+pendingLookup+"&sxsrf=ALeKk01CGhV9YShWwU3Knh1qjMdDQcYXHQ:1602295138342&source=lnms&tbm=isch&sa=X&ved=2ahUKEwiS_K7E9qjsAhXhlEsFHS36BooQ_AUoAXoECA8QAw&cshid=1602295160675088&biw=1920&bih=937");
}

function OpenBaiduImages()
{
	window.open("https://image.baidu.com/search/index?tn=baiduimage&ipn=r&ct=201326592&cl=2&lm=-1&st=-1&fm=index&fr=&hs=0&xthttps=111111&sf=1&fmq=&pv=&ic=0&nc=1&z=&se=1&showtab=0&fb=0&width=&height=&face=0&istype=2&ie=utf-8&word="+pendingLookup+"&oq="+pendingLookup+"&rsp=-1");
}

function OpenYahooImages()
{
	window.open("https://images.search.yahoo.com/search/images;_ylt=Awr9Fqy0F4FfPGgAKy6LuLkF;_ylc=X1MDOTYwNTc0ODMEX3IDMgRmcgMEZ3ByaWQDYk0xRDBROWVTVUtJNnhpTllYaHIwQQRuX3N1Z2cDMTAEb3JpZ2luA2ltYWdlcy5zZWFyY2gueWFob28uY29tBHBvcwMwBHBxc3RyAwRwcXN0cmwDBHFzdHJsAzcEcXVlcnkDcG9rZW1vbgR0X3N0bXADMTYwMjI5NTc0Mw--?fr2=sb-top-images.search&p="+pendingLookup+"&ei=UTF-8&iscqry=&fr=sfp");
}

function OpenGoogleTranslate()
{
	window.open("https://translate.google.com/#view=home&op=translate&sl=zh-CN&tl=en&text="+pendingLookup);
}

function CreateSentences()
{
	var t = $('#sentencesDataTable').DataTable();
	t.clear();
	var oldHTML = pasteArea.innerText;
	var replace = /[\n\.\!\?\ã€‚\ï¼Ÿ\ï¼\?]/g;
	var split = oldHTML.replace(replace,'<br>');
	var count=0;
	var c=0;
	var difficultyTotal=0;
	var wordsTotal=0;
	var sentenceUnknownWords = [];
	var sentenceLearningWords = [];
	var optionsPrimary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'primary'
					};
					
	var optionsSecondary = {
						"accuracy": {
							"value": "exactly",
							"limiters": limiters
						}, "className": 'secondary'
					};				
	
	split = split.split('<br>');
	for(var i=0;i<split.length;i++)
	{
		var wordsplit = split[i].replace(replaceCharacters," ");
		wordsplit=wordsplit.trim();
		if(wordsplit.length>0)
		{
			var wordsInSentence = 0;
			var difficulty = 0;
			wordsplit = wordsplit.split(' ');
			for(var j=0;j<wordsplit.length;j++)
			{
				wordsplit[j]=wordsplit[j].trim();
				if(wordsplit[j].length>0)
				{
					var found = knownArray.findIndex(w => w.word === wordsplit[j]);
					if(found == -1)
					{
						difficulty++;
					}
					
					wordsInSentence++;
				}
			}
			var ratio=(Math.round((difficulty/wordsInSentence)* 100)/100).toFixed(2);
			
			var text = split[i];
			
			if(hideKnownSentences && difficulty==0)
			{
				c++;
				difficultyTotal+=difficulty;
				wordsTotal+=wordsInSentence;
			}
			else
			{
				count++;
				c++;
				t.row.add( [
					count,text,wordsInSentence,difficulty,ratio
				] );
				
				
				difficultyTotal+=difficulty;
				wordsTotal+=wordsInSentence;
			}
		}
	}
	t.draw();
	
	var unknownLearningRatio = difficultyTotal/wordsTotal;
	var meanWords = Math.round((wordsTotal/c) * 100) / 100;
	var meanUnknownLearningWords = Math.round((meanWords*unknownLearningRatio) * 100) / 100;
	var meanKnownWords = Math.round((meanWords-meanUnknownLearningWords) * 100) / 100;
	var sentencePerUnknownLearningWord = Math.round((1/meanUnknownLearningWords) * 100) / 100;
	
	
	document.getElementById("unknownPerSentenceText").innerText="The mean sentence length in the current text is "+meanWords+" words. In the average sentence, there are "+meanUnknownLearningWords+" unknown/learning words and "+meanKnownWords+" known words. There is an average of 1 unknown/learning word every "+sentencePerUnknownLearningWord+" sentence(s).";
	
}

function toggleHideKnownSentences()
{
	if(document.getElementById("hideKnownSentences").checked)
			{
				hideKnownSentences=true;
			
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("hideKnownSentences$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "hideKnownSentences$",appearances: 1});
						HideKnownSentences();
					}
					else
					{
						addwordtodb("hideKnownSentences$",1);
						HideKnownSentences();
					}
					
				}
	
						
			}
			else
			{
				hideKnownSentences=false;
				
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("hideKnownSentences$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "hideKnownSentences$",appearances: 0});
						HideKnownSentences();
					}
					else
					{
						addwordtodb("hideKnownSentences$",0);
						HideKnownSentences();
					}
					
				}
				
			}
			
}

function InitialiseHideKnownSentences()
{
	var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get("hideKnownSentences$");
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {          
	          if(request.result) {
					var a = request.result.appearances;
					if(a==0)
					{
						hideKnownSentences=false;
						document.getElementById("hideKnownSentences").checked = false;
					}
					else
					{
						hideKnownSentences=true;
						document.getElementById("hideKnownSentences").checked = true;
					}
			}
					else
					{
						if(hideKnownSentences)
						{
							
							addwordtodb("hideKnownSentences$",1);
							document.getElementById("hideKnownSentences").checked = true;
						}
						else
						{
							
							addwordtodb("hideKnownSentences$",0);
							document.getElementById("hideKnownSentences").checked = false;
						}
						
					}
					
			};
		
}

function HideKnownSentences()
{
	CalculateStatistics();
}

function SavePageLocation(pageTop)
{
				var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
				var request = objectStore.get("pageLocation$");
				request.onerror = function(event) {
				  alert("Unable to retrieve data from database!");
				};
				request.onsuccess = function(event) {          
					if(request.result) {
						request = db.transaction(["wordsdb"], "readwrite").objectStore("wordsdb").put({ word: "pageLocation$",appearances: pageTop});
					}
					else
					{
						addwordtodb("pageLocation$",pageTop);
					}
					
				}
}

function JumpToSavedPageLocation()
{
	var objectStore = db.transaction(["wordsdb"]).objectStore("wordsdb");
	        var request = objectStore.get("pageLocation$");
	        request.onerror = function(event) {
	          alert("Unable to retrieve data from database!");
	        };
	        request.onsuccess = function(event) {
						
				if(request.result)
				{
					var a = request.result.appearances;	
						setTimeout(function() {
							scrollTo({
								top: a,
								behavior: 'auto'
							});
						}, 500);
					
				}		
			};
}

function PopulateGrammarTab()
{	
	var tt = $('#grammarDataTable1').DataTable();
	tt.clear();
	GrammarLookup(pendingLookup);
	
	
	var t = $('#grammarDataTable2').DataTable();
	t.clear();
	for(var i=0;i<grammarPoints.length;i++)
	{	
		t.row.add( [
			grammarPoints[i].num,grammarPoints[i].point,grammarPoints[i].des
		] );
	}
	tt.draw();
	t.draw();
}

function OpenWikipedia()
{
	window.open("https://zh.wikipedia.org/wiki/"+pendingLookup);
}

function OpenEtymology()
{
	window.open("https://hanziyuan.net/#"+pendingLookup);
}

function SetGrammarPoints()
{
	var numGrammar=41;
	
	for(var i=0;i<numGrammar;i++)
	{
		var n=[];
		n.num = i+1;
		var rx = [];
		
		switch(i)
		{
			
			case 0:
				rx.push(/è¶Šæ¥è¶Š/);
				n.point = "è¶Šæ¥è¶Š";
				n.des="'More and more...'";
			break;
			case 1:
				rx.push(/(?<!è¶Šæ¥)è¶Š(?!æ¥è¶Š)/);
				n.point = "è¶Š + V/A + è¶Š + V/A";
				n.des="'The more A, the more B'";
			break;
			case 2:
				rx.push(/åˆ/);
				n.point = "åˆ + [Adjective A] + åˆ + [Adjective B]";
				n.des="'Both [Adjective A] and [Adjective B]'";
			break;
			case 3:
				rx.push(/äº†/);
				n.point = "V/A + äº†";
				n.des="Indicates change of state over time";
			break;
			case 4:
				rx.push(/äº†/);
				n.point = "äº†";
				n.des="Past tense";
			break;
			case 5:
				rx.push(/ä¸(?!å¿…)/);
				n.point = "ä¸";
				n.des="Negation of certain words. Can be used for the past/future tenses when combined with a time word or word such as ä¼š/å°†";
			break;
			case 6:
				rx.push(/æ²¡/);
				n.point = "æ²¡(æœ‰)"; 
				n.des="Present tense negation of æœ‰. Used in the past tense to negate certain words";
			break;
			case 7:
				rx.push(/è¿‡/);
				n.point = "V + è¿‡";
				n.des="Indicates the past completion of an action";
			break;
			case 8:
				rx.push(/å—/);
				n.point = "å—";
				n.des="Sentence ending particle for yes/no questions";
			break;
			case 9:
				rx.push(/å‘¢/);
				n.point = "å‘¢";
				n.des="Sentence ending particle to add emphasis or to ask a follow-up question";
			break;
			case 10:
				rx.push(/å‘€/);
				n.point = "å‘€";
				n.des="Sentence ending particle to express exclamation";
			break;
			case 11:
				rx.push(/å•Š/);
				n.point = "å•Š";
				n.des="Sentence ending particle to express exclamation";
			break;
			case 12:
				rx.push(/å§/);
				n.point = "å§";
				n.des="Sentence ending particle to give a suggestion, express uncertainty, or to soften the tone of a sentence";
			break;
			case 13:
				rx.push(/å“‡/);
				n.point = "å“‡";
				n.des="Sentence ending particle to express exclamation";
			break;
			case 14:
				rx.push(/å•¦/);
				n.point = "å•¦";
				n.des="Sentence ending particle to express exclamation, shortened form of äº†å•Š";
			break;
			case 15:
				rx.push(/å•Š/);
				n.point = "N + å•Š, N + å•Š,...";
				n.des="Used when listing nouns of the same category, e.g. æ¤…å­å•Šï¼Œæ¡Œå­å•Šï¼Œç”µè„‘å•Šï¼Œéƒ½ä¹°å¥½äº†";
			break;
			case 16:
				rx.push(/å“¦/);
				rx.push(/å™¢/);
				rx.push(/å–”/);
				n.point = "å“¦/å™¢/å–”";
				n.des="Sentence ending particle to soften the tone of a sentence";
			break;
			case 17:
				rx.push(/å˜›/);
				n.point = "å˜›";
				n.des="Sentence ending particle for something that the speaker thought was obvious, or for asking a close friend for a favor or request";
			break;
			case 18:
				rx.push(/å•°/);
				rx.push(/å–½/);
				n.point = "å•°/å–½";
				n.des="Sentence ending particle to soften the tone of a sentence, shortened form of äº†å“¦";
			break;
			case 19:
				rx.push(/å“‡/);
				n.point = "å“‡";
				n.des="Expresses surprise";
			break;
			case 20:
				rx.push(/å†ä¹Ÿ/);
				n.point = "å†ä¹Ÿ + negative sentence";
				n.des="(Not) any more";
			break;
			case 21:
				rx.push(/å‘—/);
				n.point = "å‘—";
				n.des="Sentence ending particle to express a lack of enthusiasm";
			break;
			case 22:
				rx.push(/æ¨ä¸å¾—/);
				n.point = "æ¨ä¸å¾—";
				n.des="To hate to be unable to do sth, i.e. to really want to do sth";
			break;
			case 23:
				rx.push(/å‘/);
				n.point = "å‘";
				n.des="'Hmm...', the sound somebody makes when they are thinking. Also used as a sentence ending particle to express an exclamation";
			break;
			case 24:
				rx.push(/è¯¶/);
				n.point = "è¯¶";
				n.des="The pronounciation changes depending on the meaning. Ä“i: to call sb, Ã©i: to express surprise, Ä›i: to express disagreement, Ã¨i: to express agreement, xÄ«: to express regret";
			break;
			case 25:
				rx.push(/å”·/);
				n.point = "å”·";
				n.des="Sentence ending particle expressing exhortation, admiration, or surprise";
			break;
			case 26:
				rx.push(/åˆ™/);
				n.point = "åˆ™";
				n.des="Expresses contrast, e.g. ç°åœ¨åˆ™æ˜¯è§‰å¾—åœ°æ¿åœ¨æ™ƒåŠ¨ Now I feel the floor is shaking (compared to before when the floor was still; 'then')";
			break;
			case 26:
				rx.push(/äºæ˜¯/);
				n.point = "[Phrase A] + äºæ˜¯ + [Phrase B]";
				n.des="Used to express a continuation between two events. The second event is the direct result of the first event.";
			break;
			case 27:
				rx.push(/ä»¥è‡³äº/);
				n.point = "[Phrase A] +  ä»¥è‡³äº + [Phrase B]";
				n.des="'To the extend that', 'as far as', e.g. æˆ‘ä»¬å¤ªæƒ³è¦ä¸€ä¸ªå¥³å„¿äº†ä»¥è‡³äºæ²¡æœ‰å…³æ³¨åˆ°å·²æœ‰çš„å­©å­ (We wanted a daughter to the extent that we didn't pay attention to our existing child).";
			break;
			case 28:
				rx.push(/æ—¢/);
				n.point = "æ—¢ + A/V + åˆ/ä¹Ÿ + A/V";
				n.des="Express that something is both A and B.";
			break;
			case 29:
				rx.push(/ä»¥åŠ/);
				n.point = "[Phrase A], + [Phrase B] + ä»¥åŠ + [Phrase C]";
				n.des="'As well as', used to connect the last item in a list.";
			break;
			case 30:
				rx.push(/äº¦/);
				n.point = "äº¦";
				n.des="'Also', same meaning as ä¹Ÿ but more formal.";
			break;
			case 31:
				rx.push(/ä¸/);
				n.point = "N + ä¸ + N";
				n.des="'And'/'with', same meaning as å’Œ/è·Ÿ but more formal.";
			break;
			case 32:
				rx.push(/åŠ/);
				n.point = "N + åŠ + N";
				n.des="'And', same meaning as å’Œ but more formal.";
			break;
			case 33:
				rx.push(/é/);
				n.point = "éå¾— / é";
				n.des="'Must', e.g. ä»–éè¦å» (He must go). Sometimes paired with ä¸å¯/ä¸è¡Œ/ä¸æˆ, which expresses something is supposed to be a certain way and not change, or that something will certainly happen.";
			break;
			case 34:
				rx.push(/ä¸æˆ/);
				n.point = "ä¸æˆ";
				n.des="'Won't do', 'unable to', 'can that be?' (at the end of a rhetorical question).";
			break;
			case 35:
				rx.push(/å³ä¾¿/);
				n.point = "å³ä¾¿...(ä¹Ÿ/è¿˜æ˜¯)...";
				n.des="'Even if...', same as è™½ç„¶...(ä¹Ÿ/è¿˜æ˜¯)... but used for hypothetical clauses.";
			break;
			case 36:
				rx.push(/è™½ç„¶/);
				n.point = "è™½ç„¶...(ä¹Ÿ/è¿˜æ˜¯)...";
				n.des="'Even if...still...', same as å³ä¾¿...(ä¹Ÿ/è¿˜æ˜¯)... but used for non-hypothetical clauses.";
			break;
			case 37:
				rx.push(/æ—¢ç„¶/);
				n.point = "æ—¢ç„¶...(é‚£/å°±/é‚£å°±/ä¸ºä»€ä¹ˆ)...";
				n.des="'Since'.";
			break;
			case 38:
				rx.push(/å’¦/);
				n.point = "å’¦";
				n.des="Expresses surprise.";
			break;
			case 39:
				rx.push(/ä¾¿/);
				n.point = "ä¾¿";
				n.des="'Then/and', e.g. å¯¹æ–¹è¿å¥¹çš„è¡¨æ¼”éƒ½ä¸çœ‹ä¾¿æ‹’ç»äº† (The other party turned her down without even seeing her performance).";
			break;
			case 40:
				rx.push(/ä¸ä»…/);
				n.point = "ä¸ä»…...åè€Œ/è¿˜/è€Œä¸”...";
				n.des="'Not only... but/instead...'";
			break;
				default: console.log("index out of bounds");
			
		}
		n.regex=rx;
		grammarPoints.push(n);
	}
}

function GrammarLookup(word)
{
	//TODO also check the hangul for certain words that often give false positives, e.g. -ì—

	if(openedTab!="GrammarTab")
	{
		return;
	}
	var w = word.replace(replaceCharacters,"");
	w =w.replace(" ","");
	w=w.trim();
	w=$.t2s(w);
	
	var tt = $('#grammarDataTable1').DataTable();
	tt.clear();
	
	
	for(var i=0;i<grammarPoints.length;i++)
	{	for(var j=0;j<grammarPoints[i].regex.length;j++)
		{
			
			var regex = RegExp(grammarPoints[i].regex[j]);
			var result = regex.test(word);
			
			if(result)
			{
				tt.row.add( [
					grammarPoints[i].num,grammarPoints[i].point,grammarPoints[i].des
				] );
				break;
			}
		}
	}
	tt.draw();
	
}

function toggleEnableWriting()
{

		if(enableWriting == false)
		{
			enableWriting = true;
			ExecuteEnableWriting();
		}
}

function ExecuteEnableWriting()
{
	if(enableWriting)
	{
		all_marked=true;
		unmark();
		ClearStatistics();
		OnInput();
	}
	else
	{
		all_marked=false;
		OnInput();
	}
}

function SetUILanguage(lang) //TODO
{

}

window.handleCredentialResponse = (response) => {
  onSignIn();
  
}


</script>
</head>

<body onload="BrowserCheck()" id="body" onscroll="onScroll()">
	 
	<div id="g_id_onload"
         data-client_id="641910980147-rulgj2ijv8pmhagni4v7v64clq0nndml.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
	 
	 
	<div class="wrapper">
		<div class="box content" id="content">
			<div class="editCell " contentEditable="false" data-text="Paste text here" id="pasteArea" type="text" oninput="OnInput()">
			</div>


			</div>
		
		
		<div class="box sidebar2 topright" id="sidebar2">
			<div class="wrapper3">
				<div class="tab">
					<div class="tab2">
						<button id="UnknownWordsTabButton" class="tablinks" onclick="openTab(event, 'UnknownWordsTab','tablinks')">Unknown Words <sup>[4]</sup></button>
						<button id="LearningWordsTabButton" class="tablinks"  onclick="openTab(event, 'LearningWordsTab','tablinks')">Learning Words <sup>[5]</sup></button>
						<button id="KnownWordsTabButton" class="tablinks"  onclick="openTab(event, 'KnownWordsTab','tablinks')">Known Words <sup>[6]</sup></button>
						<button id="AllWordsTabButton" class="tablinks"  onclick="openTab(event, 'AllWordsTab','tablinks')">All Words <sup>[7]</sup></button>
						<button id="VocabularyTabButton" class="tablinks"  onclick="openTab(event, 'VocabularyTab','tablinks')">Vocabulary <sup>[8]</sup></button>
					</div>
					<div class="tab3">
						<button id="CompareTabButton" class="tablinks"onclick="openTab(event, 'CompareTab','tablinks')">HSK <sup>[9]</sup></button>
						<button id="GraphTabButton" class="tablinks" onclick="openTab(event, 'GraphTab','tablinks')">Analysis <sup>[0]</sup></button>
						<button id="AchievementsTabButton" class="tablinks" onclick="openTab(event, 'AchievementsTab','tablinks')">Achievements <sup>[-]</sup></button>
						<button id="SentencesTabButton" class="tablinks" onclick="openTab(event, 'SentencesTab','tablinks')">Sentences <sup>[s]</sup></button>
						<button id="CharactersTabButton" class="tablinks" onclick="openTab(event, 'CharactersTab','tablinks')">Characters <sup>[k]</sup></button>
					</div>
				</div>
				<div class="tabContainer">
				<div id="LoadingTab" class="tabcontent">
						<div id="LoadingText">Loading data, please wait...</div>
					</div>
					
				<div id="GrammarTab" class="tabcontent">
						<h2>Grammar</h2>
						<small>
						Highlight some text, and detected grammar points will appear below.
						</small>
						<br><br>
						<table id="grammarDataTable1" class="cell-border compact hover" width="100%"></table>
						<br><br>
						<small>Full list:</small><br><br>
						<table id="grammarDataTable2" class="cell-border compact" width="100%"></table>
						<br><br>
						<hr>
						<br>
						<small>
						Note: the results include some false positives, so please use your own discretion.
						</small>
						<br><br>
						<small>
						The list of grammar rules has been collected from various sources.
						The list is frequently updated. If you find a grammar rule that is missing, please send an email to <a href="mailto:readerwebsite@gmail.com?subject=Feedback%20for%20Korean%20Reader">readerwebsite@gmail.com</a>
						</small>
						<br><br>
						
					</div>					
					
				<div id="LanguageTab" class="tabcontent">
					<h2>Language Settings</h2><hr><br>
					<form>User Interface Language:
							<select id="uiLanguageOption" onchange="ChangeUILanguage();">
								<option selected="selected">English</option>
							</select>	
						</form>
					<br><br>
					
						<form>Dictionary Language:
							<select id="dictLanguageOption" onchange="ChangeDictLanguage();">
								<option>MDBG English</option>
								<option>Naver Korean/English</option>
								<option selected="selected">Youdao English</option>
								<option>Youdao Japanese</option>
								<option>Youdao Korean</option>
								<option>Youdao French</option>
								<option>Baike Chinese-Chinese</option>
							</select>	
						</form>
						<br><br>
						<form>Reader Language:
							<select id="readerLanguageOption" onchange="ChangeReaderLanguage();">
								<option>English</option>
								<option selected="selected">Chinese</option>
								<option>Korean</option>
								<option>Vietnamese</option>
								<option>Spanish</option>
							</select>	
						</form>
					<br>
					</div>
					<div id="DictionaryTab" class="tabcontent">
					<iframe id="naverIframe" src="https://www.youdao.com/"></iframe>
					<div id="dictionaryOptionsArea">
					<hr>
					<form>Dictionary Language:
								<select id="dictLanguageOption2" onchange="ChangeDictLanguage2();">
									<option>MDBG English</option>
									<option>Naver Korean/English</option>
									<option selected="selected">Youdao English</option>
									<option>Youdao Japanese</option>
									<option>Youdao Korean</option>
									<option>Youdao French</option>
									<option>Baike Chinese-Chinese</option>
								</select>	
							</form>
							<br>
							
							<table>
						  <tr>
							<td><button id="googleTranslateLink" onclick="OpenGoogleTranslate();">Google Translate (shortcut: t)</button></td>
							<td><button id="googleImagesLink" onclick="OpenGoogleImages();">Google Images (shortcut: o)</button></td>
						  </tr>
						  <tr>
							<td><button id="baiduImagesLink" onclick="OpenBaiduImages();">Baidu Images (shortcut: b)</button></td>
							<td><button id="yahooImagesLink" onclick="OpenYahooImages();">Yahoo Images (shortcut: y)</button></td>
						  </tr>
						  <tr>
							<td><button id="wikipediaLink" onclick="OpenWikipedia();">Wikipedia (shortcut: w)</button></td>
							<td><button id="etymologyLink" onclick="OpenEtymology();">Etymology (shortcut: e)</button></td>
						  </tr>
						</table>
					</div>

						
					</div>
					<div id="ImagesTab" class="tabcontent">
					<iframe id="imagesIframe" src=""></iframe>
						
						
					</div>
					
					<div id="WritingTab" class="tabcontent">
						<h4>Writing in the main text area is now enabled.</h4>
					</div>
					
					<div id="StatisticsTab" class="tabcontent"></div>
					<div id="UnknownWordsTab" class="tabcontent">
						<h4>List of unknown words from the current text.</h4>
						<table id="unknownWordsDataTable" class="cell-border compact hover" width="100%"></table>
						<br>
						<table id="unknownWordsDataTableSummary" class="cell-border compact" width="100%"></table>
						
					</div>
					<div id="KnownWordsTab" class="tabcontent">
						<h4>List of known words from the current text.</h4>
						<table id="knownWordsDataTable" class="cell-border compact hover" width="100%"></table>
						<br>
						<table id="knownWordsDataTableSummary" class="cell-border compact" width="100%"></table>
						
					</div>
					<div id="LearningWordsTab" class="tabcontent">
						<h4>List of learning words from the current text.</h4>
						<table id="learningWordsDataTable" class="cell-border compact hover" width="100%"></table>
						<br>
						<table id="learningWordsDataTableSummary" class="cell-border compact" width="100%"></table>
					</div>
					<div id="AllWordsTab" class="tabcontent">
						<h4>List of all words from the current text.</h4>
						<table id="allWordsDataTable" class="cell-border compact hover" width="100%"></table>
						<br>
						<table id="allWordsDataTableSummary" class="cell-border compact" width="100%"></table>
					</div>
					<div id="VocabularyTab" class="tabcontent">
						<h4>A complete list of collected vocabulary items.</h4>
		<p>To delete entries, select rows then press DEL key.</p>
						<form>Filter:
							<select id="filterVocabularyOption" onchange="ChangeVocabularyFilter();">
								<option>Unknown</option>
								<option>Learning</option>
								<option selected="selected">Known</option>
								<option>All</option>
							</select>
						</form>
						<table id="vocabularyDataTable" class="cell-border compact hover" width="100%"></table>
						<br>
						<hr>
						<h4>Words</h4>
						<table id="vocabularyDataTableSummary" class="cell-border compact" width="100%"></table>
						<hr>
						<h4>Characters</h4>
						<table id="charactersVocabularyDataTableSummary" class="cell-border compact" width="100%"></table>
						<hr><br><br>
						<button id="deleteVocabularyCurrentTextButton" onclick="ButtonDeleteCurrentTextSubmit();">
						Clear Vocabulary - Current Text</button><br>Deletes all words that are present in the current text from vocabulary.<br><br>
						<button id="deleteVocabularyAllTextButton" onclick="ButtonDeleteAllSubmit();">Clear Vocabulary - All</button><br>Deletes all words from vocabulary.
						<br>
						
					</div>
					<div id="CompareTab" class="tabcontent">
						<h4>See how one's vocabulary compares with the official HSK 3.0 word list.</h4>
						<table id="compareDataTable" class="cell-border compact" width="100%"></table>
					</div>
					
					<div id="GraphTab" class="tabcontent">
						<canvas id="myChart" width="100%" height="100%"></canvas>
						<canvas id="myChart2" width="100%" height="100%"></canvas>
						<canvas id="myChart3" width="100%" height="100%"></canvas>
						<canvas id="chart_hsk_vs_text" width="100%" height="100%"></canvas>
						<canvas id="chart_global_words_vs_text" width="100%" height="100%"></canvas>
						<table id="global_table" class="cell-border compact hover" height="100%" width="100%"></table>
						<div id="predictions_text"></div>
						<table id="predictions_table" class="cell-border compact hover" height="100%" width="100%"></table>
						<br>
						<select id="chartOption" onchange="ChangeChart();">
								<option value="chart1" selected="selected">Cumulative words in current text vs known words</option>
								<option value="chart2">Cumulative characters in current text vs known characters</option>
								<option value="chart3">Cumulative words in current text vs HSK wordlist</option>
								<option value="chart4">Cumulative words in current text vs global frequency list</option>
								<option value="chart5">Predictions of vocabulary required to acheive milestones</option>
							</select>
					</div>
					
					<div id="AchievementsTab" class="tabcontent">
						<h4>List of vocabulary milestones.</h4><br>
						<div id="achievementsText">
						</div>
						<br>
						<table id="achievementsDataTable" class="cell-border compact" width="100%"></table>
						<br><br>
						<br>
						<button id="deleteAchievementsButton" onclick="ButtonDeleteAchievementsSubmit();">Clear Achievements</button><br><br>
					</div>
					
					<div id="SentencesTab" class="tabcontent">
						<h4>List of sentences.</h4>
						<input checked type="checkbox" id="hideKnownSentences" name="hideKnownSentences" checked onclick="toggleHideKnownSentences();">
						<label for="hideKnownSentences">Hide sentences that are fully known</label>
						<br><br>
						<div id="unknownPerSentenceText"></div>
						<br><br>
						<table id="sentencesDataTable" class="SentenceTable cell-border compact hover" width="100%"></table>
						<br>
						<small>n: number of words in the sentence.</small><br>
						<small>?: number of 'learning' or 'unknown' words in the sentence.</small><br>
						<small>%: the percentage of 'learning' or 'unknown' words in the sentence.</small><br>
					</div>
					
					<div id="CharactersTab" class="tabcontent">
						<h4>View one's collection of characters.</h4>
						<h4>Characters in Vocabulary</h4>
						<table id="charactersVocabularyDataTable" class="cell-border compact hover" width="100%"></table>
						<hr>
						<h4>Characters in Vocabulary Summary</h4>
						<table id="charactersVocabularyDataTableSummary2" class="cell-border compact" width="100%"></table>
						<hr>
						<h4>Characters in Current Text</h4>
						<table id="charactersCurrentTextDataTable" class="cell-border compact hover" width="100%"></table>
						<hr>
						<h4>Unique Characters in Current Text Summary</h4>
						<table id="charactersCurrentTextDataTableSummary" class="cell-border compact" width="100%"></table>
						<hr>
						<h4>All Characters in Current Text Summary</h4>
						<table id="charactersAllCurrentTextDataTableSummary" class="cell-border compact" width="100%"></table>
						<hr>
					</div>
					
					<div id="AboutTab" class="tabcontent">
					<h2>About</h2><hr>
					<h3>Usage Guide</h3>
						Paste a text in the text area. All new words start as <b>unknown</b> (unless you change this in settings). Click to mark them as <b>learning</b>, and again to mark them as <b>known</b>.<br><br>
						<h4>Suggested Interpretations:</h4>
						&nbsp&nbsp&nbsp <b id="unknownCircle">Unknown</b> words may be unknown, difficult, or not important to remember for the timebeing.<br><br>
						&nbsp&nbsp&nbsp <b id="learningCircle">Learning</b> words are words that feel fuzzy. The meaning can be guessed without confidence and perhaps needs to be confirmed with a dictionary lookup.<br><br>
						&nbsp&nbsp&nbsp <b id="knownCircle">Known</b> words are words where the meaning is known instantly and accurately.<br><br>
						<br>
						<br>
						<hr>
						<br>
						
						Data will be saved in the browser's local folder. Logging-in is recommended in order to save your accumulated vocabulary online.   
						<br>
						<br>
						Turn on "Voice" in settings if you would like to listen to text-to-speech.
						<br>
						<br>
						
						Report bugs or give suggestions here: <a href="mailto:readerwebsite@gmail.com?subject=Feedback%20for%20Chinese%20Reader">readerwebsite@gmail.com</a><br><br><br>
						
						If you would like to donate to help with the website hosting costs and to support the development of Chinese Reader, please click below:
						<br><br>
						<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
						<input type="hidden" name="cmd" value="_donations" />
						<input type="hidden" name="business" value="GAJYAPJCG8KLS" />
						<input type="hidden" name="item_name" value="Support the development of Chinese Reader" />
						<input type="hidden" name="currency_code" value="AUD" />
						<input type="image" src="https://www.paypalobjects.com/en_AU/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
						<img alt="" border="0" src="https://www.paypal.com/en_AU/i/scr/pixel.gif" width="1" height="1" />
						</form>
						<br>
						<hr>
						<br>
						<a href="https://koreanreader.com/privacy.html">Privacy policy</a>
						<br>
					</div>
					
					<div id="LoginTab" class="tabcontent">
						<br>
						Sign in to access your saved vocabulary from other computers.
						<br>

						<div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid" id="fireLoginArea">

							  <!-- Container for the demo -->
							  <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
								<div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
								  <h2 class="mdl-card__title-text">Login</h2>
								</div>
								<div class="mdl-card__supporting-text mdl-color-text--grey-600">
								  <p id="fireSigninText">Enter an email and password below and either sign in to an existing account or sign up</p>

								  <input class="mdl-textfield__input" style="display:inline;width:auto;" type="text" id="email" name="email" placeholder="Email"/>
								  &nbsp;&nbsp;&nbsp;
								  <input class="mdl-textfield__input" style="display:inline;width:auto;" type="password" id="password" name="password" placeholder="Password"/>
								  <br/><br/>
								  <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-in" name="signin">Sign In</button>
								  &nbsp;&nbsp;&nbsp;
								  <br><br><button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-up" name="signup">Sign Up</button>
								  <br><br>
								  &nbsp;&nbsp;&nbsp;
								  <button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-password-reset" name="verify-email">Send Password Reset Email</button>
									<br><br>      
								  <p id="googleSigninText">Sign in with your Google account below.</p>
								  <!-- [START google_button] -->
								  <div class="g_id_signin" id="googleSignin" data-onsuccess="onSignIn" data-type="standard" data-theme="dark"></div>
								  <!-- [END google_button] -->
								  <br>
								
								
								  <!-- Container where we'll display the user details -->
								  <div class="quickstart-user-details-container">
									Sign-in status: <span id="quickstart-sign-in-status">Unknown</span>
									<!--<div>Firebase auth <code>currentUser</code> object value:</div>
									<pre><code id="quickstart-account-details">null</code></pre>-->
								  </div>
								</div>
							  </div>

							</div>
						
						<br>				
						<br>
						<hr>
						<br>
						<a href="https://koreanreader.com/privacy.html">Privacy policy</a>
						<br>
					</div>
					
					<div id="ImportTab" class="tabcontent">
					<h2>Import</h2><hr>
					<br><br>
					Choose a wordlist to import, or paste words into the text box:
					
						<br><br>
						
						<input type="file" id="importWordlistButton">
						</input> &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <button id="clearImportButton" onclick="ClearImportSubmit();">Clear</button>
						<br><br>
							<textarea id="importTextArea" style="width: 100%; padding: 10px; height: 200px; 
							display: block; font-family:Sans-serif; font-size:1.2em;">
							</textarea><br><br>
						<form>
							Import to:
							<select id="filterImportOption" onchange="ChangeFilterImport();">
								<option>Unknown</option>
								<option>Learning</option>
								<option selected="selected">Known</option>
							</select>
						</form><br><br><button id="importButton" onclick="ButtonImportSubmit();">Import</button> &nbsp
						<br>
					</div>
					<div id="ExportTab" class="tabcontent">
					<h2>Export</h2><hr>
					<br><br>
					<form>Choose a wordlist:
							<select id="filterExportWordlistOption" onchange="ChangeFilterExportWordlist();">
								<option>Vocabulary - All</option>
								<option>Vocabulary - Unknown</option>
								<option selected="selected">Vocabulary - Learning</option>
								<option>Vocabulary - Known</option>
								<option>Current Text - All</option>
								<option>Current Text - Unknown</option>
								<option>Current Text - Learning</option>
								<option>Current Text - Known</option>
							</select>
						</form>
						<br>
						<button id="exportWordlistButton" onclick="ButtonExportWordlistSubmit();">Download</button>&nbsp
					</div>
					
					<div id="OptionsTab" class="tabcontent">
					<h2>Settings</h2><hr>
						<input type="checkbox" id="enableHighlighting" name="enableHighlighting" checked onclick="toggleEnableHighlighting();">
						<label for="enableColours">Enable Highlighting</label>
						<br><br>
						<input type="checkbox" id="enableHighlightingKnown" name="enableHighlightingKnown" checked onclick="ToggleEnableHighlightingKnown();">
						<label for="enableHighlightingKnown">Show Highlighting For Known Words</label>
						<br>
						<br>Unknown Words Highlight Colour:
						<input class="colourInputField" type="textField" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" id="fieldHC1" name="fieldHC1" oninput="HC1OnInput()" onkeydown="if (event.keyCode == 13) { HC1Submit(); return false;}">
						<button id="colorpicker1">Pick</button>
						<button id="HC1SubmitButton" onclick="HC1Submit();">Submit</button>
												<br>
						<br>Learning Words Highlight Colour:&nbsp
						<input class="colourInputField" type="textField" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$"  id="fieldHC2" name="fieldHC2" oninput="HC2OnInput()" onkeydown="if(event.keyCode == 13){ HC2Submit(); return false;}">
						<button id="colorpicker2">Pick</button>
						<button id="HC2SubmitButton" onclick="HC2Submit();">Submit</button>
						<br>
						<br>Known Words Highlight Colour:&nbsp&nbsp&nbsp&nbsp
						<input class="colourInputField" type="textField" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" id="fieldHC3" name="fieldHC3" oninput="HC3OnInput()" onkeydown="if (event.keyCode == 13) { HC3Submit(); return false;}">
						<button id="colorpicker3">Pick</button>
						<button id="HC3SubmitButton" onclick="HC3Submit();">Submit</button>
												<br>
						<br>Jump Highlight Colour:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
						<input class="colourInputField" type="textField" id="fieldHC4" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" name="fieldHC4" oninput="HC4OnInput()" onkeydown="if (event.keyCode == 13) { HC4Submit(); return false;}">
						<button id="colorpicker4">Pick</button>
						<button id="HC4SubmitButton" onclick="HC4Submit();">Submit</button>
						<br><br>
						
						<hr>
						<br>
						Background Colour:&nbsp&nbsp&nbsp&nbsp
						<input class="colourInputField" type="textField" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" id="fieldHC5" name="fieldHC5" oninput="HC5OnInput()" onkeydown="if (event.keyCode == 13) { HC5Submit(); return false;}">
						<button id="colorpicker5">Pick</button>
						<button id="HC5SubmitButton" onclick="HC5Submit();">Submit</button>
												<br>
						<br>Text Colour:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
						<input class="colourInputField" type="textField" id="fieldHC6" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" name="fieldHC6" oninput="HC6OnInput()" onkeydown="if (event.keyCode == 13) { HC6Submit(); return false;}">
						<button id="colorpicker6">Pick</button>
						<button id="HC6SubmitButton" onclick="HC6Submit();">Submit</button>
						<br>
						<br>Border Colour:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
						<input class="colourInputField" type="textField" id="fieldHC7" pattern="^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$" name="fieldHC7" oninput="HC7OnInput()" onkeydown="if (event.keyCode == 13) { HC7Submit(); return false;}">
						<button id="colorpicker7">Pick</button>
						<button id="HC7SubmitButton" onclick="HC7Submit();">Submit</button>
						<br>
						<br>
						<hr>
						
						
						<br>
						<form>Font Size:
							<select id="fontSizeOption" onchange="ChangeFont();">
								<option>0.5</option>
								<option>1</option>
								<option>1.5</option>
								<option>2</option>
								<option>2.5</option>
								<option>3</option>
								<option>3.5</option>
								<option>4</option>
								<option>4.5</option>
								<option>5</option>
								<option>5.5</option>
								<option selected="selected">6</option>
								<option>6.5</option>
								<option>7</option>
								<option>7.5</option>
								<option>8</option>
							</select>
						</form>
						<br>
						<form>Font:
							<select id="fontTypeOption" onchange="ChangeFontType();">
								
							</select>
						</form>
						<br>
						
						<!--
						<hr><br>Romanisation:
						<select id="romanisationOption" onchange="ChangeRomanisation();">
							<option selected="selected">Off</option>
							<option>On</option>
						</select>
						</form>&nbsp(For large texts this will take a while).
						<br><br>
						-->
						
						<hr>
						<br>
						
						<form>Character Conversion:
							<select id="characterConversionOption" onchange="ChangeCharacterConversion();">
								<option selected="selected">No conversion</option>
								<option>Convert simplified characters to traditional</option>
								<option>Convert traditional characters to simplified</option>
							</select>
						</form>
						<br>
						<hr>
						<br>
						<input type="checkbox" id="enableVoice" name="enableVoice" onclick="toggleEnableVoice();">
						<label for="enableVoice">Enable Voice</label>
						<br>
						<br>
						<form>Voice:
							<select id="voiceOption" onchange="ChangeVoice();"></select>&nbsp(Local and browser-specific TTS voices)</form>
						<br>
						<div class="wrapper2">
							<div>Volume:</div>
							<div id="volumeOutput">0</div>
							<div class="slidecontainer">
								<input type="range" min="0" max="10" value="10" class="slider" id="voiceVolumeSlider">
							</div>
						</div>
						<br>
						<div class="wrapper2">
							<div>Speed:</div>
							<div id="speedOutput">0</div>
							<div class="slidecontainer">
								<input type="range" min="1" max="20" value="10" class="slider" id="voiceSpeedSlider">
							</div>
						</div>
						<br>
						<div class="wrapper2">
							<div>Pitch:</div>
							<div id="pitchOutput">0</div>
							<div class="slidecontainer">
								<input type="range" min="0" max="20" value="10" class="slider" id="voicePitchSlider">
							</div>
						</div>
						<br>
						<br>
						<hr>
						<br>
						<form>All new words are initially marked: 
							<select id="startingMarkOption" onchange="ChangeStartingMark();">
								<option selected="selected">Unknown</option>
								<option>Learning</option>
								<option>Known</option>
							</select>
						</form> <br> Changes how words encountered for the first time will be initially marked. Words previously encountered will not be altered - to acheive this consider <b>clearing vocabulary</b>.
						<br><br>
						<hr>
						<br>
						<button id="deleteVocabularyCurrentTextButton" onclick="ButtonDeleteCurrentTextSubmit();">
						Clear Vocabulary - Current Text</button><br>Deletes all words that are present in the current text from vocabulary.<br><br>
						<button id="deleteVocabularyAllTextButton" onclick="ButtonDeleteAllSubmit();">Clear Vocabulary - All</button><br>Deletes all words from vocabulary.
						<br><br>
						<button id="deleteAchievementsButton" onclick="ButtonDeleteAchievementsSubmit();">Clear Achievements</button><br><br><br><br>
					</div>
				</div>
			</div>
		</div>
 <div class="topbar" id="topbar">
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" onclick="Reset(true)"><b>Clear <sup>[ESC]</sup></b></div>
		 <div class="empty"></div>
		 <div class="logo"><b>Chinese Reader</b></div>
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" id="DictionaryTabButton" onclick="openTab(event, 'DictionaryTab','toptabs')"><b>Dictionary <sup>[1]</sup></b></div>
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" id="WritingTabButton" onclick="openTab(event, 'WritingTab','toptabs');"><b>Writing <sup>[2]</sup></b></div>
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" id="StatisticsTabButton" onclick="openTab(event, 'StatisticsTab','toptabs')"><b>Statistics <sup>[3]</sup></b></div>
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" id="GrammarTabButton" onclick="openTab(event, 'GrammarTab','toptabs')"><b>Grammar <sup>[g]</sup></b></div>
		 <div class="empty"></div>
		 <div class="topbarbutton toptabs" id="LanguageTabButton" onclick="openTab(event, 'LanguageTab','toptabs')">
		 <img id="languageicon" src="icons/languageicon.png"></img>
		 </div>
		 <div class="empty"></div>
		 <div class="container" onclick="ToggleOpenMenu()">
			<div class="empty"></div>	
			<div class="bar"></div>
			<div class="empty"></div>
			<div class="bar"></div>
			<div class="empty"></div>
			<div class="bar"></div>
			<div class="empty"></div>
		 </div>
		 <div class="empty"></div>
		 
		<div class="menu" id="menu">
			<div class="topbarbutton2 toptabs" id="OptionsTabButton" onclick="openTab(event, 'OptionsTab','toptabs')"><b>Settings</b></div>
			<div class="empty"></div>
			<div class="topbarbutton2 toptabs" id="ImportTabButton" onclick="openTab(event, 'ImportTab','toptabs')"><b>Import</b></div>
			<div class="empty"></div>
			<div class="topbarbutton2 toptabs" id="ExportTabButton" onclick="openTab(event, 'ExportTab','toptabs')"><b>Export</b></div>
			<div class="empty"></div>
			<div class="topbarbutton2 toptabs" id="AboutTabButton" onclick="openTab(event, 'AboutTab','toptabs')"><b>About</b></div>
			<div class="empty"></div>
			<div class="topbarbutton2 toptabs" id="LoginTabButton" onclick="openTab(event, 'LoginTab','toptabs')"><b>Login</b></div>
			<div class="empty"></div>
		</div>
	 </div>
	 
	 	<script>
	  // Your web app's Firebase configuration
	  var firebaseConfig = {
		apiKey: "AIzaSyDOZA0ojbWAaeWwx0gL7kenlNm94Fo38BY",
		authDomain: "korean-reader.firebaseapp.com",
		databaseURL: "https://korean-reader.firebaseio.com",
		projectId: "korean-reader",
		storageBucket: "korean-reader.appspot.com",
		messagingSenderId: "410562108352",
		appId: "1:410562108352:web:f42d6c8b329d8e54460625"
	  };
	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	</script>
</body>


</html>
